<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Multi-Language Expense Splitter ğŸŒ</title>
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="åˆ†å¸³æœ¬">
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #F3F4F6;
            -webkit-tap-highlight-color: transparent;
        }

        body.modal-open {
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
        }

        .modal-enter {
            animation: modalUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .slide-in-left {
            animation: slideInLeft 0.3s ease-out;
        }

        @keyframes modalUp {
            from {
                transform: translateY(100%);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes slideInLeft {
            from {
                transform: translateX(-100%);
            }

            to {
                transform: translateX(0);
            }
        }

        .btn-press:active {
            transform: scale(0.95);
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Swipe to delete styles */
        .swipe-container {
            position: relative;
            overflow: hidden;
        }

        .swipe-content {
            transition: transform 0.3s ease;
        }

        .swipe-content.swiping {
            transition: none;
        }

        .swipe-delete-bg {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 100px;
            background: #EF4444;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            border-radius: 1rem;
        }

        /* Swipe to clear styles */
        .swipe-clear-bg {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 100px;
            background: #10B981;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            border-radius: 0.75rem;
        }

        .swipe-unclear-bg {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 100px;
            background: #F59E0B;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            border-radius: 0.75rem;
        }

        .swipe-unclear-bg-left {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 100px;
            background: #F59E0B;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            border-radius: 0.75rem;
        }

        .cleared-item {
            opacity: 0.7;
            background: linear-gradient(90deg, #D1FAE5 0%, #ECFDF5 100%) !important;
        }

        .cleared-badge {
            background: #10B981;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 6px;
        }

        /* Dark Mode Styles */
        .dark {
            background-color: #000000 !important;
            color: #F9FAFB !important;
        }

        .dark .bg-white {
            background-color: #1a1a1a !important;
        }

        .dark .bg-gray-50 {
            background-color: #2a2a2a !important;
        }

        .dark .bg-gray-100 {
            background-color: #1a1a1a !important;
        }

        .dark .bg-green-50 {
            background-color: #064e3b !important;
        }

        .dark .bg-red-50 {
            background-color: #7f1d1d !important;
        }

        .dark .bg-blue-50 {
            background-color: #1e3a5f !important;
        }

        .dark .bg-purple-50 {
            background-color: #4c1d95 !important;
        }

        .dark .bg-purple-100 {
            background-color: #6B21A8 !important;
        }

        .dark .text-purple-600 {
            color: #E9D5FF !important;
        }

        .dark .text-gray-800,
        .dark .text-gray-700,
        .dark .text-gray-600 {
            color: #F9FAFB !important;
        }

        .dark .text-gray-500,
        .dark .text-gray-400 {
            color: #9CA3AF !important;
        }

        .dark .text-black {
            color: #F9FAFB !important;
        }

        .dark .text-green-600,
        .dark .text-green-700 {
            color: #4ADE80 !important;
        }

        .dark .text-red-500,
        .dark .text-red-600 {
            color: #F87171 !important;
        }

        .dark .text-blue-600,
        .dark .text-blue-700 {
            color: #60A5FA !important;
        }

        .dark .text-orange-600 {
            color: #FB923C !important;
        }

        .dark .border-gray-200,
        .dark .border-gray-100 {
            border-color: #374151 !important;
        }

        .dark .border-black {
            border-color: #60A5FA !important;
        }

        .dark .shadow-sm {
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.5) !important;
        }

        .dark input,
        .dark select {
            background-color: #2a2a2a !important;
            color: #F9FAFB !important;
            border-color: #374151 !important;
        }

        .dark .font-bold {
            color: inherit;
        }

        .dark .slide-in-left {
            background-color: #1a1a1a !important;
        }

        .dark .border-t {
            border-color: #374151 !important;
        }

        .dark .hover\:bg-gray-100:hover {
            background-color: #374151 !important;
        }

        .dark .hover\:bg-gray-200:hover {
            background-color: #4B5563 !important;
        }

        .dark .border-2.border-black {
            border-color: #60A5FA !important;
        }

        .dark .border-2.border-gray-100 {
            border-color: #374151 !important;
        }

        .dark .border-transparent {
            border-color: transparent !important;
        }

        .dark span {
            color: inherit;
        }

        .dark button span {
            color: inherit;
        }

        .dark .rounded-xl span {
            color: inherit;
        }

        .dark .p-3 span:not(.text-2xl):not(.text-3xl) {
            color: #F9FAFB;
        }

        /* Dark mode button overrides */
        .dark .settle-btn {
            background-color: #6B7280 !important;
            color: #F9FAFB !important;
        }

        .dark .fab-btn {
            background-color: #F5F5DC !important;
            color: #1a1a1a !important;
        }

        .dark .custom-total-amount {
            color: #9333EA !important;
        }

        .dark .filter-header-bar {
            background-color: #1E3A5F !important;
        }

        .dark .text-purple-800 {
            color: #A855F7 !important;
        }

        .dark .text-purple-700 {
            color: #A855F7 !important;
        }

        .dark .bg-green-100 {
            background-color: #065F46 !important;
        }

        .dark .bg-red-100 {
            background-color: #991B1B !important;
        }

        .dark .bg-blue-100 {
            background-color: #1E40AF !important;
        }

        .dark .border-green-500 {
            border-color: #10B981 !important;
        }

        .dark .border-purple-500 {
            border-color: #8B5CF6 !important;
        }

        .dark .border-purple-200 {
            border-color: #7C3AED !important;
        }

        .dark .bg-green-50.text-green-700 span {
            color: #4ADE80 !important;
        }

        .dark .border-gray-50 {
            border-color: #374151 !important;
        }

        .dark .bg-indigo-50 {
            background-color: #312E81 !important;
        }

        .dark .text-indigo-600 {
            color: #A5B4FC !important;
        }

        .dark .border-2.border-black .text-gray-800 {
            color: #1a1a1a !important;
        }

        .dark .ring-2.ring-black {
            --tw-ring-color: #60A5FA !important;
        }

        .dark .selected-book {
            background-color: #F9FAFB !important;
            border-color: #F9FAFB !important;
        }

        .dark .selected-book-text {
            color: #1a1a1a !important;
        }

        .dark .selected-book-subtext {
            color: #4B5563 !important;
        }

        /* æ·±è‰²æ¨¡å¼ä¸‹å…±åŒå¸³æœ¬æ˜ç´°çš„æ—¥æœŸå’Œé …ç›®æ”¹ç‚ºæ·±ç°è‰² */
        .debt-detail-date {
            color: #374151;
        }

        .debt-detail-desc {
            color: #4B5563;
        }

        .dark .debt-detail-date {
            color: #9CA3AF !important;
        }

        .dark .debt-detail-desc {
            color: #9CA3AF !important;
        }

        .dark .cleared-item {
            background: linear-gradient(90deg, #064e3b 0%, #065F46 100%) !important;
        }
    </style>
</head>

<body>
    <div id="root"></div>
    <script type="text/babel">
        const firebaseConfig = {
            apiKey: "AIzaSyAqv4xD-suz_VKYoteRuBjvm8y1J1_ZNjs",
            authDomain: "couple-expense-5cd4b.firebaseapp.com",
            databaseURL: "https://couple-expense-5cd4b-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "couple-expense-5cd4b",
            storageBucket: "couple-expense-5cd4b.firebasestorage.app",
            messagingSenderId: "715130800568",
            appId: "1:715130800568:web:31823e05e32ea0d645674d",
            measurementId: "G-2F29HTVHKB"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const TRANSLATIONS = {
            zh: {
                app_title: "åˆ†å¸³æœ¬", book_list: "å¸³æœ¬åˆ—è¡¨", default_book: "é è¨­å¸³æœ¬", ledger: "å¸³æœ¬",
                manage_members: "ç®¡ç†æˆå“¡æ¸…å–®", set_rate: "è¨­å®šåŒ¯ç‡", add_book: "æ–°å¢å¸³æœ¬", menu_settings: "è¨­å®š",
                member_mgmt: "æˆå“¡ç®¡ç†", add_member: "æ–°å¢æˆå“¡", add: "æ–°å¢", save: "ä¿å­˜",
                name: "åå­—", book_settings: "è¨­å®šå¸³æœ¬æˆå“¡", select_members: "è«‹å‹¾é¸è¦åƒèˆ‡çš„æˆå“¡",
                new_book_title: "æ–°å¢æ—…éŠå¸³æœ¬", book_name: "å¸³æœ¬åç¨±", currency: "å¹£åˆ¥",
                search_currency: "æœå°‹ (å¦‚: æ—¥åœ“)", select_participants: "é¸æ“‡åƒèˆ‡æˆå“¡ (è‡³å°‘2äºº)",
                create: "å»ºç«‹", cancel: "å–æ¶ˆ", rate_settings: "è¨­å®šåŒ¯ç‡",
                rate_hint: "ä¿®æ”¹å¾Œï¼Œæ–°å¢è¨˜å¸³å°‡é è¨­æ­¤åŒ¯ç‡ã€‚", confirm_update: "ç¢ºèªä¸¦æ›´æ–°èˆŠè³‡æ–™",
                fetch: "æŠ“å–", settled: "å·²çµæ¸…", owe: "è¦çµ¦", receivables: "æ‡‰æ”¶", payables: "æ‡‰ä»˜",
                settle_period: "æœ¬æœŸå…¨éƒ¨çµç®— (æ­¸é›¶)", start_note: "é–‹å§‹è¨˜å¸³å§", payer: "ä»˜æ¬¾äºº",
                recurring: "å›ºå®šæ”¶æ”¯", add_recurring: "æ–°å¢å›ºå®šæ”¶æ”¯", edit_recurring: "ç·¨è¼¯å›ºå®šæ”¶æ”¯",
                recurring_name: "åç¨±", recurring_amount: "é‡‘é¡", recurring_interval: "é‡è¤‡é€±æœŸ",
                interval_day: "å¤©", interval_month: "æœˆ", interval_year: "å¹´",
                every: "æ¯", repeat_once: "é‡è¤‡ä¸€æ¬¡", date_range: "æ—¥æœŸå€é–“",
                start_date_label: "é–‹å§‹æ—¥æœŸ", end_date_label: "çµæŸæ—¥æœŸ", permanent: "æ°¸ä¹…",
                no_recurring: "å°šç„¡å›ºå®šæ”¶æ”¯", recurring_type: "é¡å‹", recurring_active: "å•Ÿç”¨ä¸­",
                recurring_paused: "å·²æš«åœ", confirm_delete_recurring: "ç¢ºå®šåˆªé™¤æ­¤å›ºå®šæ”¶æ”¯ï¼Ÿ",
                split_target: "åˆ†çµ¦èª°ï¼Ÿ", amount: "é‡‘é¡", date: "æ—¥æœŸ", item: "é …ç›®",
                update: "æ›´æ–°", confirm: "ç¢ºèª", settle_details: "çµç®—è©³æƒ…", history: "æ­·å²ç´€éŒ„",
                history_settle: "çµç®—æ˜ç´° (ç•¶æ™‚åŒ¯ç‡)", no_payment: "ç„¡é ˆä»˜æ¬¾", undo: "æ’¤éŠ·",
                delete: "åˆªé™¤", give: "çµ¦", receive: "æ”¶", detail: "æ˜ç´°", involved: "äººåˆ†",
                confirm_delete: "ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ", confirm_settle: "ç¢ºå®šçµç®—ï¼Ÿç›®å‰çš„ç´€éŒ„å°‡ç§»å…¥æ­·å²å€ã€‚",
                confirm_undo: "ç¢ºå®šæ’¤éŠ·ï¼Ÿ", confirm_perm_delete: "ç¢ºå®šæ°¸ä¹…åˆªé™¤ï¼Ÿ",
                alert_min_members: "å¸³æœ¬è‡³å°‘éœ€è¦ 2 ä½æˆå“¡", alert_input: "è«‹å¡«å¯«å®Œæ•´è³‡è¨Š",
                fetched_rate: "å·²æŠ“å–æœ€æ–°åŒ¯ç‡", accumulated: "ç´¯è¨ˆç´„", flat: "å¹³",
                lang_btn: "Switch to English", included_tx: "åŒ…å«å¸³å‹™",
                split_type: "åˆ†å¸³æ–¹å¼", equal_split: "å¹³åˆ†", custom_split: "ABåˆ†", item_name: "é …ç›®åç¨±",
                per_person: "æ¯äºº", total_amount: "ç¸½é‡‘é¡", export: "åŒ¯å‡º",
                export_selected: "åŒ¯å‡ºé¸å–", export_all: "åŒ¯å‡ºå…¨éƒ¨", select_all: "å…¨é¸",
                deselect_all: "å–æ¶ˆå…¨é¸", my_expense: "è‡ªå·±çš„æ˜ç´°", my_expense_total: "è‡ªå·±æ¶ˆè²»ç¸½é¡",
                filter: "ç¯©é¸", filter_date: "ç¯©é¸æ—¥æœŸ", filter_payer: "ä»˜æ¬¾äºº",
                filter_payee: "è¢«ä»˜æ¬¾äºº", date_range: "æ—¥æœŸå€é–“", single_date: "å–®ä¸€æ—¥æœŸ",
                no_filter: "ä¸ç¯©é¸", start_date: "é–‹å§‹æ—¥æœŸ", end_date: "çµæŸæ—¥æœŸ",
                apply_filter: "å¥—ç”¨ç¯©é¸", clear_filter: "æ¸…é™¤ç¯©é¸", all: "å…¨éƒ¨",
                no_records: "ç„¡ç´€éŒ„", paid_for: "å¹«ä»˜", view_detail: "æŸ¥çœ‹æ˜ç´°",
                tx_detail: "äº¤æ˜“æ˜ç´°", split_to: "åˆ†çµ¦", filter_results: "ç¯©é¸çµæœ",
                self_paid: "è‡ªä»˜", other_paid: "ä»˜",
                recently_deleted: "æœ€è¿‘åˆªé™¤", restore: "å¾©åŸ", days_left: "å¤©å¾Œæ°¸ä¹…åˆªé™¤",
                no_deleted_books: "æ²’æœ‰å·²åˆªé™¤çš„å¸³æœ¬", confirm_restore: "ç¢ºå®šè¦å¾©åŸæ­¤å¸³æœ¬å—ï¼Ÿ",
                shared_books: "å…±åŒå¸³æœ¬", personal_books: "å€‹äººå¸³æœ¬",
                select_book_type: "é¸æ“‡å¸³æœ¬é¡å‹", shared_book_desc: "å¤šäººå…±åŒè¨˜å¸³åˆ†å¸³",
                personal_book_desc: "å€‹äººæ”¶æ”¯è¨˜éŒ„", owner: "æ“æœ‰è€…", select_owner: "é¸æ“‡æ“æœ‰è€…",
                scan: "æƒæ", take_photo: "æ‹æ”ç…§ç‰‡", choose_photo: "å¾ç›¸ç°¿é¸æ“‡",
                retake: "é‡æ–°æ‹æ”", scanning: "è¾¨è­˜ä¸­...", scan_result: "æƒæçµæœ",
                category: "é¡åˆ¥", expense: "æ”¯å‡º", income: "æ”¶å…¥", type: "é¡å‹",
                this_month: "æœ¬æœˆ", balance: "çµé¤˜", total_expense: "ç¸½æ”¯å‡º", total_income: "ç¸½æ”¶å…¥",
                monthly_summary: "æœˆçµæ‘˜è¦", auto_settle: "è‡ªå‹•çµç®—", next: "ä¸‹ä¸€æ­¥",
                no_personal_books: "å°šç„¡å€‹äººå¸³æœ¬", add_first_personal: "æ–°å¢ç¬¬ä¸€æœ¬å€‹äººå¸³æœ¬",
                settings: "è¨­å®š", sort_order: "æ’åºæ–¹å¼", newest_first: "æ–°åˆ°èˆŠ", oldest_first: "èˆŠåˆ°æ–°", book_settings_title: "å¸³æœ¬è¨­å®š",
                category_mgmt: "é¡åˆ¥ç®¡ç†", add_category: "æ–°å¢é¡åˆ¥", edit_category: "ç·¨è¼¯é¡åˆ¥", edit_rate: "ç·¨è¼¯åŒ¯ç‡", default_category: "é è¨­",
                category_name_zh: "é¡åˆ¥åç¨±(ä¸­)", category_name_en: "é¡åˆ¥åç¨±(è‹±)", category_icon: "é¡åˆ¥åœ–ç¤º",
                confirm_delete_category: "ç¢ºå®šè¦åˆªé™¤æ­¤é¡åˆ¥å—ï¼Ÿ", category_in_use: "æ­¤é¡åˆ¥æ­£åœ¨ä½¿ç”¨ä¸­ï¼Œç„¡æ³•åˆªé™¤",
                member_settings: "æˆå“¡è¨­å®š", import_success: "æˆåŠŸåŒ¯å…¥", records: "ç­†äº¤æ˜“è¨˜éŒ„",
                no_valid_records: "æ²’æœ‰æœ‰æ•ˆçš„äº¤æ˜“è¨˜éŒ„å¯åŒ¯å…¥", dark_mode: "æ·±è‰²æ¨¡å¼", light_mode: "æ·ºè‰²æ¨¡å¼",
                expense_details: "æ”¯å‡ºæ˜ç´°", income_details: "æ”¶å…¥æ˜ç´°",
                upload_icon: "ä¸Šå‚³åœ–ç¤º", custom_icon: "è‡ªè¨‚åœ–ç¤º", filter_category: "é¡åˆ¥", filter_type: "é¡å‹",
                cleared: "å·²çµæ¸…", mark_cleared: "çµæ¸…", undo_cleared: "å–æ¶ˆçµæ¸…",
                enter_prompt: "è¼¸å…¥æŒ‡ä»¤ (å¯é¸)", prompt_example: "ä¾‹: ABåˆ†,Dä»˜150å…ƒ,A 50å…ƒ,B 50å…ƒ", start_analysis: "é–‹å§‹åˆ†æ",
                open_book: "é–‹æ”¾å¸³æœ¬", open_book_desc: "é–‹å•Ÿå¾Œï¼Œä»»ä½•äººéƒ½å¯é€éåˆ†äº«é€£çµç·¨è¼¯æ­¤å¸³æœ¬",
                share_link: "åˆ†äº«é€£çµ", copy_link: "è¤‡è£½é€£çµ", link_copied: "å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿",
                guest_mode: "è¨ªå®¢æ¨¡å¼", public_books: "å…¬é–‹å¸³æœ¬", back_to_home: "è¿”å›é¦–é ",
                no_public_books: "æ­¤ç”¨æˆ¶æ²’æœ‰å…¬é–‹å¸³æœ¬", loading_auth: "è¼‰å…¥ä¸­..."
            },
            en: {
                app_title: "Split Bill", book_list: "Ledgers", default_book: "Default Ledger", ledger: "Ledger",
                manage_members: "Manage Members", set_rate: "Set Rate", add_book: "New Ledger", menu_settings: "Settings",
                member_mgmt: "Members", add_member: "Add New", add: "Add", save: "Save",
                name: "Name", book_settings: "Ledger Members", select_members: "Select members for this ledger",
                new_book_title: "New Ledger", book_name: "Name", currency: "Currency",
                search_currency: "Search (e.g. JPY)", select_participants: "Participants (Min 2)",
                create: "Create", cancel: "Cancel", rate_settings: "Exchange Rate",
                rate_hint: "This rate will be used for new entries.", confirm_update: "Update & Apply to Old",
                fetch: "Fetch", settled: "Settled", owe: "owes", receivables: "To Receive", payables: "To Pay",
                settle_period: "Settle Up (Clear All)", start_note: "Start splitting bills!", payer: "Payer",
                recurring: "Recurring", add_recurring: "Add Recurring", edit_recurring: "Edit Recurring",
                recurring_name: "Name", recurring_amount: "Amount", recurring_interval: "Repeat Cycle",
                interval_day: "Day", interval_month: "Month", interval_year: "Year",
                every: "Every", repeat_once: "repeat once", date_range: "Date Range",
                start_date_label: "Start Date", end_date_label: "End Date", permanent: "Permanent",
                no_recurring: "No recurring items", recurring_type: "Type", recurring_active: "Active",
                recurring_paused: "Paused", confirm_delete_recurring: "Delete this recurring item?",
                split_target: "Split with?", amount: "Amount", date: "Date", item: "Description",
                update: "Update", confirm: "Confirm", settle_details: "Settlement Details", history: "History",
                history_settle: "Settlement (Historical Rate)", no_payment: "No payments needed", undo: "Undo",
                delete: "Delete", give: "to", receive: "from", detail: "Detail", involved: "ppl",
                confirm_delete: "Are you sure you want to delete?", confirm_settle: "Settle up? Records will move to history.",
                confirm_undo: "Undo settlement?", confirm_perm_delete: "Permanently delete?",
                alert_min_members: "At least 2 members required.", alert_input: "Please fill in all fields.",
                fetched_rate: "Fetched latest rate", accumulated: "Approx.", flat: "Even",
                lang_btn: "åˆ‡æ›è‡³ä¸­æ–‡", included_tx: "Transactions Included",
                split_type: "Split Type", equal_split: "Equal Split", custom_split: "Custom Split", item_name: "Item Name",
                per_person: "Per person", total_amount: "Total", export: "Export",
                export_selected: "Export Selected", export_all: "Export All", select_all: "Select All",
                deselect_all: "Deselect All", my_expense: "My Expenses", my_expense_total: "My Total Expense",
                filter: "Filter", filter_date: "Filter by Date", filter_payer: "Payer",
                filter_payee: "Payee", date_range: "Date Range", single_date: "Single Date",
                no_filter: "No Filter", start_date: "Start Date", end_date: "End Date",
                apply_filter: "Apply", clear_filter: "Clear", all: "All",
                no_records: "No records", paid_for: "Paid", view_detail: "View Detail",
                tx_detail: "Transaction Detail", split_to: "Split to", filter_results: "Filter Results",
                self_paid: "Self", other_paid: "paid",
                recently_deleted: "Recently Deleted", restore: "Restore", days_left: "days left",
                no_deleted_books: "No deleted ledgers", confirm_restore: "Restore this ledger?",
                shared_books: "Shared Ledgers", personal_books: "Personal Ledgers",
                select_book_type: "Select Ledger Type", shared_book_desc: "Split expenses with others",
                personal_book_desc: "Personal income & expense", owner: "Owner", select_owner: "Select Owner",
                scan: "Scan", take_photo: "Take Photo", choose_photo: "Choose from Gallery",
                retake: "Retake", scanning: "Scanning...", scan_result: "Scan Result",
                category: "Category", expense: "Expense", income: "Income", type: "Type",
                this_month: "This Month", balance: "Balance", total_expense: "Total Expense", total_income: "Total Income",
                monthly_summary: "Monthly Summary", auto_settle: "Auto Settle", next: "Next",
                no_personal_books: "No personal ledgers", add_first_personal: "Add first personal ledger",
                settings: "Settings", sort_order: "Sort Order", newest_first: "Newest First", oldest_first: "Oldest First", book_settings_title: "Ledger Settings",
                category_mgmt: "Category Management", add_category: "Add Category", edit_category: "Edit Category", edit_rate: "Edit Rate", default_category: "Default",
                category_name_zh: "Category Name (ZH)", category_name_en: "Category Name (EN)", category_icon: "Category Icon",
                confirm_delete_category: "Delete this category?", category_in_use: "Category in use, cannot delete",
                member_settings: "Member Settings", import_success: "Successfully imported", records: "transaction records",
                no_valid_records: "No valid records to import", dark_mode: "Dark Mode", light_mode: "Light Mode",
                expense_details: "Expense Details", income_details: "Income Details",
                upload_icon: "Upload Icon", custom_icon: "Custom Icon", filter_category: "Category", filter_type: "Type",
                cleared: "Cleared", mark_cleared: "Clear", undo_cleared: "Undo Clear",
                enter_prompt: "Enter command (optional)", prompt_example: "e.g. Custom split, D pays 150, A 50, B 50", start_analysis: "Start Analysis",
                open_book: "Open Book", open_book_desc: "When enabled, anyone can edit this book via share link",
                share_link: "Share Link", copy_link: "Copy Link", link_copied: "Copied to clipboard",
                guest_mode: "Guest Mode", public_books: "Public Books", back_to_home: "Back to Home",
                no_public_books: "No public books available", loading_auth: "Loading..."
            }
        };

        const CURRENCIES = [
            { code: 'TWD', symbol: '$', flag: 'ğŸ‡¹ğŸ‡¼', rate: 1, name_zh: 'æ–°å°å¹£', name_en: 'Taiwan Dollar' },
            { code: 'JPY', symbol: 'Â¥', flag: 'ğŸ‡¯ğŸ‡µ', rate: 0.21, name_zh: 'æ—¥åœ“', name_en: 'Japanese Yen' },
            { code: 'USD', symbol: '$', flag: 'ğŸ‡ºğŸ‡¸', rate: 32.5, name_zh: 'ç¾é‡‘', name_en: 'US Dollar' },
            { code: 'EUR', symbol: 'â‚¬', flag: 'ğŸ‡ªğŸ‡º', rate: 35.0, name_zh: 'æ­å…ƒ', name_en: 'Euro' },
            { code: 'KRW', symbol: 'â‚©', flag: 'ğŸ‡°ğŸ‡·', rate: 0.024, name_zh: 'éŸ“å…ƒ', name_en: 'Korean Won' },
            { code: 'CNY', symbol: 'Â¥', flag: 'ğŸ‡¨ğŸ‡³', rate: 4.5, name_zh: 'äººæ°‘å¹£', name_en: 'Chinese Yuan' },
            { code: 'HKD', symbol: 'HK$', flag: 'ğŸ‡­ğŸ‡°', rate: 4.1, name_zh: 'æ¸¯å¹£', name_en: 'Hong Kong Dollar' },
            { code: 'THB', symbol: 'à¸¿', flag: 'ğŸ‡¹ğŸ‡­', rate: 0.9, name_zh: 'æ³°éŠ–', name_en: 'Thai Baht' },
            { code: 'GBP', symbol: 'Â£', flag: 'ğŸ‡¬ğŸ‡§', rate: 41.0, name_zh: 'è‹±éŠ', name_en: 'British Pound' },
            { code: 'AUD', symbol: '$', flag: 'ğŸ‡¦ğŸ‡º', rate: 21.5, name_zh: 'æ¾³å¹£', name_en: 'Australian Dollar' },
            { code: 'SGD', symbol: 'S$', flag: 'ğŸ‡¸ğŸ‡¬', rate: 24.0, name_zh: 'æ–°å¹£', name_en: 'Singapore Dollar' },
            { code: 'VND', symbol: 'â‚«', flag: 'ğŸ‡»ğŸ‡³', rate: 0.0013, name_zh: 'è¶Šå—ç›¾', name_en: 'Vietnamese Dong' },
            { code: 'MYR', symbol: 'RM', flag: 'ğŸ‡²ğŸ‡¾', rate: 7.0, name_zh: 'é¦¬å¹£', name_en: 'Malaysian Ringgit' },
        ];

        const CATEGORIES = [
            { id: 'food', icon: 'ğŸ½ï¸', name_zh: 'é¤é£²', name_en: 'Food' },
            { id: 'transport', icon: 'ğŸš—', name_zh: 'äº¤é€š', name_en: 'Transport' },
            { id: 'groceries', icon: 'ğŸ›’', name_zh: 'æ—¥ç”¨å“', name_en: 'Groceries' },
            { id: 'entertainment', icon: 'ğŸ¬', name_zh: 'å¨›æ¨‚', name_en: 'Entertainment' },
            { id: 'shopping', icon: 'ğŸ›ï¸', name_zh: 'è³¼ç‰©', name_en: 'Shopping' },
            { id: 'health', icon: 'ğŸ’Š', name_zh: 'é†«ç™‚', name_en: 'Health' },
            { id: 'utilities', icon: 'ğŸ’¡', name_zh: 'æ°´é›»', name_en: 'Utilities' },
            { id: 'salary', icon: 'ğŸ’°', name_zh: 'è–ªè³‡', name_en: 'Salary' },
            { id: 'investment', icon: 'ğŸ“ˆ', name_zh: 'æŠ•è³‡', name_en: 'Investment' },
            { id: 'transfers', icon: 'ğŸ”„', name_zh: 'è½‰å¸³', name_en: 'Transfers & payments' },
            { id: 'vehicle', icon: 'ğŸšŒ', name_zh: 'è»Šè¼›äº¤é€š', name_en: 'Vehicle & transport' },
            { id: 'education', icon: 'ğŸ“', name_zh: 'æ•™è‚²', name_en: 'Education' },
            { id: 'laundry', icon: 'ğŸ§º', name_zh: 'æ´—è¡£æœ', name_en: 'Laundry' },
            { id: 'accommodation', icon: 'ğŸ ', name_zh: 'ä½å®¿è²»', name_en: 'Accommodation' },
            { id: 'other', icon: 'ğŸ“', name_zh: 'å…¶ä»–', name_en: 'Other' },
        ];

        const CATEGORY_ICONS = ['ğŸ½ï¸', 'ğŸš—', 'ğŸ›’', 'ğŸ¬', 'ğŸ›ï¸', 'ğŸ’Š', 'ğŸ’¡', 'ğŸ’°', 'ğŸ“ˆ', 'ğŸ“', 'ğŸ ', 'âœˆï¸', 'ğŸ®', 'ğŸ“±', 'ğŸ‘•', 'ğŸ’„', 'ğŸ', 'ğŸ•', 'ğŸ“š', 'ğŸ‹ï¸', 'â˜•', 'ğŸº', 'ğŸµ', 'ğŸ’»', 'ğŸ”§', 'ğŸšŒ', 'ğŸ”„', 'ğŸ’³', 'ğŸ¦', 'ğŸ“', 'ğŸ¥¬', 'ğŸ', 'ğŸ“¶', 'ğŸª', 'ğŸ’µ', 'ğŸ¥—'];

        const FALLBACK_RATES = { 'TWD': 1, 'JPY': 0.21, 'USD': 32.5, 'EUR': 35.0, 'KRW': 0.024, 'CNY': 4.5, 'HKD': 4.1, 'THB': 0.9, 'GBP': 41.0, 'AUD': 21.5, 'SGD': 24.0, 'VND': 0.0013, 'MYR': 7.0 };
        const AVATARS = ['ğŸ°', 'ğŸ»', 'ğŸ¶', 'ğŸ±', 'ğŸ¦', 'ğŸ¯', 'ğŸ®', 'ğŸ·', 'ğŸ¸', 'ğŸµ', 'ğŸ§', 'ğŸ”', 'ğŸ¦„', 'ğŸ™', 'ğŸ¦Š', 'ğŸ¨', 'ğŸ¼', 'ğŸ¹', 'ğŸ­', 'ğŸ¦–'];
        const { useState, useEffect, useRef, useCallback } = React;

        // Swipe to Delete Component
        const SwipeToDelete = ({ children, onDelete, deleteText = 'åˆªé™¤' }) => {
            const [startX, setStartX] = useState(0);
            const [currentX, setCurrentX] = useState(0);
            const [isSwiping, setIsSwiping] = useState(false);
            const containerRef = useRef(null);
            const deleteThreshold = 80;

            const handleTouchStart = (e) => {
                setStartX(e.touches[0].clientX);
                setIsSwiping(true);
            };

            const handleTouchMove = (e) => {
                if (!isSwiping) return;
                const diff = startX - e.touches[0].clientX;
                if (diff > 0) {
                    setCurrentX(Math.min(diff, 100));
                } else {
                    setCurrentX(0);
                }
            };

            const handleTouchEnd = () => {
                setIsSwiping(false);
                if (currentX > deleteThreshold) {
                    onDelete();
                }
                setCurrentX(0);
            };

            return (
                <div className="swipe-container rounded-2xl" ref={containerRef}>
                    <div className="swipe-delete-bg">
                        <Icons.Trash />
                    </div>
                    <div
                        className={`swipe-content ${isSwiping ? 'swiping' : ''}`}
                        style={{ transform: `translateX(-${currentX}px)` }}
                        onTouchStart={handleTouchStart}
                        onTouchMove={handleTouchMove}
                        onTouchEnd={handleTouchEnd}
                    >
                        {children}
                    </div>
                </div>
            );
        };

        // Swipe to Clear/Unclear Component for debt details
        // å¾€å·¦æ»‘ = çµæ¸…, å¾€å³æ»‘ = å–æ¶ˆçµæ¸…
        const SwipeToClear = ({ children, onClear, onUnclear, isCleared, clearText = 'çµæ¸…' }) => {
            const [startX, setStartX] = useState(0);
            const [currentX, setCurrentX] = useState(0);
            const [isSwiping, setIsSwiping] = useState(false);
            const swipeThreshold = 80;

            const handleTouchStart = (e) => {
                setStartX(e.touches[0].clientX);
                setIsSwiping(true);
            };

            const handleTouchMove = (e) => {
                if (!isSwiping) return;
                const diff = startX - e.touches[0].clientX;
                // æœªçµæ¸…æ™‚åªèƒ½å·¦æ»‘ï¼ˆçµæ¸…ï¼‰ï¼Œå·²çµæ¸…æ™‚åªèƒ½å³æ»‘ï¼ˆå–æ¶ˆï¼‰
                if (!isCleared && diff > 0) {
                    setCurrentX(Math.min(diff, 100));
                } else if (isCleared && diff < 0) {
                    setCurrentX(Math.max(diff, -100));
                } else {
                    setCurrentX(0);
                }
            };

            const handleTouchEnd = () => {
                setIsSwiping(false);
                if (!isCleared && currentX > swipeThreshold) {
                    onClear && onClear();
                } else if (isCleared && currentX < -swipeThreshold) {
                    onUnclear && onUnclear();
                }
                setCurrentX(0);
            };

            return (
                <div className="swipe-container rounded-xl overflow-hidden" style={{ position: 'relative' }}>
                    {/* å³å´ç¶ è‰²çµæ¸…èƒŒæ™¯ - åªæœ‰æœªçµæ¸…æ™‚é¡¯ç¤º */}
                    {!isCleared && <div className="swipe-clear-bg">
                        <span className="text-xs font-bold">{clearText}</span>
                    </div>}
                    {/* å·¦å´å–æ¶ˆçµæ¸…èƒŒæ™¯ - åªåœ¨æ»‘å‹•ä¸”æ»‘å‹•è·é›¢è¶…éä¸€å®šå€¼æ™‚æ‰é¡¯ç¤ºï¼Œå¹³æ™‚å®Œå…¨éš±è— */}
                    {isCleared && currentX < -20 && <div className="swipe-unclear-bg-left">
                        <span className="text-xs font-bold">å–æ¶ˆ</span>
                    </div>}
                    <div
                        className={`swipe-content ${isSwiping ? 'swiping' : ''}`}
                        style={{ transform: `translateX(${isCleared ? -currentX : -currentX}px)` }}
                        onTouchStart={handleTouchStart}
                        onTouchMove={handleTouchMove}
                        onTouchEnd={handleTouchEnd}
                    >
                        {children}
                    </div>
                </div>
            );
        };

        const Icons = {
            Menu: () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 6h16M4 12h16M4 18h16" /></svg>,
            Plus: () => <svg className="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 4v16m8-8H4" /></svg>,
            History: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
            Check: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 13l4 4L19 7" /></svg>,
            Trash: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>,
            Edit: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>,
            Globe: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
            Back: () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 19l-7-7 7-7" /></svg>,
            Undo: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6" /></svg>,
            Settings: () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>,
            Sort: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4" /></svg>,
            User: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>,
            Users: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" /></svg>,
            Refresh: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>,
            Eye: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>,
            Lang: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129" /></svg>,
            Download: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>,
            Filter: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" /></svg>,
            ChevronRight: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 5l7 7-7 7" /></svg>,
            Camera: () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" /></svg>,
            Image: () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>,
            TrendUp: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg>,
            TrendDown: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6" /></svg>,
            Category: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" /></svg>,
            Moon: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>,
            Sun: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>,
            Eye: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>,
            Pause: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
            Play: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
            Upload: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>,
        };

        const fetchExchangeRate = async (currencyCode) => {
            if (currencyCode === 'TWD') return 1;
            try {
                const response = await fetch('https://open.er-api.com/v6/latest/' + currencyCode);
                const data = await response.json();
                if (data && data.rates && data.rates.TWD) return data.rates.TWD;
                return FALLBACK_RATES[currencyCode] || 1;
            } catch (error) { return FALLBACK_RATES[currencyCode] || 1; }
        };

        function CoupleExpenseApp() {
            const [currentBookId, setCurrentBookId] = useState(localStorage.getItem('lastBookId') || 'default');
            const [booksMeta, setBooksMeta] = useState({});
            const [globalMembers, setGlobalMembers] = useState({});
            const [transactions, setTransactions] = useState([]);
            const [settlements, setSettlements] = useState([]);
            const [isMenuOpen, setIsMenuOpen] = useState(false);
            const [isMenuSettingsOpen, setIsMenuSettingsOpen] = useState(false);
            const [isAddBookOpen, setIsAddBookOpen] = useState(false);
            const [addBookStep, setAddBookStep] = useState(1);
            const [newBookType, setNewBookType] = useState('shared');
            const [isMemberManagerOpen, setIsMemberManagerOpen] = useState(false);
            const [memberManagerSource, setMemberManagerSource] = useState(null); // 'menu' or 'book'
            const [recurringItems, setRecurringItems] = useState([]);
            const [isRecurringListOpen, setIsRecurringListOpen] = useState(false);
            const [isRecurringFormOpen, setIsRecurringFormOpen] = useState(false);
            const [editingRecurring, setEditingRecurring] = useState(null);
            const [recurringForm, setRecurringForm] = useState({
                name: '', amount: '', txType: 'expense', intervalType: 'month', intervalValue: 1,
                category: 'other', startDate: new Date().toISOString().split('T')[0], endDate: '', isPermanent: true,
                payer: '', involved: []
            });
            const [isBookMemberSettingsOpen, setIsBookMemberSettingsOpen] = useState(false);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [isRateModalOpen, setIsRateModalOpen] = useState(false);
            const [isHistoryOpen, setIsHistoryOpen] = useState(false);
            const [viewingSettlement, setViewingSettlement] = useState(null);
            const [loading, setLoading] = useState(true);
            const [editingId, setEditingId] = useState(null);
            const [sortNewestFirst, setSortNewestFirst] = useState(false);
            const [viewingMemberDebt, setViewingMemberDebt] = useState(null);
            const [expandedDebtDetail, setExpandedDebtDetail] = useState(null); // { type: 'pay'|'receive', person: string }
            const [lang, setLang] = useState('zh');
            const t = TRANSLATIONS[lang];
            const [editingBookId, setEditingBookId] = useState(null);
            const [tempBookName, setTempBookName] = useState('');
            const [editingGlobalMember, setEditingGlobalMember] = useState(null);
            const [editMemberName, setEditMemberName] = useState('');
            const [editMemberAvatar, setEditMemberAvatar] = useState('');
            const [newBookName, setNewBookName] = useState('');
            const [newBookCurrency, setNewBookCurrency] = useState('TWD');
            const [newBookOwner, setNewBookOwner] = useState('');
            const [selectedMembers, setSelectedMembers] = useState([]);
            const [currencySearch, setCurrencySearch] = useState('');
            const [formData, setFormData] = useState({ date: new Date().toISOString().split('T')[0], description: '', amount: '', exchangeRate: '', payer: '', involved: [], splitType: 'equal', customItems: {}, category: 'other', txType: 'expense' });
            const [newRate, setNewRate] = useState('');
            const [newMemberName, setNewMemberName] = useState('');
            const [newMemberAvatar, setNewMemberAvatar] = useState(AVATARS[0]);
            const [isFilterOpen, setIsFilterOpen] = useState(false);
            const [filterDateType, setFilterDateType] = useState('none');
            const [filterStartDate, setFilterStartDate] = useState('');
            const [filterEndDate, setFilterEndDate] = useState('');
            const [filterSingleDate, setFilterSingleDate] = useState('');
            const [filterPayer, setFilterPayer] = useState('');
            const [filterPayee, setFilterPayee] = useState('');
            const [activeFilters, setActiveFilters] = useState({});
            const [viewingFilteredTx, setViewingFilteredTx] = useState(null);
            const [selectedSettlements, setSelectedSettlements] = useState([]);
            const [isExportMode, setIsExportMode] = useState(false);
            const [deletedBooks, setDeletedBooks] = useState({});
            const [isDeletedBooksOpen, setIsDeletedBooksOpen] = useState(false);
            const [isScanOpen, setIsScanOpen] = useState(false);
            const [scanMode, setScanMode] = useState(null);
            const [capturedImage, setCapturedImage] = useState(null);
            const [previewImage, setPreviewImage] = useState(null); // é è¦½åœ–ç‰‡
            const [promptInput, setPromptInput] = useState(''); // ä½¿ç”¨è€…æŒ‡ä»¤
            const [isScanning, setIsScanning] = useState(false);
            const [scanResults, setScanResults] = useState([]);
            const [isScanResultOpen, setIsScanResultOpen] = useState(false);
            const [editingScanIndex, setEditingScanIndex] = useState(null);
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [customCategories, setCustomCategories] = useState([]);
            const [isCategoryEditOpen, setIsCategoryEditOpen] = useState(false);
            const [editingCategory, setEditingCategory] = useState(null);
            const [newCategoryName, setNewCategoryName] = useState('');
            const [newCategoryNameEn, setNewCategoryNameEn] = useState('');
            const [newCategoryIcon, setNewCategoryIcon] = useState('ğŸ“');
            const [customIconUrl, setCustomIconUrl] = useState(''); // è‡ªè¨‚åœ–ç¤ºURL
            const [filterCategory, setFilterCategory] = useState(''); // å€‹äººå¸³æœ¬é¡åˆ¥ç¯©é¸
            const [filterType, setFilterType] = useState(''); // å€‹äººå¸³æœ¬é¡å‹ç¯©é¸
            const [clearedTransactions, setClearedTransactions] = useState({}); // çµæ¸…ç‹€æ…‹ { txId: { clearedAt, clearedBy } }
            // Dark Mode State
            const [darkMode, setDarkMode] = useState(() => {
                const saved = localStorage.getItem('darkMode');
                return saved ? JSON.parse(saved) : false;
            });
            // Expense/Income Detail Modal State
            const [isExpenseDetailOpen, setIsExpenseDetailOpen] = useState(false);
            const [isIncomeDetailOpen, setIsIncomeDetailOpen] = useState(false);
            const videoRef = useRef(null);
            const streamRef = useRef(null);
            const fileInputRef = useRef(null);
            const bottomRef = useRef(null);

            // Firebase Auth State
            const [userId, setUserId] = useState(null);
            const [userInfo, setUserInfo] = useState(null); // { name, photo, email }
            const [authLoading, setAuthLoading] = useState(true);
            const [isGuest, setIsGuest] = useState(false);
            const [shareUserId, setShareUserId] = useState(null);
            const [publicBooks, setPublicBooks] = useState({});

            // Check URL for share parameter
            useEffect(() => {
                const urlParams = new URLSearchParams(window.location.search);
                const shareParam = urlParams.get('share');
                if (shareParam) {
                    setShareUserId(shareParam);
                    setIsGuest(true);
                }
            }, []);

            // Google Sign-in function
            const signInWithGoogle = async () => {
                const provider = new firebase.auth.GoogleAuthProvider();
                try {
                    await firebase.auth().signInWithPopup(provider);
                } catch (error) {
                    console.error('Google sign-in error:', error);
                    alert('ç™»å…¥å¤±æ•—ï¼Œè«‹å†è©¦ä¸€æ¬¡');
                }
            };

            // Sign out function
            const signOut = async () => {
                try {
                    await firebase.auth().signOut();
                    setUserId(null);
                    setUserInfo(null);
                } catch (error) {
                    console.error('Sign out error:', error);
                }
            };

            // Toggle public book (enable/disable sharing)
            const togglePublicBook = async (bookId) => {
                if (!userId) return;
                const book = booksMeta[bookId];
                if (!book) return;

                const isCurrentlyPublic = book.isPublic || false;

                if (isCurrentlyPublic) {
                    // Make private: remove from publicBooks
                    await db.ref('publicBooks/' + bookId).remove();
                    await db.ref('users/' + userId + '/booksMeta/' + bookId).update({ isPublic: false });
                } else {
                    // Make public: copy to publicBooks
                    const publicBookData = {
                        ...book,
                        isPublic: true,
                        ownerId: userId,
                        globalMembers: globalMembers
                    };

                    // Copy book meta
                    await db.ref('publicBooks/' + bookId).set(publicBookData);

                    // Copy transactions
                    const txPath = bookId === 'default'
                        ? 'users/' + userId + '/transactions'
                        : 'users/' + userId + '/books/' + bookId + '/transactions';
                    const txSnapshot = await db.ref(txPath).once('value');
                    if (txSnapshot.val()) {
                        await db.ref('publicBooks/' + bookId + '/transactions').set(txSnapshot.val());
                    }

                    // Update booksMeta
                    await db.ref('users/' + userId + '/booksMeta/' + bookId).update({ isPublic: true });
                }
            };

            // Copy share link to clipboard
            const copyShareLink = () => {
                const link = window.location.origin + '?share=' + userId;
                navigator.clipboard.writeText(link).then(() => {
                    alert(t.link_copied);
                }).catch(err => {
                    console.error('Failed to copy:', err);
                    prompt('Copy this link:', link);
                });
            };

            // Firebase Auth State Listener
            useEffect(() => {
                if (isGuest && shareUserId) {
                    // Guest mode: load public books of the shared user
                    setAuthLoading(false);
                    const publicBooksRef = db.ref('publicBooks');
                    publicBooksRef.orderByChild('ownerId').equalTo(shareUserId).on('value', (snapshot) => {
                        const val = snapshot.val();
                        if (val) {
                            setPublicBooks(val);
                            const firstBookId = Object.keys(val)[0];
                            if (firstBookId && !val[currentBookId]) {
                                setCurrentBookId(firstBookId);
                            }
                        } else {
                            setPublicBooks({});
                        }
                    });
                    return () => publicBooksRef.off();
                }

                // Normal mode: Listen for auth state
                const unsubscribe = firebase.auth().onAuthStateChanged((user) => {
                    if (user) {
                        setUserId(user.uid);
                        setUserInfo({
                            name: user.displayName || 'User',
                            photo: user.photoURL,
                            email: user.email
                        });
                        setAuthLoading(false);
                    } else {
                        setUserId(null);
                        setUserInfo(null);
                        setAuthLoading(false);
                    }
                });

                return () => unsubscribe();
            }, [isGuest, shareUserId]);

            // Helper function to get data path based on public/private status
            const getDataPath = (basePath, bookId) => {
                const book = booksMeta[bookId] || publicBooks[bookId];
                if (book && book.isPublic) {
                    return 'publicBooks/' + bookId + '/' + basePath;
                }
                if (isGuest) {
                    return 'publicBooks/' + bookId + '/' + basePath;
                }
                if (!userId) return null;
                if (bookId === 'default') {
                    return 'users/' + userId + '/' + basePath;
                }
                return 'users/' + userId + '/books/' + bookId + '/' + basePath;
            };

            // Helper function to get user base path
            const getUserPath = (path) => {
                if (!userId) return null;
                return 'users/' + userId + '/' + path;
            };

            const currentBook = booksMeta[currentBookId] || { name: t.default_book, currency: 'TWD', customRate: 1, members: ['æ…§æ¬£', 'ä¿Šå»·'], isPersonal: false };
            const isPersonalBook = currentBook.isPersonal || false;
            const validBookMembers = (currentBook.members || []).filter(m => globalMembers.hasOwnProperty(m));
            const bookMembers = validBookMembers.length > 0 ? validBookMembers : Object.keys(globalMembers).slice(0, 2);
            const currentCurrency = CURRENCIES.find(c => c.code === currentBook.currency) || CURRENCIES[0];
            const activeRate = currentBook.customRate || currentCurrency.rate || 1;

            // Combine default and custom categories
            const allCategories = React.useMemo(() => {
                // Merge CATEGORIES with customCategories, allowing customCategories to override defaults
                const merged = CATEGORIES.map(cat => {
                    const customVersion = customCategories.find(c => c.id === cat.id);
                    return customVersion || cat;
                });
                // Add any truly new custom categories (not overriding defaults)
                const newCustom = customCategories.filter(c => !CATEGORIES.find(d => d.id === c.id));
                return [...merged, ...newCustom];
            }, [customCategories]);

            const sharedBooks = Object.entries(booksMeta).filter(([id, book]) => !book.isPersonal);
            const personalBooks = Object.entries(booksMeta).filter(([id, book]) => book.isPersonal);

            const getCurrentMonth = () => {
                const now = new Date();
                return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            };

            // è¨ˆç®—æ‰€æœ‰äº¤æ˜“çš„çµ±è¨ˆï¼ˆç”¨æ–¼å€‹äººå¸³æœ¬ï¼‰
            const getMonthlyStats = () => {
                let totalExpense = 0;
                let totalIncome = 0;
                transactions.forEach(tx => {
                    if (tx.txType === 'income') totalIncome += tx.amount;
                    else totalExpense += tx.amount;
                });
                return { totalExpense, totalIncome, balance: totalIncome - totalExpense };
            };

            // Helper function to format description (remove brackets and simplify Iglu)
            const formatDescription = (description) => {
                if (!description) return '';
                // Remove content in parentheses for AI-recognized items
                let formatted = description.replace(/\s*\([^)]*\)\s*$/, '');
                // If contains "Iglu" (case insensitive), replace with just "Iglu"
                if (/iglu/i.test(formatted)) {
                    formatted = 'Iglu';
                }
                return formatted;
            };

            // Helper function to render category icon (supports emoji and custom image)
            const renderCategoryIcon = (icon, size = 'text-2xl') => {
                if (!icon) return <span className={size}>ğŸ“</span>;
                // Check if icon is a data URL (custom uploaded image)
                if (icon.startsWith('data:image')) {
                    const imgSize = size === 'text-2xl' ? 'w-6 h-6' : size === 'text-xl' ? 'w-5 h-5' : 'w-4 h-4';
                    return <img src={icon} alt="icon" className={`${imgSize} object-contain`} />;
                }
                return <span className={size}>{icon}</span>;
            };

            // Get expense and income transactions for detail views
            const expenseTransactions = React.useMemo(() => {
                return transactions.filter(tx => tx.txType !== 'income');
            }, [transactions]);

            const incomeTransactions = React.useMemo(() => {
                return transactions.filter(tx => tx.txType === 'income');
            }, [transactions]);

            // Apply dark mode to body
            useEffect(() => {
                if (darkMode) {
                    document.body.classList.add('dark');
                    document.documentElement.classList.add('dark');
                } else {
                    document.body.classList.remove('dark');
                    document.documentElement.classList.remove('dark');
                }
                localStorage.setItem('darkMode', JSON.stringify(darkMode));
            }, [darkMode]);

            useEffect(() => {
                // Skip if still loading auth or in guest mode without share user
                if (authLoading) return;
                if (isGuest) return; // Guest mode handled separately

                if (!userId) return; // Wait for auth

                const metaRef = db.ref('users/' + userId + '/booksMeta');
                const membersRef = db.ref('users/' + userId + '/settings/globalMembers');
                const deletedRef = db.ref('users/' + userId + '/deletedBooks');
                const categoriesRef = db.ref('users/' + userId + '/settings/customCategories');

                metaRef.on('value', (snapshot) => {
                    const val = snapshot.val();
                    if (val) setBooksMeta(val);
                    else db.ref('users/' + userId + '/booksMeta/default').set({ name: t.default_book, currency: 'TWD', customRate: 1, members: ['A', 'B'], isPersonal: false, createdAt: Date.now() });
                });
                membersRef.on('value', (snapshot) => {
                    const val = snapshot.val();
                    if (val) setGlobalMembers(val);
                    else db.ref('users/' + userId + '/settings/globalMembers').set({ 'A': 'ğŸ°', 'B': 'ğŸ»' });
                });
                categoriesRef.on('value', (snapshot) => {
                    const val = snapshot.val();
                    if (val) {
                        const cats = Object.entries(val).map(([id, cat]) => ({ id, ...cat }));
                        setCustomCategories(cats);
                    } else setCustomCategories([]);
                });
                deletedRef.on('value', (snapshot) => {
                    const val = snapshot.val();
                    if (val) {
                        const now = Date.now();
                        const thirtyDays = 30 * 24 * 60 * 60 * 1000;
                        const validBooks = {};
                        Object.entries(val).forEach(([id, book]) => {
                            if (now - book.deletedAt < thirtyDays) validBooks[id] = book;
                            else { db.ref('users/' + userId + '/deletedBooks/' + id).remove(); db.ref('users/' + userId + '/deletedBooksData/' + id).remove(); }
                        });
                        setDeletedBooks(validBooks);
                    } else setDeletedBooks({});
                });
                return () => { metaRef.off(); membersRef.off(); deletedRef.off(); categoriesRef.off(); };
            }, [userId, authLoading, isGuest]);

            // ç›£è½çµæ¸…ç‹€æ…‹
            useEffect(() => {
                if (authLoading) return;
                if (!userId && !isGuest) return;

                let clearedPath;
                if (isGuest) {
                    clearedPath = 'publicBooks/' + currentBookId + '/clearedTransactions';
                } else {
                    clearedPath = currentBookId === 'default'
                        ? 'users/' + userId + '/clearedTransactions'
                        : 'users/' + userId + '/books/' + currentBookId + '/clearedTransactions';
                }
                const clearedRef = db.ref(clearedPath);
                clearedRef.on('value', (snapshot) => {
                    const val = snapshot.val();
                    if (val) setClearedTransactions(val);
                    else setClearedTransactions({});
                });
                return () => clearedRef.off();
            }, [currentBookId, userId, authLoading, isGuest]);

            useEffect(() => {
                if (currentBook.currency !== 'TWD' && userId) {
                    fetchExchangeRate(currentBook.currency).then(rate => { if (!currentBook.customRate) db.ref('users/' + userId + '/booksMeta/' + currentBookId).update({ customRate: rate }); });
                }
            }, [currentBookId, currentBook.currency, userId]);

            useEffect(() => {
                if (authLoading) return;
                if (!userId && !isGuest) return;

                setLoading(true);
                localStorage.setItem('lastBookId', currentBookId);

                let txPath, stPath, recurringPath;
                if (isGuest) {
                    txPath = 'publicBooks/' + currentBookId + '/transactions';
                    stPath = 'publicBooks/' + currentBookId + '/settlements';
                    recurringPath = 'publicBooks/' + currentBookId + '/recurring';
                } else {
                    txPath = currentBookId === 'default'
                        ? 'users/' + userId + '/transactions'
                        : 'users/' + userId + '/books/' + currentBookId + '/transactions';
                    stPath = currentBookId === 'default'
                        ? 'users/' + userId + '/settlements'
                        : 'users/' + userId + '/books/' + currentBookId + '/settlements';
                    recurringPath = currentBookId === 'default'
                        ? 'users/' + userId + '/recurring'
                        : 'users/' + userId + '/books/' + currentBookId + '/recurring';
                }

                const txRef = db.ref(txPath);
                const stRef = db.ref(stPath);
                const handleTx = (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        const list = Object.keys(data).map(key => ({ id: key, ...data[key] }));
                        list.sort((a, b) => sortNewestFirst ? new Date(b.date) - new Date(a.date) : new Date(a.date) - new Date(b.date));
                        const processed = list.map(tx => ({ ...tx, involved: tx.involved || bookMembers, splitType: tx.splitType || 'equal', customAmounts: tx.customAmounts || {}, amountTWD: Math.round(tx.amount * (tx.exchangeRate || activeRate)), category: tx.category || 'other', txType: tx.txType || 'expense' }));
                        setTransactions(processed);
                    } else setTransactions([]);
                    setLoading(false);
                };
                const handleSt = (snapshot) => { const data = snapshot.val(); if (data) { const list = Object.keys(data).map(key => ({ id: key, ...data[key] })); list.sort((a, b) => b.settledAt - a.settledAt); setSettlements(list); } else setSettlements([]); };
                txRef.on('value', handleTx); stRef.on('value', handleSt);
                // Recurring items listener
                const recurringRef = db.ref(recurringPath);
                recurringRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        const list = Object.keys(data).map(key => ({ id: key, ...data[key] }));
                        setRecurringItems(list);
                    } else setRecurringItems([]);
                });
                return () => { txRef.off(); stRef.off(); recurringRef.off(); };
            }, [currentBookId, activeRate, sortNewestFirst, userId, authLoading, isGuest]);

            useEffect(() => {
                if (!userId) return;
                if (isPersonalBook) {
                    const currentMonth = getCurrentMonth();
                    const lastSettleMonth = currentBook.lastSettleMonth;
                    if (lastSettleMonth && lastSettleMonth !== currentMonth && transactions.length > 0) {
                        const lastMonthTxs = transactions.filter(tx => tx.date && tx.date.startsWith(lastSettleMonth));
                        if (lastMonthTxs.length > 0) {
                            const stPath = currentBookId === 'default' ? 'users/' + userId + '/settlements' : 'users/' + userId + '/books/' + currentBookId + '/settlements';
                            const txPath = currentBookId === 'default' ? 'users/' + userId + '/transactions' : 'users/' + userId + '/books/' + currentBookId + '/transactions';
                            let expense = 0, income = 0;
                            lastMonthTxs.forEach(tx => { if (tx.txType === 'income') income += tx.amount; else expense += tx.amount; });
                            db.ref(stPath).push({
                                settledAt: firebase.database.ServerValue.TIMESTAMP,
                                settledDate: lastSettleMonth + '-01',
                                month: lastSettleMonth,
                                totalExpense: expense,
                                totalIncome: income,
                                balance: income - expense,
                                currency: currentBook.currency,
                                transactionsSnapshot: lastMonthTxs,
                                isAutoSettle: true
                            }).then(() => {
                                lastMonthTxs.forEach(tx => db.ref(txPath + '/' + tx.id).remove());
                                db.ref('users/' + userId + '/booksMeta/' + currentBookId).update({ lastSettleMonth: currentMonth });
                            });
                        }
                    }
                    if (!lastSettleMonth) db.ref('users/' + userId + '/booksMeta/' + currentBookId).update({ lastSettleMonth: currentMonth });
                }
            }, [currentBookId, isPersonalBook, transactions, userId]);

            useEffect(() => { if (!sortNewestFirst && bottomRef.current && !loading) bottomRef.current.scrollIntoView({ behavior: 'smooth' }); }, [transactions, loading, sortNewestFirst]);

            // ç®¡ç† modal-open class é˜²æ­¢èƒŒæ™¯æ»¾å‹•
            useEffect(() => {
                const hasModal = isMenuOpen || isMenuSettingsOpen || isAddBookOpen || isMemberManagerOpen || isBookMemberSettingsOpen || isModalOpen || isRateModalOpen || isHistoryOpen || isSettingsOpen || isRecurringListOpen || isRecurringFormOpen || isCategoryEditOpen || isExpenseDetailOpen || isIncomeDetailOpen || isScanOpen || isFilterOpen || isDeletedBooksOpen || viewingSettlement || viewingMemberDebt || viewingFilteredTx;
                if (hasModal) {
                    document.body.classList.add('modal-open');
                } else {
                    document.body.classList.remove('modal-open');
                }
                return () => document.body.classList.remove('modal-open');
            }, [isMenuOpen, isMenuSettingsOpen, isAddBookOpen, isMemberManagerOpen, isBookMemberSettingsOpen, isModalOpen, isRateModalOpen, isHistoryOpen, isSettingsOpen, isRecurringListOpen, isRecurringFormOpen, isCategoryEditOpen, isExpenseDetailOpen, isIncomeDetailOpen, isScanOpen, isFilterOpen, isDeletedBooksOpen, viewingSettlement, viewingMemberDebt, viewingFilteredTx]);

            const getMemberAmountInTx = (tx, memberName) => {
                // æ”¯æ´æ–°æ ¼å¼ customItems
                if (tx.splitType === 'custom' && tx.customItems && tx.customItems[memberName]) {
                    return tx.customItems[memberName].reduce((sum, item) => sum + (parseFloat(item.amount) || 0), 0);
                }
                // å‘å¾Œå…¼å®¹èˆŠæ ¼å¼ customAmounts
                if (tx.splitType === 'custom' && tx.customAmounts) return parseFloat(tx.customAmounts[memberName]) || 0;
                else if (tx.involved && tx.involved.includes(memberName)) return tx.amount / tx.involved.length;
                return 0;
            };

            const getFilteredResults = React.useMemo(() => {
                // å€‹äººå¸³æœ¬ç¯©é¸é‚è¼¯
                if (isPersonalBook) {
                    const hasPersonalFilters = activeFilters.category || activeFilters.txType || (activeFilters.dateType && activeFilters.dateType !== 'none');
                    if (!hasPersonalFilters) return [];

                    let result = [...transactions];

                    // æ—¥æœŸç¯©é¸
                    if (activeFilters.dateType === 'range' && activeFilters.startDate && activeFilters.endDate) {
                        result = result.filter(tx => {
                            const txDate = new Date(tx.date);
                            const start = new Date(activeFilters.startDate);
                            const end = new Date(activeFilters.endDate);
                            return txDate >= start && txDate <= end;
                        });
                    } else if (activeFilters.dateType === 'single' && activeFilters.singleDate) {
                        result = result.filter(tx => tx.date === activeFilters.singleDate);
                    }

                    // é¡åˆ¥ç¯©é¸
                    if (activeFilters.category) {
                        result = result.filter(tx => tx.category === activeFilters.category);
                    }

                    // é¡å‹ç¯©é¸ (æ”¶å…¥/æ”¯å‡º)
                    if (activeFilters.txType) {
                        result = result.filter(tx => tx.txType === activeFilters.txType);
                    }

                    return result;
                }

                // åœ˜é«”å¸³æœ¬ç¯©é¸é‚è¼¯ (åŸæœ‰)
                if (!activeFilters.payer && !activeFilters.payee) return [];
                let result = [...transactions];
                if (activeFilters.dateType === 'range' && activeFilters.startDate && activeFilters.endDate) {
                    result = result.filter(tx => { const txDate = new Date(tx.date); const start = new Date(activeFilters.startDate); const end = new Date(activeFilters.endDate); return txDate >= start && txDate <= end; });
                } else if (activeFilters.dateType === 'single' && activeFilters.singleDate) {
                    result = result.filter(tx => tx.date === activeFilters.singleDate);
                }
                if (activeFilters.payer) result = result.filter(tx => tx.payer === activeFilters.payer);
                if (activeFilters.payee) result = result.filter(tx => { const payeeAmount = getMemberAmountInTx(tx, activeFilters.payee); return payeeAmount > 0; });
                return result.map(tx => { const payeeAmount = activeFilters.payee ? getMemberAmountInTx(tx, activeFilters.payee) : tx.amount; return { ...tx, paidForAmount: payeeAmount, payee: activeFilters.payee || '(å…¨éƒ¨)' }; });
            }, [transactions, activeFilters, isPersonalBook]);

            const hasActiveFilters = isPersonalBook
                ? (activeFilters.category || activeFilters.txType || (activeFilters.dateType && activeFilters.dateType !== 'none'))
                : (activeFilters.payer || activeFilters.payee || (activeFilters.dateType && activeFilters.dateType !== 'none'));

            const toggleLang = () => setLang(l => l === 'zh' ? 'en' : 'zh');
            const handleAddGlobalMember = () => { if (!newMemberName.trim() || !userId) return; db.ref('users/' + userId + '/settings/globalMembers/' + newMemberName.trim()).set(newMemberAvatar); setNewMemberName(''); };
            const startEditGlobalMember = (name, avatar) => { setEditingGlobalMember(name); setEditMemberName(name); setEditMemberAvatar(avatar); };
            const saveGlobalMember = () => { if (!editMemberName.trim() || !userId) return; if (editMemberName !== editingGlobalMember) db.ref('users/' + userId + '/settings/globalMembers/' + editingGlobalMember).remove(); db.ref('users/' + userId + '/settings/globalMembers/' + editMemberName.trim()).set(editMemberAvatar); setEditingGlobalMember(null); };
            const handleDeleteGlobalMember = (name) => { if (!userId) return; if (confirm(t.confirm_delete)) db.ref('users/' + userId + '/settings/globalMembers/' + name).remove(); };
            const toggleBookMember = (member) => { if (!userId) return; const isIncluded = bookMembers.includes(member); let newMembers; if (isIncluded) { if (bookMembers.length <= 2) return alert(t.alert_min_members); newMembers = bookMembers.filter(m => m !== member); } else { newMembers = [...bookMembers, member]; } db.ref('users/' + userId + '/booksMeta/' + currentBookId).update({ members: newMembers }); };

            // Recurring transactions functions
            const openRecurringForm = (item = null) => {
                if (item) {
                    setEditingRecurring(item.id);
                    setRecurringForm({
                        name: item.name || '', amount: item.amount || '', txType: item.txType || 'expense',
                        intervalType: item.intervalType || 'month', intervalValue: item.intervalValue || 1,
                        category: item.category || 'other', startDate: item.startDate || new Date().toISOString().split('T')[0],
                        endDate: item.endDate || '', isPermanent: !item.endDate,
                        payer: item.payer || bookMembers[0], involved: item.involved || bookMembers
                    });
                } else {
                    setEditingRecurring(null);
                    setRecurringForm({
                        name: '', amount: '', txType: 'expense', intervalType: 'month', intervalValue: 1,
                        category: 'other', startDate: new Date().toISOString().split('T')[0], endDate: '', isPermanent: true,
                        payer: isPersonalBook ? currentBook.owner : bookMembers[0], involved: isPersonalBook ? [currentBook.owner] : bookMembers
                    });
                }
                setIsRecurringFormOpen(true);
            };
            const saveRecurring = () => {
                if (!recurringForm.name.trim() || !recurringForm.amount || !userId) return alert(t.alert_input);
                const recurringPath = currentBookId === 'default'
                    ? 'users/' + userId + '/recurring'
                    : 'users/' + userId + '/books/' + currentBookId + '/recurring';
                const data = {
                    name: recurringForm.name.trim(),
                    amount: parseFloat(recurringForm.amount),
                    txType: recurringForm.txType,
                    intervalType: recurringForm.intervalType,
                    intervalValue: parseInt(recurringForm.intervalValue),
                    startDate: recurringForm.startDate,
                    endDate: recurringForm.isPermanent ? null : recurringForm.endDate,
                    isActive: true,
                    lastGenerated: null,
                    createdAt: firebase.database.ServerValue.TIMESTAMP
                };
                if (isPersonalBook) {
                    data.category = recurringForm.category;
                    data.payer = currentBook.owner;
                    data.involved = [currentBook.owner];
                } else {
                    data.payer = recurringForm.payer;
                    data.involved = recurringForm.involved;
                }
                if (editingRecurring) {
                    db.ref(recurringPath + '/' + editingRecurring).update(data);
                } else {
                    db.ref(recurringPath).push(data);
                }
                setIsRecurringFormOpen(false);
                setEditingRecurring(null);
            };
            const deleteRecurring = (id) => {
                if (!confirm(t.confirm_delete_recurring) || !userId) return;
                const recurringPath = currentBookId === 'default'
                    ? 'users/' + userId + '/recurring'
                    : 'users/' + userId + '/books/' + currentBookId + '/recurring';
                db.ref(recurringPath + '/' + id).remove();
            };
            const toggleRecurringActive = (id, currentActive) => {
                if (!userId) return;
                const recurringPath = currentBookId === 'default'
                    ? 'users/' + userId + '/recurring'
                    : 'users/' + userId + '/books/' + currentBookId + '/recurring';
                db.ref(recurringPath + '/' + id).update({ isActive: !currentActive });
            };
            const getIntervalLabel = (item) => {
                const typeLabels = { day: t.interval_day, month: t.interval_month, year: t.interval_year };
                return `${t.every} ${item.intervalValue} ${typeLabels[item.intervalType]} ${t.repeat_once}`;
            };
            // Generate recurring transactions
            useEffect(() => {
                if (!recurringItems.length || loading || !userId) return;
                const today = new Date().toISOString().split('T')[0];
                const txPath = currentBookId === 'default' ? 'users/' + userId + '/transactions' : 'users/' + userId + '/books/' + currentBookId + '/transactions';
                const recurringPath = currentBookId === 'default' ? 'users/' + userId + '/recurring' : 'users/' + userId + '/books/' + currentBookId + '/recurring';

                recurringItems.forEach(item => {
                    if (!item.isActive) return;
                    if (item.endDate && item.endDate < today) return;
                    if (item.startDate > today) return;

                    let shouldGenerate = false;
                    let nextDate = item.lastGenerated ? new Date(item.lastGenerated) : new Date(item.startDate);

                    if (!item.lastGenerated) {
                        shouldGenerate = true;
                        nextDate = new Date(item.startDate);
                    } else {
                        // Calculate next generation date
                        if (item.intervalType === 'day') nextDate.setDate(nextDate.getDate() + item.intervalValue);
                        else if (item.intervalType === 'month') nextDate.setMonth(nextDate.getMonth() + item.intervalValue);
                        else if (item.intervalType === 'year') nextDate.setFullYear(nextDate.getFullYear() + item.intervalValue);

                        if (nextDate <= new Date(today)) shouldGenerate = true;
                    }

                    if (shouldGenerate) {
                        const txData = {
                            date: nextDate.toISOString().split('T')[0],
                            description: item.name,
                            amount: item.amount,
                            payer: item.payer,
                            involved: item.involved,
                            splitType: 'equal',
                            currency: currentBook.currency,
                            exchangeRate: activeRate,
                            createdAt: firebase.database.ServerValue.TIMESTAMP,
                            isRecurring: true,
                            recurringId: item.id
                        };
                        if (isPersonalBook) {
                            txData.category = item.category;
                            txData.txType = item.txType;
                        }
                        db.ref(txPath).push(txData);
                        db.ref(recurringPath + '/' + item.id).update({ lastGenerated: nextDate.toISOString().split('T')[0] });
                    }
                });
            }, [recurringItems, currentBookId, loading]);

            const openAddBookModal = () => { setAddBookStep(1); setNewBookType('shared'); setNewBookName(''); setNewBookCurrency('TWD'); setNewBookOwner(''); setSelectedMembers([]); setIsAddBookOpen(true); };

            const handleCreateBook = () => {
                if (!newBookName || !userId) return alert(t.alert_input);
                if (newBookType === 'shared' && selectedMembers.length < 2) return alert(t.alert_min_members);
                if (newBookType === 'personal' && !newBookOwner) return alert(t.alert_input);
                const newId = 'book_' + Date.now();
                const bookData = {
                    name: newBookName,
                    currency: newBookCurrency,
                    customRate: newBookCurrency === 'TWD' ? 1 : FALLBACK_RATES[newBookCurrency] || 1,
                    isPersonal: newBookType === 'personal',
                    createdAt: Date.now()
                };
                if (newBookType === 'personal') {
                    bookData.owner = newBookOwner;
                    bookData.members = [newBookOwner];
                    bookData.lastSettleMonth = getCurrentMonth();
                } else {
                    bookData.members = selectedMembers;
                }
                fetchExchangeRate(newBookCurrency).then(rate => {
                    bookData.customRate = rate;
                    db.ref('users/' + userId + '/booksMeta/' + newId).set(bookData).then(() => {
                        setCurrentBookId(newId);
                        setIsAddBookOpen(false);
                        setIsMenuOpen(false);
                    });
                });
            };

            const toggleMemberSelection = (member) => { if (selectedMembers.includes(member)) setSelectedMembers(selectedMembers.filter(m => m !== member)); else setSelectedMembers([...selectedMembers, member]); };

            const handleDeleteBook = (bookId, e) => {
                e.stopPropagation();
                if (bookId === 'default' || !userId) return alert('Default ledger cannot be deleted.');
                if (confirm(t.confirm_delete)) {
                    const bookMeta = booksMeta[bookId];
                    db.ref('users/' + userId + '/deletedBooks/' + bookId).set({ ...bookMeta, deletedAt: Date.now() });
                    db.ref('users/' + userId + '/books/' + bookId).once('value', snapshot => { const bookData = snapshot.val(); if (bookData) db.ref('users/' + userId + '/deletedBooksData/' + bookId).set(bookData); });
                    db.ref('users/' + userId + '/booksMeta/' + bookId).remove();
                    db.ref('users/' + userId + '/books/' + bookId).remove();
                    if (currentBookId === bookId) setCurrentBookId('default');
                }
            };

            const handleRestoreBook = (bookId) => {
                if (!confirm(t.confirm_restore) || !userId) return;
                const bookMeta = deletedBooks[bookId];
                if (!bookMeta) return;
                const { deletedAt, ...restoreMeta } = bookMeta;
                db.ref('users/' + userId + '/booksMeta/' + bookId).set(restoreMeta);
                db.ref('users/' + userId + '/deletedBooksData/' + bookId).once('value', snapshot => { const bookData = snapshot.val(); if (bookData) db.ref('users/' + userId + '/books/' + bookId).set(bookData); });
                db.ref('users/' + userId + '/deletedBooks/' + bookId).remove();
                db.ref('users/' + userId + '/deletedBooksData/' + bookId).remove();
                setIsDeletedBooksOpen(false);
            };

            const handlePermanentDeleteBook = (bookId, e) => {
                e.stopPropagation();
                if (!confirm(t.confirm_perm_delete) || !userId) return;
                db.ref('users/' + userId + '/deletedBooks/' + bookId).remove();
                db.ref('users/' + userId + '/deletedBooksData/' + bookId).remove();
            };

            const getDaysLeft = (deletedAt) => {
                const now = Date.now();
                const thirtyDays = 30 * 24 * 60 * 60 * 1000;
                const remaining = thirtyDays - (now - deletedAt);
                return Math.max(0, Math.ceil(remaining / (24 * 60 * 60 * 1000)));
            };

            const startEditBook = (id, currentName, e) => { e.stopPropagation(); setEditingBookId(id); setTempBookName(currentName); };
            const saveBookName = (id, e) => { e.stopPropagation(); if (!tempBookName.trim() || !userId) return; db.ref('users/' + userId + '/booksMeta/' + id).update({ name: tempBookName }); setEditingBookId(null); };
            const handleUpdateGlobalRate = () => { if (!newRate || !userId) return; const rate = parseFloat(newRate); db.ref('users/' + userId + '/booksMeta/' + currentBookId).update({ customRate: rate }); if (confirm(t.confirm_update + "?")) { const path = currentBookId === 'default' ? 'users/' + userId + '/transactions' : 'users/' + userId + '/books/' + currentBookId + '/transactions'; const updates = {}; transactions.forEach(tx => { updates[path + '/' + tx.id + '/exchangeRate'] = rate; updates[path + '/' + tx.id + '/amountTWD'] = Math.round(tx.amount * rate); }); if (Object.keys(updates).length > 0) db.ref().update(updates); } setIsRateModalOpen(false); };
            const handleRefreshRate = async () => { const rate = await fetchExchangeRate(currentBook.currency); setNewRate(rate); alert(t.fetched_rate + ': ' + rate); };

            const handleSave = () => {
                if (!formData.description || (!userId && !isGuest)) return alert(t.alert_input);

                // Determine the path based on mode
                let path;
                if (isGuest) {
                    path = 'publicBooks/' + currentBookId + '/transactions';
                } else if (isPersonalBook) {
                    path = 'users/' + userId + '/books/' + currentBookId + '/transactions';
                } else {
                    path = currentBookId === 'default'
                        ? 'users/' + userId + '/transactions'
                        : 'users/' + userId + '/books/' + currentBookId + '/transactions';
                }

                if (isPersonalBook) {
                    if (!formData.amount) return alert(t.alert_input);
                    const amount = parseFloat(formData.amount);
                    const rate = formData.exchangeRate ? parseFloat(formData.exchangeRate) : activeRate;
                    const payload = {
                        date: formData.date,
                        description: formData.description,
                        amount: amount,
                        currency: currentBook.currency,
                        exchangeRate: rate,
                        amountTWD: Math.round(amount * rate),
                        category: formData.category,
                        txType: formData.txType,
                        payer: currentBook.owner
                    };
                    if (editingId) db.ref(path).child(editingId).update(payload);
                    else db.ref(path).push({ ...payload, createdAt: firebase.database.ServerValue.TIMESTAMP });
                } else {
                    if (!formData.payer) return alert(t.alert_input);
                    if (formData.involved.length === 0) return alert(t.alert_input);
                    let totalAmount = 0;
                    if (formData.splitType === 'equal') { if (!formData.amount) return alert(t.alert_input); totalAmount = parseFloat(formData.amount); }
                    else { totalAmount = calculateCustomTotal(); if (totalAmount <= 0) return alert(t.alert_input); }
                    const rate = formData.exchangeRate ? parseFloat(formData.exchangeRate) : activeRate;
                    const payload = { ...formData, amount: totalAmount, currency: currentBook.currency, exchangeRate: rate, amountTWD: Math.round(totalAmount * rate), customItems: formData.splitType === 'custom' ? formData.customItems : {} };
                    if (editingId) db.ref(path).child(editingId).update(payload);
                    else db.ref(path).push({ ...payload, createdAt: firebase.database.ServerValue.TIMESTAMP });
                }
                closeModal();
            };

            const handleDelete = (id) => {
                if (confirm(t.confirm_delete)) {
                    let path;
                    if (isGuest) {
                        path = 'publicBooks/' + currentBookId + '/transactions';
                    } else {
                        path = currentBookId === 'default'
                            ? 'users/' + userId + '/transactions'
                            : 'users/' + userId + '/books/' + currentBookId + '/transactions';
                    }
                    db.ref(path).child(id).remove();
                }
            };

            const handleSettleUp = () => {
                if (transactions.length === 0 || !userId) return;
                if (!confirm(t.confirm_settle)) return;
                const stPath = currentBookId === 'default' ? 'users/' + userId + '/settlements' : 'users/' + userId + '/books/' + currentBookId + '/settlements';
                const txPath = currentBookId === 'default' ? 'users/' + userId + '/transactions' : 'users/' + userId + '/books/' + currentBookId + '/transactions';
                if (isPersonalBook) {
                    const stats = getMonthlyStats();
                    db.ref(stPath).push({
                        settledAt: firebase.database.ServerValue.TIMESTAMP,
                        settledDate: new Date().toISOString().split('T')[0],
                        month: getCurrentMonth(),
                        totalExpense: stats.totalExpense,
                        totalIncome: stats.totalIncome,
                        balance: stats.balance,
                        currency: currentBook.currency,
                        transactionsSnapshot: transactions
                    }).then(() => { db.ref(txPath).remove(); });
                } else {
                    const totalSpent = transactions.reduce((sum, tx) => sum + tx.amount, 0);
                    db.ref(stPath).push({ settledAt: firebase.database.ServerValue.TIMESTAMP, settledDate: new Date().toISOString().split('T')[0], totalAmount: totalSpent, currency: currentBook.currency, finalResult: t.settled, transactionsSnapshot: transactions }).then(() => { db.ref(txPath).remove(); });
                }
            };

            const closeModal = () => { setIsModalOpen(false); setEditingId(null); setFormData({ date: new Date().toISOString().split('T')[0], description: '', amount: '', exchangeRate: '', payer: bookMembers[0], involved: [], splitType: 'equal', customItems: {}, category: 'other', txType: 'expense' }); };

            // å‘å¾Œå…¼å®¹ï¼šå°‡èˆŠæ ¼å¼è½‰æ›ç‚ºæ–°æ ¼å¼
            const convertLegacyCustomFormat = (tx) => {
                if (tx.customItems) return tx.customItems;
                if (tx.customAmounts || tx.customItemNames) {
                    const items = {};
                    Object.keys(tx.customAmounts || {}).forEach(m => {
                        items[m] = [{ name: (tx.customItemNames && tx.customItemNames[m]) || '', amount: parseFloat(tx.customAmounts[m]) || 0 }];
                    });
                    return items;
                }
                return {};
            };

            const openModal = (t_item = null) => {
                if (t_item) {
                    const customItems = convertLegacyCustomFormat(t_item);
                    setFormData({ date: t_item.date, description: t_item.description, amount: t_item.amount, payer: t_item.payer, exchangeRate: t_item.exchangeRate || activeRate, involved: t_item.involved || bookMembers, splitType: t_item.splitType || 'equal', customItems: customItems, category: t_item.category || 'other', txType: t_item.txType || 'expense' });
                    setEditingId(t_item.id);
                } else {
                    setFormData({ date: new Date().toISOString().split('T')[0], description: '', amount: '', payer: isPersonalBook ? currentBook.owner : bookMembers[0], exchangeRate: activeRate, involved: isPersonalBook ? [currentBook.owner] : bookMembers, splitType: 'equal', customItems: {}, category: 'other', txType: 'expense' });
                }
                setIsModalOpen(true);
            };

            const openRateModal = () => { setNewRate(activeRate); setIsRateModalOpen(true); };
            const toggleInvolvedMember = (m) => { const current = formData.involved || []; let newInvolved; let newCustomItems = { ...formData.customItems }; if (current.includes(m)) { newInvolved = current.filter(x => x !== m); delete newCustomItems[m]; } else { newInvolved = [...current, m]; if (formData.splitType === 'custom') { newCustomItems[m] = [{ name: '', amount: '' }]; } } setFormData({ ...formData, involved: newInvolved, customItems: newCustomItems }); };
            const handleSplitTypeChange = (type) => { const newCustomItems = {}; if (type === 'custom') formData.involved.forEach(m => { newCustomItems[m] = [{ name: '', amount: '' }]; }); setFormData({ ...formData, splitType: type, customItems: newCustomItems }); };
            // æ–°å¢é …ç›®
            const addCustomItem = (member) => { const items = formData.customItems[member] || []; setFormData({ ...formData, customItems: { ...formData.customItems, [member]: [...items, { name: '', amount: '' }] } }); };
            // åˆªé™¤é …ç›®
            const removeCustomItem = (member, index) => { const items = [...(formData.customItems[member] || [])]; items.splice(index, 1); if (items.length === 0) items.push({ name: '', amount: '' }); setFormData({ ...formData, customItems: { ...formData.customItems, [member]: items } }); };
            // æ›´æ–°é …ç›®
            const updateCustomItem = (member, index, field, value) => { const items = [...(formData.customItems[member] || [])]; items[index] = { ...items[index], [field]: value }; setFormData({ ...formData, customItems: { ...formData.customItems, [member]: items } }); };
            // è¨ˆç®—æˆå“¡å°è¨ˆ
            const getMemberCustomTotal = (member) => (formData.customItems[member] || []).reduce((sum, item) => sum + (parseFloat(item.amount) || 0), 0);
            // è¨ˆç®—ç¸½é¡
            const calculateCustomTotal = () => Object.values(formData.customItems).reduce((sum, items) => sum + items.reduce((s, item) => s + (parseFloat(item.amount) || 0), 0), 0);

            // å€‹äººå¸³æœ¬ç¯©é¸
            const applyFilters = () => {
                if (isPersonalBook) {
                    setActiveFilters({
                        dateType: filterDateType,
                        startDate: filterStartDate,
                        endDate: filterEndDate,
                        singleDate: filterSingleDate,
                        category: filterCategory,
                        txType: filterType
                    });
                } else {
                    setActiveFilters({
                        dateType: filterDateType,
                        startDate: filterStartDate,
                        endDate: filterEndDate,
                        singleDate: filterSingleDate,
                        payer: filterPayer,
                        payee: filterPayee
                    });
                }
                setIsFilterOpen(false);
            };
            const clearFilters = () => {
                setFilterDateType('none');
                setFilterStartDate('');
                setFilterEndDate('');
                setFilterSingleDate('');
                setFilterPayer('');
                setFilterPayee('');
                setFilterCategory('');
                setFilterType('');
                setActiveFilters({});
                setIsFilterOpen(false);
            };

            // çµæ¸…/å–æ¶ˆçµæ¸…äº¤æ˜“
            const toggleClearTransaction = (txId, me, other) => {
                if (!userId) return;
                const clearedPath = currentBookId === 'default'
                    ? 'users/' + userId + '/clearedTransactions'
                    : 'users/' + userId + '/books/' + currentBookId + '/clearedTransactions';
                const clearKey = `${txId}_${me}_${other}`;
                const reverseKey = `${txId}_${other}_${me}`;

                if (clearedTransactions[clearKey] || clearedTransactions[reverseKey]) {
                    // å–æ¶ˆçµæ¸…
                    db.ref(clearedPath + '/' + clearKey).remove();
                    db.ref(clearedPath + '/' + reverseKey).remove();
                } else {
                    // çµæ¸…
                    const clearData = {
                        clearedAt: firebase.database.ServerValue.TIMESTAMP,
                        clearedBy: me,
                        parties: [me, other]
                    };
                    db.ref(clearedPath + '/' + clearKey).set(clearData);
                    db.ref(clearedPath + '/' + reverseKey).set(clearData);
                }
            };

            // çµæ¸…æŸç­†äº¤æ˜“
            const clearTransaction = (txId, me, other) => {
                if (!userId) return;
                const clearedPath = currentBookId === 'default'
                    ? 'users/' + userId + '/clearedTransactions'
                    : 'users/' + userId + '/books/' + currentBookId + '/clearedTransactions';
                const clearKey = `${txId}_${me}_${other}`;
                const reverseKey = `${txId}_${other}_${me}`;
                const clearData = {
                    clearedAt: firebase.database.ServerValue.TIMESTAMP,
                    clearedBy: me,
                    parties: [me, other]
                };
                db.ref(clearedPath + '/' + clearKey).set(clearData);
                db.ref(clearedPath + '/' + reverseKey).set(clearData);
            };

            // å–æ¶ˆçµæ¸…æŸç­†äº¤æ˜“
            const unclearTransaction = (txId, me, other) => {
                if (!userId) return;
                const clearedPath = currentBookId === 'default'
                    ? 'users/' + userId + '/clearedTransactions'
                    : 'users/' + userId + '/books/' + currentBookId + '/clearedTransactions';
                const clearKey = `${txId}_${me}_${other}`;
                const reverseKey = `${txId}_${other}_${me}`;
                db.ref(clearedPath + '/' + clearKey).remove();
                db.ref(clearedPath + '/' + reverseKey).remove();
            };

            // æ•´ç­†çµæ¸…ï¼ˆçµæ¸…å…©äººä¹‹é–“æ‰€æœ‰æœªçµæ¸…çš„äº¤æ˜“ï¼‰
            const clearAllBetweenTwo = (me, other) => {
                const details = getDetailBetweenTwo(me, other);
                details.forEach(item => {
                    if (!isTransactionCleared(item.id, me, other)) {
                        clearTransaction(item.id, me, other);
                    }
                });
            };

            // å–æ¶ˆæ•´ç­†çµæ¸…
            const unclearAllBetweenTwo = (me, other) => {
                const details = getDetailBetweenTwo(me, other);
                details.forEach(item => {
                    if (isTransactionCleared(item.id, me, other)) {
                        unclearTransaction(item.id, me, other);
                    }
                });
            };

            // æª¢æŸ¥å…©äººä¹‹é–“æ˜¯å¦å…¨éƒ¨å·²çµæ¸…
            const isAllClearedBetweenTwo = (me, other) => {
                const details = getDetailBetweenTwo(me, other);
                if (details.length === 0) return false;
                return details.every(item => isTransactionCleared(item.id, me, other));
            };

            // è¨ˆç®—å…©äººä¹‹é–“å·²çµæ¸…çš„é‡‘é¡
            const getClearedAmountBetweenTwo = (me, other) => {
                const details = getDetailBetweenTwo(me, other);
                let clearedAmount = 0;
                details.forEach(item => {
                    if (isTransactionCleared(item.id, me, other)) {
                        if (item.isPositive) {
                            clearedAmount += item.amount;
                        } else {
                            clearedAmount -= item.amount;
                        }
                    }
                });
                return clearedAmount;
            };

            const isTransactionCleared = (txId, me, other) => {
                const clearKey = `${txId}_${me}_${other}`;
                const reverseKey = `${txId}_${other}_${me}`;
                return !!(clearedTransactions[clearKey] || clearedTransactions[reverseKey]);
            };

            // ä¸Šå‚³è‡ªè¨‚åœ–ç¤º
            const handleIconUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                // æª¢æŸ¥æª”æ¡ˆå¤§å° (æœ€å¤§ 100KB)
                if (file.size > 100 * 1024) {
                    alert('åœ–ç‰‡æª”æ¡ˆéå¤§ï¼Œè«‹é¸æ“‡å°æ–¼ 100KB çš„åœ–ç‰‡');
                    return;
                }

                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        // ç¸®å°åœ–ç‰‡åˆ° 64x64
                        const canvas = document.createElement('canvas');
                        canvas.width = 64;
                        canvas.height = 64;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, 64, 64);
                        const dataUrl = canvas.toDataURL('image/png', 0.8);
                        setCustomIconUrl(dataUrl);
                        setNewCategoryIcon('custom');
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            };

            const totalSpent = transactions.reduce((sum, tx) => sum + tx.amount, 0);

            // Scan functions
            const startCamera = async () => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                    streamRef.current = stream;
                    if (videoRef.current) {
                        videoRef.current.srcObject = stream;
                        videoRef.current.play();
                    }
                    setScanMode('camera');
                } catch (err) {
                    alert('ç„¡æ³•å­˜å–ç›¸æ©Ÿ');
                    console.error(err);
                }
            };

            const stopCamera = () => {
                if (streamRef.current) {
                    streamRef.current.getTracks().forEach(track => track.stop());
                    streamRef.current = null;
                }
            };

            const capturePhoto = () => {
                if (!videoRef.current) return;
                const canvas = document.createElement('canvas');
                canvas.width = videoRef.current.videoWidth;
                canvas.height = videoRef.current.videoHeight;
                canvas.getContext('2d').drawImage(videoRef.current, 0, 0);
                const imageData = canvas.toDataURL('image/jpeg');
                setCapturedImage(imageData);
                setPreviewImage(imageData);
                stopCamera();
                setScanMode('preview');
            };

            const handleFileSelect = (e) => {
                const files = Array.from(e.target.files);
                if (files.length === 0) return;
                const file = files[0];
                const reader = new FileReader();
                reader.onload = (event) => {
                    setPreviewImage(event.target.result);
                    setScanMode('preview');
                };
                reader.readAsDataURL(file);
            };

            const retakePhoto = () => {
                setCapturedImage(null);
                setPreviewImage(null);
                setPromptInput('');
                setScanMode(null);
            };

            const cancelScan = () => {
                stopCamera();
                setCapturedImage(null);
                setPreviewImage(null);
                setPromptInput('');
                setScanMode(null);
                setIsScanOpen(false);
            };

            const startAnalysis = () => {
                if (!previewImage) return;
                processImageDirectly(previewImage, promptInput);
            };

            const parseDate = (dateStr) => {
                const months = { 'jan': '01', 'feb': '02', 'mar': '03', 'apr': '04', 'may': '05', 'jun': '06', 'jul': '07', 'aug': '08', 'sep': '09', 'oct': '10', 'nov': '11', 'dec': '12' };

                // Format: Sat 15 Nov 2025 or Mon 01 Dec 2025
                const dayMonthYearMatch = dateStr.toLowerCase().match(/\w+\s+(\d{1,2})\s+(\w{3})\s+(\d{4})/);
                if (dayMonthYearMatch) {
                    const [, d, mon, y] = dayMonthYearMatch;
                    const m = months[mon] || '01';
                    return `${y}/${m.padStart(2, '0')}/${d.padStart(2, '0')}`;
                }

                // Format: 15/11/2025 or 15-11-2025
                let match = dateStr.match(/(\d{1,2})\s*[\/\-\.]\s*(\d{1,2})\s*[\/\-\.]\s*(\d{2,4})/);
                if (match) {
                    let [, d, m, y] = match;
                    if (y.length === 2) y = '20' + y;
                    return `${y}/${m.padStart(2, '0')}/${d.padStart(2, '0')}`;
                }

                // Format: 2025/11/15 or 2025-11-15
                match = dateStr.match(/(\d{4})\s*[\/\-\.]\s*(\d{1,2})\s*[\/\-\.]\s*(\d{1,2})/);
                if (match) {
                    let [, y, m, d] = match;
                    return `${y}/${m.padStart(2, '0')}/${d.padStart(2, '0')}`;
                }

                // Format: Nov 15, 2025
                const monthMatch = dateStr.toLowerCase().match(/(\w{3})\s+(\d{1,2})[\s,]+(\d{4})/);
                if (monthMatch) {
                    const [, mon, d, y] = monthMatch;
                    const m = months[mon] || '01';
                    return `${y}/${m.padStart(2, '0')}/${d.padStart(2, '0')}`;
                }

                return new Date().toISOString().split('T')[0].replace(/-/g, '/');
            };

            const detectCategory = (text, categoryLine = '') => {
                const lowerText = (text + ' ' + categoryLine).toLowerCase();

                // Custom merchant rules (highest priority)
                if (/tangerpay/i.test(lowerText)) return 'laundry';
                if (/qut|queensland university/i.test(lowerText)) return 'education';
                if (/iglu/i.test(lowerText)) return 'accommodation';

                // Direct category name matching from bank apps
                if (/entertainment/i.test(lowerText)) return 'entertainment';
                if (/transfers?\s*[&and]*\s*payments?/i.test(lowerText)) return 'transfers';
                if (/groceries/i.test(lowerText)) return 'groceries';
                if (/transport|vehicle/i.test(lowerText)) return 'vehicle';
                if (/shopping/i.test(lowerText)) return 'shopping';
                if (/health|medical/i.test(lowerText)) return 'health';
                if (/utilities|bills?/i.test(lowerText)) return 'utilities';
                if (/eating\s*out|takeaway|food|dining|restaurant/i.test(lowerText)) return 'food';
                if (/education|university|school|college/i.test(lowerText)) return 'education';
                if (/uncategorised|uncategorized|other/i.test(lowerText)) return 'other';

                // First check exact category name matches (case insensitive) - use allCategories
                for (const cat of [...CATEGORIES, ...customCategories]) {
                    if (lowerText.includes(cat.name_en.toLowerCase()) || lowerText.includes(cat.name_zh.toLowerCase()) || lowerText.includes(cat.id.toLowerCase())) {
                        return cat.id;
                    }
                }
                // Fallback keyword matching
                if (/groceries|supermarket|coles|woolworths|aldi|è¶…å¸‚|æ—¥ç”¨|market|fresh|mart/.test(lowerText)) return 'groceries';
                if (/restaurant|cafe|coffee|food|lunch|dinner|breakfast|é¤|é£²|åƒ|mcdonald|kfc|pizza|burger/.test(lowerText)) return 'food';
                if (/uber|taxi|bus|train|transport|äº¤é€š|æ·é‹|å…¬è»Š|lyft|grab|railway|metro|translink|vehicle/.test(lowerText)) return 'vehicle';
                if (/movie|cinema|game|netflix|å¨›æ¨‚|é›»å½±|spotify|youtube|disney/.test(lowerText)) return 'entertainment';
                if (/shop|store|mall|è³¼ç‰©|amazon|ebay|taobao/.test(lowerText)) return 'shopping';
                if (/pharmacy|doctor|hospital|é†«|è—¥|health|medical|clinic/.test(lowerText)) return 'health';
                if (/electricity|water|gas|internet|æ°´é›»|bill|utility|power/.test(lowerText)) return 'utilities';
                if (/salary|wage|income|è–ª|æ”¶å…¥|payment received|deposit/.test(lowerText)) return 'salary';
                if (/invest|stock|dividend|interest|æŠ•è³‡|åˆ©æ¯/.test(lowerText)) return 'investment';
                if (/transfer|payment|è½‰å¸³|payments/.test(lowerText)) return 'transfers';
                if (/education|university|school|college|å­¸/.test(lowerText)) return 'education';
                if (/laundry|æ´—è¡£/.test(lowerText)) return 'laundry';
                if (/accommodation|ä½å®¿|rent|ç§Ÿ/.test(lowerText)) return 'accommodation';
                return 'other';
            };

            const processImageDirectly = async (imageData, prompt = '') => {
                if (!imageData) return;
                setIsScanning(true);
                setScanMode('processing');
                setPreviewImage(null);
                setPromptInput('');

                try {
                    console.log('Image data type:', typeof imageData);
                    console.log('Image data starts with:', imageData.substring(0, 50));
                    console.log('Image data length:', imageData.length);

                    // Get the current origin for the API URL
                    const apiUrl = window.location.origin + '/api/analyze-image';
                    console.log('Calling API:', apiUrl);

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ image: imageData, prompt: prompt || '' })
                    });

                    console.log('Response status:', response.status);

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('HTTP Error:', response.status, errorText);
                        alert(`âŒ HTTP éŒ¯èª¤: ${response.status}\n${errorText}`);
                        setIsScanning(false);
                        setScanMode(null);
                        setIsScanOpen(false);
                        return;
                    }

                    const data = await response.json();
                    console.log('AI Analysis Result:', data);

                    if (data.error) {
                        console.error('API Error:', data.error, data.details);
                        alert(`âŒ AI API éŒ¯èª¤: ${data.error}\n\n${data.details || ''}\n\nè«‹ç¢ºèª:\n1. GEMINI_API_KEY å·²åœ¨ Cloudflare è¨­å®š\n2. API Key æœ‰æ•ˆ`);
                        setIsScanning(false);
                        setScanMode(null);
                        setIsScanOpen(false);
                        return;
                    }

                    if (data.success && data.transactions && data.transactions.length > 0) {
                        console.log(`âœ… AI (${data.source || 'unknown'}) found ${data.count} transactions`);

                        const path = currentBookId === 'default' ? 'transactions' : 'books/' + currentBookId + '/transactions';
                        let savedCount = 0;

                        for (const tx of data.transactions) {
                            const payload = {
                                date: tx.date,
                                description: tx.description,
                                amount: tx.amount,
                                currency: currentBook.currency,
                                exchangeRate: activeRate,
                                amountTWD: Math.round(tx.amount * activeRate),
                                category: tx.category,
                                txType: tx.txType,
                                payer: isPersonalBook ? currentBook.owner : bookMembers[0],
                                involved: isPersonalBook ? [currentBook.owner] : bookMembers,
                                splitType: 'equal',
                                createdAt: firebase.database.ServerValue.TIMESTAMP
                            };
                            await db.ref(path).push(payload);
                            savedCount++;
                        }

                        setIsScanOpen(false);
                        setScanMode(null);
                        setCapturedImage(null);
                        setIsScanning(false);
                        alert(`âœ… æˆåŠŸåŒ¯å…¥ ${savedCount} ç­†äº¤æ˜“è¨˜éŒ„\n(ä¾†æº: ${data.source || 'AI'})`);
                    } else {
                        console.log('AI found no transactions, source:', data.source);
                        alert('âš ï¸ AI æœªèƒ½è­˜åˆ¥ä»»ä½•äº¤æ˜“\n\nå¯èƒ½åŸå› :\n1. åœ–ç‰‡ä¸æ¸…æ™°\n2. äº¤æ˜“è¢«é®æ“‹\n3. åœ–ç‰‡æ ¼å¼ä¸æ”¯æ´');
                        setIsScanning(false);
                        setScanMode(null);
                        setIsScanOpen(false);
                    }
                } catch (err) {
                    console.error('Fetch Error:', err);
                    console.error('Error stack:', err.stack);
                    alert(`âŒ é€£ç·šéŒ¯èª¤: ${err.message}\n\nè«‹é–‹å•Ÿé–‹ç™¼è€…å·¥å…· Console æŸ¥çœ‹è©³ç´°éŒ¯èª¤`);
                    setIsScanning(false);
                    setScanMode(null);
                    setIsScanOpen(false);
                }
            };

            // Fallback OCR function using Tesseract.js - also directly saves to DB
            const processImageWithOCR = async (imageData) => {
                try {
                    const result = await Tesseract.recognize(imageData, 'eng+chi_tra', { logger: m => console.log(m) });
                    const text = result.data.text;
                    console.log('OCR Result:', text);

                    const lines = text.split('\n').filter(l => l.trim());
                    const results = [];
                    const currentYear = new Date().getFullYear();
                    let currentDate = new Date().toISOString().split('T')[0];

                    const months = { 'jan': '01', 'feb': '02', 'mar': '03', 'apr': '04', 'may': '05', 'jun': '06', 'jul': '07', 'aug': '08', 'sep': '09', 'oct': '10', 'nov': '11', 'dec': '12' };

                    for (let i = 0; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (!line) continue;

                        const dateMatch = line.match(/^(Mon|Tue|Wed|Thu|Fri|Sat|Sun)\s+(\d{1,2})\s+(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)/i);
                        if (dateMatch) {
                            const day = dateMatch[2].padStart(2, '0');
                            const month = months[dateMatch[3].toLowerCase()];
                            const yearMatch = line.match(/\b(20\d{2})\b/);
                            const year = yearMatch ? yearMatch[1] : currentYear;
                            currentDate = `${year}-${month}-${day}`;
                            continue;
                        }

                        const amountMatch = line.match(/(-?)\$\s*([\d,]+\.?\d*)/);
                        if (amountMatch) {
                            const isNegative = amountMatch[1] === '-';
                            const rawAmount = amountMatch[2].replace(/,/g, '');
                            const amount = parseFloat(rawAmount);

                            if (!isNaN(amount) && amount > 0) {
                                let description = '';
                                let categoryLine = '';

                                for (let j = i - 1; j >= 0 && j >= i - 3; j--) {
                                    const prevLine = lines[j].trim();
                                    if (prevLine.match(/^(Mon|Tue|Wed|Thu|Fri|Sat|Sun)\s+\d/i)) break;
                                    if (prevLine.match(/\$[\d,]+\.?\d*/)) continue;
                                    if (prevLine.match(/^\d+\s+days?\s+ago$/i) || prevLine.match(/^Yesterday$/i) || prevLine.match(/^Today$/i)) continue;
                                    if (prevLine.length > 2) { description = prevLine; break; }
                                }

                                if (!description) {
                                    const beforeAmount = line.replace(/(-?)\$\s*[\d,]+\.?\d*/, '').trim();
                                    if (beforeAmount.length > 2) description = beforeAmount;
                                }

                                if (i + 1 < lines.length) {
                                    const nextLine = lines[i + 1].trim();
                                    if (!nextLine.match(/\$[\d,]+\.?\d*/) && !nextLine.match(/^(Mon|Tue|Wed|Thu|Fri|Sat|Sun)\s+\d/i) && !nextLine.match(/^\d+\s+days?\s+ago$/i) && nextLine.length > 2 && nextLine.length < 50) {
                                        categoryLine = nextLine;
                                    }
                                }

                                results.push({
                                    date: currentDate,
                                    description: description || categoryLine || 'Item',
                                    amount: amount,
                                    txType: isNegative ? 'expense' : 'income',
                                    category: detectCategory(description + ' ' + categoryLine, categoryLine)
                                });
                            }
                        }
                    }

                    // Remove duplicates
                    const uniqueResults = results.filter((item, index, self) =>
                        index === self.findIndex(t => t.date === item.date && t.description === item.description && t.amount === item.amount)
                    );

                    if (uniqueResults.length === 0) {
                        alert(t.no_valid_records || 'æœªæ‰¾åˆ°æœ‰æ•ˆçš„äº¤æ˜“è¨˜éŒ„');
                    } else {
                        // Directly save to Firebase
                        const path = currentBookId === 'default' ? 'transactions' : 'books/' + currentBookId + '/transactions';
                        let savedCount = 0;

                        for (const tx of uniqueResults) {
                            const payload = {
                                date: tx.date,
                                description: tx.description,
                                amount: tx.amount,
                                currency: currentBook.currency,
                                exchangeRate: activeRate,
                                amountTWD: Math.round(tx.amount * activeRate),
                                category: tx.category,
                                txType: tx.txType,
                                payer: isPersonalBook ? currentBook.owner : bookMembers[0],
                                involved: isPersonalBook ? [currentBook.owner] : bookMembers,
                                splitType: 'equal',
                                createdAt: firebase.database.ServerValue.TIMESTAMP
                            };
                            await db.ref(path).push(payload);
                            savedCount++;
                        }

                        alert(`âœ… ${t.import_success || 'æˆåŠŸåŒ¯å…¥'} ${savedCount} ${t.records || 'ç­†äº¤æ˜“è¨˜éŒ„'}`);
                    }

                    setIsScanOpen(false);
                    setScanMode(null);
                    setCapturedImage(null);
                } catch (err) {
                    console.error('OCR Error:', err);
                    alert('è¾¨è­˜å¤±æ•—ï¼Œè«‹é‡è©¦');
                }
                setIsScanning(false);
            };

            const saveScanResults = () => {
                const path = currentBookId === 'default' ? 'transactions' : 'books/' + currentBookId + '/transactions';
                scanResults.forEach(item => {
                    if (item.amount > 0) {
                        const payload = {
                            date: item.date,
                            description: item.description,
                            amount: item.amount,
                            currency: currentBook.currency,
                            exchangeRate: activeRate,
                            amountTWD: Math.round(item.amount * activeRate),
                            category: item.category,
                            txType: item.txType,
                            payer: isPersonalBook ? currentBook.owner : bookMembers[0],
                            involved: isPersonalBook ? [currentBook.owner] : bookMembers,
                            splitType: 'equal',
                            createdAt: firebase.database.ServerValue.TIMESTAMP
                        };
                        db.ref(path).push(payload);
                    }
                });
                const validCount = scanResults.filter(item => item.amount > 0).length;
                setScanResults([]);
                setIsScanResultOpen(false);
                setIsScanOpen(false);
                if (validCount > 0) {
                    alert((t.import_success || 'æˆåŠŸåŒ¯å…¥') + ' ' + validCount + ' ' + (t.records || 'ç­†äº¤æ˜“è¨˜éŒ„'));
                }
            };

            const updateScanResult = (index, field, value) => {
                const newResults = [...scanResults];
                newResults[index] = { ...newResults[index], [field]: value };
                setScanResults(newResults);
            };

            const deleteScanResult = (index) => {
                setScanResults(scanResults.filter((_, i) => i !== index));
            };

            const calculateNetBalances = (txList = transactions) => {
                const balances = {};
                bookMembers.forEach(m => balances[m] = 0);
                txList.forEach(tx => {
                    const payer = tx.payer;
                    const amount = tx.amount;
                    if (balances[payer] === undefined) balances[payer] = 0;
                    balances[payer] += amount;
                    if (tx.splitType === 'custom' && (tx.customItems || tx.customAmounts)) {
                        // æ”¯æ´æ–°æ ¼å¼ customItems
                        if (tx.customItems) Object.entries(tx.customItems).forEach(([member, items]) => { if (balances[member] === undefined) balances[member] = 0; items.forEach(item => { balances[member] -= parseFloat(item.amount) || 0; }); });
                        // å‘å¾Œå…¼å®¹èˆŠæ ¼å¼ customAmounts
                        else Object.entries(tx.customAmounts).forEach(([member, memberAmount]) => { if (balances[member] === undefined) balances[member] = 0; balances[member] -= parseFloat(memberAmount) || 0; });
                    } else {
                        const involved = tx.involved || bookMembers;
                        const splitAmount = amount / involved.length;
                        involved.forEach(member => { if (balances[member] === undefined) balances[member] = 0; balances[member] -= splitAmount; });
                    }
                });
                return balances;
            };
            const netBalances = calculateNetBalances();

            const getPairwiseDebts = () => {
                const pairDebts = {};
                bookMembers.forEach(a => { pairDebts[a] = {}; bookMembers.forEach(b => { if (a !== b) pairDebts[a][b] = 0; }); });
                transactions.forEach(tx => {
                    const payer = tx.payer;
                    if (tx.splitType === 'custom' && (tx.customItems || tx.customAmounts)) {
                        if (tx.customItems) Object.entries(tx.customItems).forEach(([member, items]) => { const total = items.reduce((s, it) => s + (parseFloat(it.amount) || 0), 0); if (member !== payer && total > 0 && pairDebts[payer] && pairDebts[payer][member] !== undefined) pairDebts[payer][member] += total; });
                        else Object.entries(tx.customAmounts).forEach(([member, amount]) => { if (member !== payer && parseFloat(amount) > 0 && pairDebts[payer] && pairDebts[payer][member] !== undefined) pairDebts[payer][member] += parseFloat(amount); });
                    } else {
                        const involved = tx.involved || bookMembers;
                        const splitAmount = tx.amount / involved.length;
                        involved.forEach(member => { if (member !== payer && pairDebts[payer] && pairDebts[payer][member] !== undefined) pairDebts[payer][member] += splitAmount; });
                    }
                });
                return pairDebts;
            };

            const getMemberExpenseDetail = (memberName) => {
                const expenseItems = [];
                let totalExpense = 0;
                transactions.forEach(tx => {
                    const myAmount = getMemberAmountInTx(tx, memberName);
                    if (myAmount > 0) {
                        expenseItems.push({ date: tx.date, description: tx.description, amount: myAmount, payer: tx.payer, isSelfPaid: tx.payer === memberName });
                        totalExpense += myAmount;
                    }
                });
                return { expenseItems, totalExpense };
            };

            const getMemberDebtDetail = (name) => {
                const pairDebts = getPairwiseDebts();
                const toPay = [];
                const toReceive = [];
                bookMembers.forEach(other => {
                    if (other === name) return;
                    const iOweOther = (pairDebts[other] && pairDebts[other][name]) || 0;
                    const otherOwesMe = (pairDebts[name] && pairDebts[name][other]) || 0;
                    const netAmount = otherOwesMe - iOweOther;
                    if (netAmount > 0.01) toReceive.push({ from: other, amount: netAmount });
                    else if (netAmount < -0.01) toPay.push({ to: other, amount: Math.abs(netAmount) });
                });
                const myExpense = getMemberExpenseDetail(name);
                return { toPay, toReceive, myExpense };
            };

            // ç²å–å…©äººä¹‹é–“çš„äº¤æ˜“æ˜ç´°
            const getDetailBetweenTwo = (me, other) => {
                const items = [];
                transactions.forEach(tx => {
                    const involved = tx.involved || bookMembers;
                    const isPayer = tx.payer === me || tx.payer === other;
                    const isInvolved = involved.includes(me) && involved.includes(other);
                    if (!isPayer && !isInvolved) return;

                    // è¨ˆç®—æˆ‘åœ¨é€™ç­†äº¤æ˜“ä¸­çš„ä»½é¡
                    let myShare = 0;
                    if (tx.splitType === 'custom' && tx.customItems && tx.customItems[me]) {
                        myShare = tx.customItems[me].reduce((s, it) => s + (parseFloat(it.amount) || 0), 0);
                    } else if (tx.splitType === 'custom' && tx.customAmounts) {
                        myShare = parseFloat(tx.customAmounts[me]) || 0;
                    } else if (involved.includes(me)) {
                        myShare = tx.amount / involved.length;
                    }

                    // è¨ˆç®—å°æ–¹åœ¨é€™ç­†äº¤æ˜“ä¸­çš„ä»½é¡
                    let otherShare = 0;
                    if (tx.splitType === 'custom' && tx.customItems && tx.customItems[other]) {
                        otherShare = tx.customItems[other].reduce((s, it) => s + (parseFloat(it.amount) || 0), 0);
                    } else if (tx.splitType === 'custom' && tx.customAmounts) {
                        otherShare = parseFloat(tx.customAmounts[other]) || 0;
                    } else if (involved.includes(other)) {
                        otherShare = tx.amount / involved.length;
                    }

                    // è¨ˆç®—é€™ç­†äº¤æ˜“ä¸­æˆ‘è·Ÿå°æ–¹çš„é—œä¿‚
                    let amountChange = 0;
                    if (tx.payer === me) {
                        // æˆ‘ä»˜éŒ¢ï¼Œå°æ–¹æ¬ æˆ‘ä»–çš„ä»½é¡
                        amountChange = otherShare;
                    } else if (tx.payer === other) {
                        // å°æ–¹ä»˜éŒ¢ï¼Œæˆ‘æ¬ å°æ–¹æˆ‘çš„ä»½é¡
                        amountChange = -myShare;
                    }

                    if (Math.abs(amountChange) > 0.01) {
                        items.push({
                            id: tx.id, // åŠ å…¥äº¤æ˜“ ID ä»¥è¿½è¹¤çµæ¸…ç‹€æ…‹
                            date: tx.date,
                            description: tx.description,
                            payer: tx.payer,
                            amount: Math.abs(amountChange),
                            isPositive: amountChange > 0 // true = å°æ–¹æ¬ æˆ‘, false = æˆ‘æ¬ å°æ–¹
                        });
                    }
                });
                return items;
            };

            const exportToExcel = (settlementsToExport) => {
                const allTransactions = [];
                settlementsToExport.forEach(settlement => {
                    if (settlement.transactionsSnapshot) {
                        settlement.transactionsSnapshot.forEach(tx => {
                            let payeeInfo = '';
                            if (tx.splitType === 'custom' && tx.customItems) payeeInfo = Object.entries(tx.customItems).filter(([m, items]) => items.reduce((s, it) => s + (parseFloat(it.amount) || 0), 0) > 0).map(([m, items]) => m + ': ' + items.reduce((s, it) => s + (parseFloat(it.amount) || 0), 0)).join('; ');
                            else if (tx.splitType === 'custom' && tx.customAmounts) payeeInfo = Object.entries(tx.customAmounts).filter(([m, a]) => parseFloat(a) > 0).map(([m, a]) => m + ': ' + a).join('; ');
                            else payeeInfo = (tx.involved || []).join(', ');
                            allTransactions.push({ 'å¹£åˆ¥': tx.currency || currentBook.currency, 'åŒ¯ç‡': tx.exchangeRate || activeRate, 'æ—¥æœŸ': tx.date, 'ä»˜æ¬¾äººå§“å': tx.payer, 'è¢«ä»˜æ¬¾äººå§“å': payeeInfo, 'é …ç›®': tx.description, 'é‡‘é¡': tx.amount, 'åˆ†å¸³æ–¹å¼': tx.splitType === 'custom' ? 'ABåˆ†' : 'å¹³åˆ†', 'çµç®—æ—¥æœŸ': settlement.settledDate, 'å°å¹£é‡‘é¡': tx.amountTWD || Math.round(tx.amount * (tx.exchangeRate || activeRate)) });
                        });
                    }
                });
                if (allTransactions.length === 0) { alert(t.no_records); return; }
                const ws = XLSX.utils.json_to_sheet(allTransactions);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "æ­·å²ç´€éŒ„");
                XLSX.writeFile(wb, 'æ­·å²ç´€éŒ„_' + new Date().toISOString().split('T')[0] + '.xlsx');
            };

            const toggleSettlementSelection = (id) => { if (selectedSettlements.includes(id)) setSelectedSettlements(selectedSettlements.filter(i => i !== id)); else setSelectedSettlements([...selectedSettlements, id]); };
            const toggleSelectAll = () => { if (selectedSettlements.length === settlements.length) setSelectedSettlements([]); else setSelectedSettlements(settlements.map(s => s.id)); };

            const renderHistoryDetail = (snapshot) => {
                if (!snapshot || !Array.isArray(snapshot) || snapshot.length === 0) return <div className="text-center text-gray-400 py-2">{t.no_payment}</div>;
                const historyMembers = new Set();
                snapshot.forEach(tx => { historyMembers.add(tx.payer); if (tx.involved) tx.involved.forEach(m => historyMembers.add(m)); });
                const membersArr = Array.from(historyMembers);
                const balances = {};
                membersArr.forEach(m => balances[m] = 0);
                snapshot.forEach(tx => {
                    const involved = tx.involved || membersArr;
                    if (involved.length === 0) return;
                    if (balances[tx.payer] === undefined) balances[tx.payer] = 0;
                    balances[tx.payer] += tx.amount;
                    if (tx.splitType === 'custom' && (tx.customItems || tx.customAmounts)) {
                        if (tx.customItems) Object.entries(tx.customItems).forEach(([m, items]) => { if (balances[m] === undefined) balances[m] = 0; items.forEach(it => { balances[m] -= parseFloat(it.amount) || 0; }); });
                        else Object.entries(tx.customAmounts).forEach(([m, a]) => { if (balances[m] === undefined) balances[m] = 0; balances[m] -= parseFloat(a) || 0; });
                    } else { const split = tx.amount / involved.length; involved.forEach(m => { if (balances[m] === undefined) balances[m] = 0; balances[m] -= split; }); }
                });
                let debtors = [], creditors = [];
                Object.entries(balances).forEach(([name, b]) => { if (b < -0.01) debtors.push({ name, amount: Math.abs(b) }); if (b > 0.01) creditors.push({ name, amount: b }); });
                debtors.sort((a, b) => b.amount - a.amount); creditors.sort((a, b) => b.amount - a.amount);
                const results = []; let i = 0, j = 0;
                while (i < debtors.length && j < creditors.length) { const d = debtors[i], c = creditors[j]; const amount = Math.min(d.amount, c.amount); results.push({ from: d.name, to: c.name, amount }); d.amount -= amount; c.amount -= amount; if (d.amount < 0.01) i++; if (c.amount < 0.01) j++; }
                return (<div className="bg-gray-50 p-4 rounded-2xl mt-4"><h4 className="font-bold text-gray-500 text-xs uppercase mb-3">{t.history_settle}</h4>{results.length === 0 ? <p className="text-sm text-gray-400">{t.no_payment}</p> : results.map((r, idx) => (<div key={idx} className="flex justify-between items-center border-b border-gray-200 last:border-0 py-2"><div className="flex items-center gap-2"><span className="font-bold text-gray-700">{r.from}</span><span className="text-gray-400 text-xs">{t.give}</span><span className="font-bold text-gray-700">{r.to}</span></div><span className="font-black text-blue-600">{currentCurrency.symbol}{Math.round(r.amount).toLocaleString()}</span></div>))}</div>);
            };

            const handleRollbackSettlement = () => {
                if (!viewingSettlement) return;
                if (!confirm(t.confirm_undo)) return;
                const txPath = currentBookId === 'default' ? 'transactions' : 'books/' + currentBookId + '/transactions';
                const stPath = currentBookId === 'default' ? 'settlements' : 'books/' + currentBookId + '/settlements';
                const updates = {};
                if (viewingSettlement.transactionsSnapshot) viewingSettlement.transactionsSnapshot.forEach(tx => { const newKey = db.ref(txPath).push().key; const { id, ...transactionData } = tx; updates[txPath + '/' + newKey] = transactionData; });
                updates[stPath + '/' + viewingSettlement.id] = null;
                db.ref().update(updates).then(() => { setViewingSettlement(null); setIsHistoryOpen(false); });
            };

            const handleDeleteSettlement = () => {
                if (!viewingSettlement) return;
                if (!confirm(t.confirm_perm_delete)) return;
                const stPath = currentBookId === 'default' ? 'settlements' : 'books/' + currentBookId + '/settlements';
                db.ref(stPath).child(viewingSettlement.id).remove().then(() => { setViewingSettlement(null); });
            };

            const allDisplayMembers = Array.from(new Set([...Object.keys(globalMembers), ...bookMembers]));
            const monthlyStats = isPersonalBook ? getMonthlyStats() : null;

            const renderBookItem = ([id, book], isShared) => (
                <div key={id} className={`w-full text-left p-3 rounded-xl border-2 transition-all flex justify-between items-center ${currentBookId === id ? 'border-gray-800 bg-gray-50 selected-book' : 'border-transparent hover:bg-gray-50'}`}>
                    <div onClick={() => { setCurrentBookId(id); setIsMenuOpen(false); }} className="flex-1 cursor-pointer">
                        {editingBookId === id ? <input type="text" value={tempBookName} onClick={(e) => e.stopPropagation()} onChange={(e) => setTempBookName(e.target.value)} className="w-full bg-white border border-gray-300 rounded px-2 py-1 text-sm font-bold" autoFocus /> : <div className={`font-bold ${currentBookId === id ? 'selected-book-text' : 'text-gray-800'}`}>{book.name}</div>}
                        <div className={`text-xs font-bold flex items-center gap-1 ${currentBookId === id ? 'selected-book-subtext' : 'text-gray-500'}`}>
                            {book.isPersonal && <span className="bg-purple-100 text-purple-600 px-1.5 py-0.5 rounded text-[10px]">{globalMembers[book.owner]}</span>}
                            {lang === 'zh' ? (CURRENCIES.find(c => c.code === book.currency)?.name_zh || book.currency) : (CURRENCIES.find(c => c.code === book.currency)?.name_en || book.currency)} {t.ledger}
                        </div>
                    </div>
                    <div className="flex items-center gap-1">
                        <button onClick={(e) => editingBookId === id ? saveBookName(id, e) : startEditBook(id, book.name, e)} className="p-2 text-gray-400 hover:text-black">{editingBookId === id ? <Icons.Check /> : <Icons.Edit />}</button>
                        {id !== 'default' && <button onClick={(e) => handleDeleteBook(id, e)} className="p-2 text-gray-400 hover:text-red-500"><Icons.Trash /></button>}
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen bg-gray-100 pb-24 relative overflow-x-hidden">
                    {/* Auth Loading Screen */}
                    {authLoading && (
                        <div className="fixed inset-0 z-[100] bg-gradient-to-br from-gray-50 to-gray-200 flex items-center justify-center">
                            <div className="text-center">
                                <div className="text-5xl mb-4 animate-pulse">ğŸ’°</div>
                                <p className="text-gray-500 font-bold">{t.loading_auth}</p>
                            </div>
                        </div>
                    )}

                    {/* Login Screen - Show when not loading and not logged in (and not guest) */}
                    {!authLoading && !userId && !isGuest && (
                        <div className="fixed inset-0 z-[100] bg-gradient-to-br from-blue-50 via-white to-purple-50 flex items-center justify-center">
                            <div className="text-center p-8 max-w-sm w-full">
                                <div className="text-7xl mb-6">ğŸ’°</div>
                                <h1 className="text-3xl font-black text-gray-800 mb-2">{t.app_title}</h1>
                                <p className="text-gray-500 mb-8">{lang === 'zh' ? 'è¼•é¬†è¨˜éŒ„ã€æ™ºæ…§åˆ†å¸³' : 'Track & Split Expenses'}</p>

                                <button
                                    onClick={signInWithGoogle}
                                    className="w-full flex items-center justify-center gap-3 bg-white border-2 border-gray-200 rounded-2xl px-6 py-4 font-bold text-gray-700 hover:border-gray-400 hover:shadow-lg transition-all"
                                >
                                    <svg className="w-6 h-6" viewBox="0 0 24 24">
                                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" />
                                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" />
                                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" />
                                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" />
                                    </svg>
                                    {lang === 'zh' ? 'ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥' : 'Sign in with Google'}
                                </button>

                                <p className="text-xs text-gray-400 mt-6">
                                    {lang === 'zh' ? 'ç™»å…¥å¾Œè³‡æ–™æœƒè‡ªå‹•è·¨è£ç½®åŒæ­¥' : 'Your data syncs across all devices'}
                                </p>
                            </div>
                        </div>
                    )}

                    {/* Guest Mode Banner */}
                    {isGuest && (
                        <div className="bg-gradient-to-r from-blue-500 to-purple-600 text-white px-4 py-3 flex items-center justify-between">
                            <div className="flex items-center gap-2">
                                <span className="text-lg">ğŸ‘¥</span>
                                <span className="font-bold text-sm">{t.guest_mode}</span>
                            </div>
                            <button
                                onClick={() => { window.location.href = window.location.origin; }}
                                className="px-3 py-1 bg-white/20 rounded-lg text-sm font-bold hover:bg-white/30"
                            >
                                {t.back_to_home}
                            </button>
                        </div>
                    )}
                    {/* Menu */}
                    {isMenuOpen && <div className="fixed inset-0 z-50 flex"><div className="absolute inset-0 bg-black/50" onClick={() => setIsMenuOpen(false)}></div><div className="bg-white w-4/5 max-w-xs h-full shadow-2xl slide-in-left flex flex-col relative z-10"><div className="p-6 flex-1 overflow-y-auto no-scrollbar">
                        <h2 className="text-xl font-black text-gray-800 mb-4 flex items-center gap-2"><Icons.Globe /> {t.book_list}</h2>

                        {/* Shared Books Section */}
                        <div className="mb-4">
                            <div className="flex items-center gap-2 mb-2"><Icons.Users /><span className="text-sm font-bold text-gray-500">{t.shared_books}</span></div>
                            <div className="space-y-2">{sharedBooks.map(([id, book]) => renderBookItem([id, book], true))}</div>
                        </div>

                        {/* Personal Books Section */}
                        <div className="mb-6">
                            <div className="flex items-center gap-2 mb-2"><Icons.User /><span className="text-sm font-bold text-gray-500">{t.personal_books}</span></div>
                            {personalBooks.length === 0 ? (
                                <div className="text-center py-4 text-gray-400 text-sm">{t.no_personal_books}</div>
                            ) : (
                                <div className="space-y-2">{personalBooks.map(([id, book]) => renderBookItem([id, book], false))}</div>
                            )}
                        </div>

                    </div><div className="p-4 border-t bg-white space-y-2">
                            <button onClick={() => { setIsMenuSettingsOpen(true); setIsMenuOpen(false); }} className="w-full bg-gray-100 text-gray-700 py-3 rounded-xl font-bold flex items-center justify-center gap-2 hover:bg-gray-200"><Icons.Settings /> {t.menu_settings}</button>
                            <button onClick={openAddBookModal} className="w-full bg-black text-white py-3 rounded-xl font-bold flex items-center justify-center gap-2"><Icons.Plus /> {t.add_book}</button>
                        </div></div></div>}

                    {/* Menu Settings Modal */}
                    {isMenuSettingsOpen && <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm modal-enter"><div className="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-xl font-black text-gray-800 flex items-center gap-2"><Icons.Settings /> {t.menu_settings}</h3>
                            <button onClick={() => setIsMenuSettingsOpen(false)} className="p-2 bg-gray-100 rounded-full">âœ•</button>
                        </div>
                        <div className="space-y-3">
                            <button onClick={() => { setMemberManagerSource('menu'); setIsMemberManagerOpen(true); setIsMenuSettingsOpen(false); }} className="w-full bg-gray-100 text-gray-700 py-3 rounded-xl font-bold flex items-center justify-center gap-2 hover:bg-gray-200"><Icons.User /> {t.manage_members}</button>
                            <button onClick={() => setDarkMode(!darkMode)} className="w-full bg-gray-100 text-gray-700 py-3 rounded-xl font-bold flex items-center justify-center gap-2 hover:bg-gray-200">
                                {darkMode ? <Icons.Sun /> : <Icons.Moon />} {darkMode ? t.light_mode : t.dark_mode}
                            </button>
                            <button onClick={toggleLang} className="w-full bg-gray-100 text-gray-700 py-3 rounded-xl font-bold flex items-center justify-center gap-2 hover:bg-gray-200"><Icons.Lang /> {t.lang_btn}</button>
                            <button onClick={() => { setIsDeletedBooksOpen(true); setIsMenuSettingsOpen(false); }} className="w-full bg-gray-100 text-gray-700 py-3 rounded-xl font-bold flex items-center justify-center gap-2 hover:bg-gray-200"><Icons.Trash /> {t.recently_deleted} {Object.keys(deletedBooks).length > 0 && <span className="bg-red-500 text-white text-xs px-2 py-0.5 rounded-full">{Object.keys(deletedBooks).length}</span>}</button>
                        </div>

                        {/* Open Book Toggle */}
                        {!isGuest && (
                            <div className="mt-4 p-4 bg-gray-50 rounded-2xl">
                                <div className="flex items-center justify-between">
                                    <div>
                                        <div className="font-bold text-gray-800 flex items-center gap-2">
                                            <span>ğŸŒ</span> {t.open_book}
                                        </div>
                                        <p className="text-xs text-gray-500 mt-1">{t.open_book_desc}</p>
                                    </div>
                                    <button
                                        onClick={() => togglePublicBook(currentBookId)}
                                        className={`w-12 h-7 rounded-full transition-all relative ${currentBook.isPublic ? 'bg-green-500' : 'bg-gray-300'}`}
                                    >
                                        <div className={`w-5 h-5 bg-white rounded-full absolute top-1 transition-all ${currentBook.isPublic ? 'right-1' : 'left-1'}`}></div>
                                    </button>
                                </div>
                                {currentBook.isPublic && (
                                    <button
                                        onClick={copyShareLink}
                                        className="w-full mt-3 bg-green-500 text-white py-2 rounded-xl font-bold text-sm flex items-center justify-center gap-2"
                                    >
                                        ğŸ”— {t.copy_link}
                                    </button>
                                )}
                            </div>
                        )}

                        {/* User Profile & Sign Out */}
                        {userInfo && (
                            <div className="mt-6 pt-4 border-t border-gray-200">
                                <div className="flex items-center gap-3 mb-3">
                                    {userInfo.photo ? (
                                        <img src={userInfo.photo} alt="" className="w-10 h-10 rounded-full" />
                                    ) : (
                                        <div className="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center text-lg">ğŸ‘¤</div>
                                    )}
                                    <div className="flex-1 min-w-0">
                                        <div className="font-bold text-gray-800 truncate">{userInfo.name}</div>
                                        <div className="text-xs text-gray-400 truncate">{userInfo.email}</div>
                                    </div>
                                </div>
                                <button
                                    onClick={() => { signOut(); setIsMenuSettingsOpen(false); }}
                                    className="w-full bg-red-50 text-red-600 py-2 rounded-xl font-bold text-sm hover:bg-red-100"
                                >
                                    {lang === 'zh' ? 'ç™»å‡º' : 'Sign Out'}
                                </button>
                            </div>
                        )}
                    </div></div>}

                    {/* Add Book Modal - Step 1: Select Type */}
                    {isAddBookOpen && addBookStep === 1 && <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm modal-enter"><div className="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl">
                        <h3 className="text-xl font-black text-gray-800 mb-4">{t.select_book_type}</h3>
                        <div className="space-y-3">
                            <button onClick={() => { setNewBookType('shared'); setAddBookStep(2); }} className={`w-full p-4 rounded-2xl border-2 text-left transition-all ${newBookType === 'shared' ? 'border-blue-500 bg-blue-50' : 'border-gray-200 hover:border-gray-300'}`}>
                                <div className="flex items-center gap-3"><div className="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center text-2xl">ğŸ‘¥</div><div><div className="font-bold text-gray-800">{t.shared_books}</div><div className="text-xs text-gray-500">{t.shared_book_desc}</div></div></div>
                            </button>
                            <button onClick={() => { setNewBookType('personal'); setAddBookStep(2); }} className={`w-full p-4 rounded-2xl border-2 text-left transition-all ${newBookType === 'personal' ? 'border-purple-500 bg-purple-50' : 'border-gray-200 hover:border-gray-300'}`}>
                                <div className="flex items-center gap-3"><div className="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center text-2xl">ğŸ‘¤</div><div><div className="font-bold text-gray-800">{t.personal_books}</div><div className="text-xs text-gray-500">{t.personal_book_desc}</div></div></div>
                            </button>
                        </div>
                        <button onClick={() => setIsAddBookOpen(false)} className="w-full mt-4 py-3 text-gray-400 font-bold text-sm">{t.cancel}</button>
                    </div></div>}

                    {/* Add Book Modal - Step 2: Details */}
                    {isAddBookOpen && addBookStep === 2 && <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm modal-enter"><div className="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl max-h-[80vh] overflow-y-auto no-scrollbar">
                        <div className="flex items-center gap-2 mb-4">
                            <button onClick={() => setAddBookStep(1)} className="p-2 -ml-2 text-gray-600 hover:bg-gray-100 rounded-full"><Icons.Back /></button>
                            <h3 className="text-xl font-black text-gray-800">{t.new_book_title}</h3>
                        </div>
                        <div className="space-y-4">
                            <div><label className="text-xs font-bold text-gray-400 block mb-1">{t.book_name}</label><input type="text" value={newBookName} onChange={e => setNewBookName(e.target.value)} placeholder="e.g. ğŸ‡¯ğŸ‡µ Trip" className="w-full bg-gray-50 px-4 py-3 rounded-xl font-bold outline-none border border-transparent focus:border-black" /></div>
                            <div><label className="text-xs font-bold text-gray-400 block mb-1">{t.currency}</label><input type="text" value={currencySearch} onChange={e => setCurrencySearch(e.target.value)} placeholder={t.search_currency} className="w-full bg-gray-50 px-3 py-2 rounded-lg text-sm mb-2 outline-none" /><div className="h-32 overflow-y-auto border rounded-xl p-2 space-y-1">{CURRENCIES.filter(c => c.code.includes(currencySearch.toUpperCase()) || (lang === 'zh' ? c.name_zh : c.name_en).includes(currencySearch)).map(c => (<button key={c.code} onClick={() => setNewBookCurrency(c.code)} className={`w-full flex justify-between items-center p-2 rounded-lg ${newBookCurrency === c.code ? 'bg-black text-white' : 'hover:bg-gray-100'}`}><span className="font-bold">{c.flag} {lang === 'zh' ? c.name_zh : c.name_en} ({c.code})</span><span className="text-sm opacity-70">{c.symbol}</span></button>))}</div></div>

                            {newBookType === 'personal' ? (
                                <div><label className="text-xs font-bold text-gray-400 block mb-1">{t.select_owner}</label><div className="grid grid-cols-2 gap-2">{Object.entries(globalMembers).map(([name, avatar]) => (<button key={name} onClick={() => setNewBookOwner(name)} className={`p-2 rounded-xl font-bold border-2 text-sm flex items-center gap-2 ${newBookOwner === name ? 'border-purple-500 bg-purple-50 text-purple-700' : 'border-gray-100 text-gray-400'}`}><span>{avatar}</span> {name}</button>))}</div></div>
                            ) : (
                                <div><label className="text-xs font-bold text-gray-400 block mb-1">{t.select_participants}</label><div className="grid grid-cols-2 gap-2">{Object.entries(globalMembers).map(([name, avatar]) => (<button key={name} onClick={() => toggleMemberSelection(name)} className={`p-2 rounded-xl font-bold border-2 text-sm flex items-center gap-2 ${selectedMembers.includes(name) ? 'border-black bg-gray-50 text-black' : 'border-gray-100 text-gray-400'}`}><span>{avatar}</span> {name}</button>))}</div></div>
                            )}

                            <div className="flex gap-3 pt-2"><button onClick={() => setIsAddBookOpen(false)} className="flex-1 py-3 font-bold text-gray-500 bg-gray-100 rounded-xl">{t.cancel}</button><button onClick={handleCreateBook} className="flex-1 py-3 font-bold text-white bg-black rounded-xl">{t.create}</button></div>
                        </div>
                    </div></div>}

                    {/* Members Manager Modal */}
                    {isMemberManagerOpen && <div className="fixed inset-0 z-[70] flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm modal-enter"><div className="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl h-[600px] flex flex-col"><div className="flex items-center gap-2 mb-4"><button onClick={() => { setIsMemberManagerOpen(false); if (memberManagerSource === 'book') setIsSettingsOpen(true); else setIsMenuSettingsOpen(true); }} className="p-2 -ml-2 text-gray-600 hover:bg-gray-100 rounded-full"><Icons.Back /></button><h3 className="text-xl font-black text-gray-800">{t.member_mgmt}</h3></div><div className="flex-1 overflow-y-auto space-y-2 mb-4 no-scrollbar">{Object.entries(globalMembers).map(([name, avatar]) => (<div key={name} className="bg-gray-50 p-3 rounded-xl border border-gray-100">{editingGlobalMember === name ? (<div className="space-y-3"><div className="grid grid-cols-5 gap-2 max-h-40 overflow-y-auto no-scrollbar p-1">{AVATARS.map(a => (<button key={a} onClick={() => setEditMemberAvatar(a)} className={`text-xl p-2 rounded-lg flex items-center justify-center ${editMemberAvatar === a ? 'bg-black bg-opacity-10 ring-2 ring-black ring-offset-1' : 'hover:bg-gray-200'}`}>{a}</button>))}</div><div className="flex gap-2"><input value={editMemberName} onChange={e => setEditMemberName(e.target.value)} className="flex-1 min-w-0 border border-gray-300 rounded-xl px-3 py-2 font-bold" /><button onClick={saveGlobalMember} className="bg-black text-white px-4 rounded-xl font-bold text-sm shrink-0">{t.save}</button></div></div>) : (<div className="flex items-center justify-between"><span className="font-bold text-lg flex items-center gap-3"><span className="text-2xl">{avatar}</span> {name}</span><div className="flex gap-1"><button onClick={() => startEditGlobalMember(name, avatar)} className="text-gray-400 hover:text-black p-2"><Icons.Edit /></button><button onClick={() => handleDeleteGlobalMember(name)} className="text-gray-400 hover:text-red-500 p-2"><Icons.Trash /></button></div></div>)}</div>))}</div><div className="border-t pt-4"><p className="text-xs font-bold text-gray-400 mb-2">{t.add_member}</p><div className="grid grid-cols-5 gap-2 mb-3 max-h-32 overflow-y-auto no-scrollbar p-1">{AVATARS.map(a => (<button key={a} onClick={() => setNewMemberAvatar(a)} className={`text-2xl p-2 rounded-lg flex items-center justify-center ${newMemberAvatar === a ? 'bg-black bg-opacity-10 ring-2 ring-black ring-offset-1' : 'hover:bg-gray-200'}`}>{a}</button>))}</div><div className="flex gap-2"><input type="text" value={newMemberName} onChange={e => setNewMemberName(e.target.value)} placeholder={t.name} className="flex-1 min-w-0 bg-gray-50 border border-gray-200 rounded-xl px-3 py-3 font-bold outline-none" /><button onClick={handleAddGlobalMember} className="bg-black text-white px-4 rounded-xl font-bold shrink-0">{t.add}</button></div></div></div></div>}

                    {/* Book Settings Modal */}
                    {isBookMemberSettingsOpen && !isPersonalBook && <div className="fixed inset-0 z-[70] flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm modal-enter"><div className="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl"><div className="flex justify-between items-center mb-4"><h3 className="text-xl font-black text-gray-800">{t.book_settings}</h3><button onClick={() => setIsBookMemberSettingsOpen(false)} className="p-2 bg-gray-100 rounded-full">âœ•</button></div><p className="text-xs text-gray-400 mb-4">{t.select_members}:</p><div className="max-h-[60vh] overflow-y-auto space-y-2 no-scrollbar">{allDisplayMembers.map((name) => { const avatar = globalMembers[name] || 'ğŸ‘»'; return (<button key={name} onClick={() => toggleBookMember(name)} className={`w-full p-3 rounded-xl border-2 font-bold text-lg flex items-center justify-between transition-all ${bookMembers.includes(name) ? 'border-black bg-gray-50' : 'border-gray-100'}`}><div className="flex items-center gap-2"><span className="text-2xl">{avatar}</span><span className="text-gray-800">{name}</span></div>{bookMembers.includes(name) && <Icons.Check />}</button>); })}</div></div></div>}

                    {/* Recently Deleted Books Modal */}
                    {isDeletedBooksOpen && <div className="fixed inset-0 z-[70] flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm modal-enter"><div className="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl max-h-[80vh] flex flex-col"><div className="flex justify-between items-center mb-4"><h3 className="text-xl font-black text-gray-800 flex items-center gap-2"><Icons.Trash /> {t.recently_deleted}</h3><button onClick={() => setIsDeletedBooksOpen(false)} className="p-2 bg-gray-100 rounded-full">âœ•</button></div><div className="flex-1 overflow-y-auto space-y-2 no-scrollbar">{Object.keys(deletedBooks).length === 0 ? (<div className="text-center text-gray-400 py-10">{t.no_deleted_books}</div>) : (Object.entries(deletedBooks).map(([id, book]) => (<div key={id} className="bg-gray-50 p-4 rounded-xl border border-gray-200"><div className="flex justify-between items-start mb-2"><div><div className="font-bold text-gray-800">{book.name}</div><div className="text-xs text-gray-500">{lang === 'zh' ? (CURRENCIES.find(c => c.code === book.currency)?.name_zh || book.currency) : (CURRENCIES.find(c => c.code === book.currency)?.name_en || book.currency)} {t.ledger}</div></div><div className="text-xs text-red-500 font-bold bg-red-50 px-2 py-1 rounded">{getDaysLeft(book.deletedAt)} {t.days_left}</div></div><div className="flex gap-2 mt-3"><button onClick={() => handleRestoreBook(id)} className="flex-1 bg-green-500 text-white py-2 rounded-xl font-bold text-sm flex items-center justify-center gap-1 hover:bg-green-600"><Icons.Undo /> {t.restore}</button><button onClick={(e) => handlePermanentDeleteBook(id, e)} className="flex-1 bg-red-500 text-white py-2 rounded-xl font-bold text-sm flex items-center justify-center gap-1 hover:bg-red-600"><Icons.Trash /> {t.delete}</button></div></div>)))}</div></div></div>}

                    {/* Rate Modal */}
                    {isRateModalOpen && <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm modal-enter"><div className="bg-white w-full max-w-xs rounded-3xl p-6 shadow-2xl"><h3 className="text-lg font-black text-gray-800 mb-2">{t.set_rate} ({CURRENCIES.find(c => c.code === currentBook.currency)?.code})</h3><p className="text-xs text-gray-500 mb-4">{t.rate_hint}</p><input type="number" inputMode="decimal" value={newRate} onChange={e => setNewRate(e.target.value)} className="w-full bg-gray-50 px-4 py-3 rounded-xl text-2xl font-black text-center outline-none border-2 border-black mb-4" autoFocus /><div className="flex gap-2"><button onClick={handleRefreshRate} className="flex-1 py-3 bg-gray-100 text-gray-600 font-bold rounded-xl flex items-center justify-center gap-1"><Icons.Refresh /> {t.fetch}</button><button onClick={() => { handleUpdateGlobalRate(); setIsSettingsOpen(true); }} className="flex-[2] bg-black text-white py-3 rounded-xl font-bold shadow-lg active:scale-95 transition-all">{t.confirm}</button></div><button onClick={() => { setIsRateModalOpen(false); setIsSettingsOpen(true); }} className="w-full mt-2 py-3 text-gray-400 font-bold text-sm">{t.cancel}</button></div></div>}

                    {/* Settings Modal - Unified Settings Page */}
                    {isSettingsOpen && <div className="fixed inset-0 z-[60] bg-gray-100 flex flex-col modal-enter">
                        <div className="bg-white px-6 py-4 shadow-sm flex items-center justify-between sticky top-0 z-10">
                            <div className="flex items-center gap-2">
                                <button onClick={() => setIsSettingsOpen(false)} className="p-2 -ml-2 text-gray-600 hover:bg-gray-100 rounded-full"><Icons.Back /></button>
                                <h2 className="text-xl font-black text-gray-800">{t.book_settings_title}</h2>
                            </div>
                        </div>
                        <div className="flex-1 overflow-y-auto p-4 space-y-4">
                            {/* Member Settings */}
                            <div className="bg-white rounded-2xl p-4 shadow-sm">
                                <div className="flex items-center gap-2 mb-3"><Icons.Users /><h3 className="font-bold text-gray-800">{isPersonalBook ? t.member_settings : t.book_settings}</h3></div>
                                {isPersonalBook ? (
                                    <div className="flex items-center gap-3 p-3 bg-gray-50 rounded-xl">
                                        <span className="text-3xl">{globalMembers[currentBook.owner]}</span>
                                        <div><div className="font-bold text-gray-800">{currentBook.owner}</div><div className="text-xs text-gray-500">{t.owner}</div></div>
                                    </div>
                                ) : (
                                    <div className="space-y-2">
                                        <p className="text-sm text-gray-500 mb-2">{t.select_members}</p>
                                        {Object.entries(globalMembers).map(([name, avatar]) => (
                                            <div key={name} className={`flex justify-between items-center p-3 rounded-xl transition ${bookMembers.includes(name) ? 'bg-green-50 border border-green-200' : 'bg-gray-50'}`}>
                                                <div className="flex items-center gap-3"><span className="text-2xl">{avatar}</span><span className="font-bold text-gray-800">{name}</span></div>
                                                <button onClick={() => toggleBookMember(name)} className={`w-8 h-8 rounded-full flex items-center justify-center ${bookMembers.includes(name) ? 'bg-green-500 text-white' : 'bg-gray-200'}`}>{bookMembers.includes(name) && <Icons.Check />}</button>
                                            </div>
                                        ))}
                                        <button onClick={() => { setMemberManagerSource('book'); setIsMemberManagerOpen(true); setIsSettingsOpen(false); }} className="w-full mt-2 py-2 text-blue-600 font-bold text-sm">{t.manage_members}</button>
                                    </div>
                                )}
                            </div>

                            {/* History Button */}
                            <button onClick={() => { setIsHistoryOpen(true); setIsSettingsOpen(false); setViewingSettlement(null); setIsExportMode(false); setSelectedSettlements([]); }} className="w-full bg-white rounded-2xl p-4 shadow-sm flex items-center justify-between">
                                <div className="flex items-center gap-2"><Icons.History /><span className="font-bold text-gray-800">{t.history}</span></div>
                                <Icons.ChevronRight />
                            </button>

                            {/* Sort Order */}
                            <div className="bg-white rounded-2xl p-4 shadow-sm">
                                <div className="flex items-center gap-2 mb-3"><Icons.Sort /><h3 className="font-bold text-gray-800">{t.sort_order}</h3></div>
                                <div className="flex gap-2">
                                    <button onClick={() => setSortNewestFirst(true)} className={`flex-1 py-3 rounded-xl font-bold text-sm ${sortNewestFirst ? 'bg-black text-white' : 'bg-gray-100 text-gray-600'}`}>{t.newest_first}</button>
                                    <button onClick={() => setSortNewestFirst(false)} className={`flex-1 py-3 rounded-xl font-bold text-sm ${!sortNewestFirst ? 'bg-black text-white' : 'bg-gray-100 text-gray-600'}`}>{t.oldest_first}</button>
                                </div>
                            </div>

                            {/* Exchange Rate (only for non-TWD) */}
                            {currentBook.currency !== 'TWD' && (
                                <div className="bg-white rounded-2xl p-4 shadow-sm">
                                    <div className="flex items-center gap-2 mb-3"><Icons.Refresh /><h3 className="font-bold text-gray-800">{t.rate_settings}</h3></div>
                                    <div className="flex items-center gap-3">
                                        <div className="flex-1 bg-gray-50 rounded-xl p-3">
                                            <div className="text-xs text-gray-500">1 {currentBook.currency} =</div>
                                            <div className="text-xl font-black text-gray-800">{activeRate} TWD</div>
                                        </div>
                                        <button onClick={() => { openRateModal(); setIsSettingsOpen(false); }} className="px-4 py-3 bg-blue-500 text-white rounded-xl font-bold">{t.edit_rate}</button>
                                    </div>
                                </div>
                            )}

                            {/* Category Management (only for personal books) */}
                            {isPersonalBook && (
                                <div className="bg-white rounded-2xl p-4 shadow-sm">
                                    <div className="flex items-center justify-between mb-3">
                                        <div className="flex items-center gap-2"><Icons.Category /><h3 className="font-bold text-gray-800">{t.category_mgmt}</h3></div>
                                        <button onClick={() => { setEditingCategory(null); setNewCategoryName(''); setNewCategoryNameEn(''); setNewCategoryIcon('ğŸ“'); setIsCategoryEditOpen(true); }} className="px-3 py-1.5 bg-black text-white rounded-lg text-sm font-bold">+ {t.add}</button>
                                    </div>
                                    <div className="space-y-2">
                                        {allCategories.map(cat => {
                                            const isCustom = customCategories.find(c => c.id === cat.id);
                                            const isDefault = CATEGORIES.find(c => c.id === cat.id);
                                            return (
                                                <div key={cat.id} className="flex items-center justify-between p-3 bg-gray-50 rounded-xl">
                                                    <div className="flex items-center gap-3">
                                                        <div className="w-8 h-8 flex items-center justify-center">{renderCategoryIcon(cat.icon)}</div>
                                                        <div>
                                                            <div className="font-bold text-gray-800">{lang === 'zh' ? cat.name_zh : cat.name_en}</div>
                                                            <div className="text-xs text-gray-400">{isDefault && !isCustom ? t.default_category : cat.id}</div>
                                                        </div>
                                                    </div>
                                                    <div className="flex gap-1 items-center">
                                                        <button onClick={() => { setEditingCategory(cat); setNewCategoryName(cat.name_zh); setNewCategoryNameEn(cat.name_en); setNewCategoryIcon(cat.icon); setCustomIconUrl(cat.icon.startsWith('data:image') ? cat.icon : ''); setIsCategoryEditOpen(true); }} className="p-2 text-blue-500 hover:bg-blue-50 rounded-lg"><Icons.Edit /></button>
                                                        {isCustom && !isDefault && (
                                                            <button onClick={() => { const isInUse = transactions.some(tx => tx.category === cat.id); if (isInUse) { alert(t.category_in_use); return; } if (confirm(t.confirm_delete_category)) db.ref('settings/customCategories/' + cat.id).remove(); }} className="p-2 text-red-500 hover:bg-red-50 rounded-lg"><Icons.Trash /></button>
                                                        )}
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            )}

                            {/* Recurring Transactions */}
                            <button onClick={() => { setIsRecurringListOpen(true); setIsSettingsOpen(false); }} className="w-full bg-white rounded-2xl p-4 shadow-sm flex items-center justify-between">
                                <div className="flex items-center gap-2"><Icons.Refresh /><span className="font-bold text-gray-800">{t.recurring}</span></div>
                                <div className="flex items-center gap-2">
                                    <span className="bg-blue-100 text-blue-600 px-2 py-0.5 rounded-full text-sm font-bold">{recurringItems.length}</span>
                                    <Icons.ChevronRight />
                                </div>
                            </button>

                            {/* Open Book Toggle (only for non-guest, not default book) */}
                            {!isGuest && currentBookId !== 'default' && (
                                <div className="bg-white rounded-2xl p-4 shadow-sm">
                                    <div className="flex items-center justify-between mb-2">
                                        <div className="flex items-center gap-2">
                                            <span className="text-xl">ğŸŒ</span>
                                            <h3 className="font-bold text-gray-800">{t.open_book}</h3>
                                        </div>
                                        <button
                                            onClick={() => togglePublicBook(currentBookId)}
                                            className={`w-14 h-8 rounded-full transition-all relative ${currentBook.isPublic ? 'bg-green-500' : 'bg-gray-300'}`}
                                        >
                                            <div className={`w-6 h-6 bg-white rounded-full absolute top-1 transition-all shadow ${currentBook.isPublic ? 'right-1' : 'left-1'}`}></div>
                                        </button>
                                    </div>
                                    <p className="text-xs text-gray-500 mb-3">{t.open_book_desc}</p>
                                    {currentBook.isPublic && userId && (
                                        <div className="bg-gray-50 rounded-xl p-3">
                                            <div className="text-xs text-gray-400 mb-1">{t.share_link}</div>
                                            <div className="flex items-center gap-2">
                                                <input
                                                    type="text"
                                                    readOnly
                                                    value={window.location.origin + '?share=' + userId}
                                                    className="flex-1 bg-white border border-gray-200 rounded-lg px-3 py-2 text-sm font-mono text-gray-600"
                                                />
                                                <button
                                                    onClick={() => {
                                                        navigator.clipboard.writeText(window.location.origin + '?share=' + userId);
                                                        alert(t.link_copied);
                                                    }}
                                                    className="px-3 py-2 bg-blue-500 text-white rounded-lg text-sm font-bold shrink-0"
                                                >
                                                    {t.copy_link}
                                                </button>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>
                    </div>}

                    {/* Recurring List Modal */}
                    {isRecurringListOpen && <div className="fixed inset-0 z-[65] bg-gray-100 flex flex-col modal-enter">
                        <div className="bg-white px-6 py-4 shadow-sm flex items-center justify-between sticky top-0 z-10">
                            <div className="flex items-center gap-2">
                                <button onClick={() => { setIsRecurringListOpen(false); setIsSettingsOpen(true); }} className="p-2 -ml-2 text-gray-600 hover:bg-gray-100 rounded-full"><Icons.Back /></button>
                                <h2 className="text-xl font-black text-gray-800">{t.recurring}</h2>
                                <span className="bg-blue-600 text-white px-2 py-0.5 rounded-full text-sm font-bold">{recurringItems.length}</span>
                            </div>
                            <button onClick={() => openRecurringForm(null)} className="px-3 py-2 bg-black text-white rounded-xl font-bold text-sm flex items-center gap-1"><Icons.Plus /> {t.add}</button>
                        </div>
                        <div className="flex-1 overflow-y-auto p-4 space-y-3">
                            {recurringItems.length === 0 ? (
                                <div className="text-center py-20 text-gray-400">
                                    <p className="text-4xl mb-2">ğŸ”„</p>
                                    <p>{t.no_recurring}</p>
                                </div>
                            ) : (
                                recurringItems.map(item => {
                                    const categoryInfo = isPersonalBook ? (allCategories.find(c => c.id === item.category) || allCategories[allCategories.length - 1]) : null;
                                    return (
                                        <div key={item.id} className={`bg-white p-4 rounded-2xl shadow-sm border-2 ${item.isActive ? 'border-transparent' : 'border-gray-200 opacity-60'}`}>
                                            <div className="flex items-start justify-between mb-2">
                                                <div className="flex items-center gap-3">
                                                    {isPersonalBook && <span className="text-2xl">{categoryInfo?.icon}</span>}
                                                    <div>
                                                        <p className="font-bold text-gray-800 text-lg">{item.name}</p>
                                                        <p className="text-xs text-gray-400">{getIntervalLabel(item)}</p>
                                                    </div>
                                                </div>
                                                <div className="text-right">
                                                    <p className={`text-xl font-black ${isPersonalBook ? (item.txType === 'income' ? 'text-green-600' : 'text-red-600') : 'text-gray-800'}`}>
                                                        {isPersonalBook && (item.txType === 'income' ? '+' : '-')}{currentCurrency.symbol}{item.amount?.toLocaleString()}
                                                    </p>
                                                    <span className={`text-xs font-bold px-2 py-0.5 rounded-full ${item.isActive ? 'bg-green-100 text-green-600' : 'bg-gray-100 text-gray-500'}`}>
                                                        {item.isActive ? t.recurring_active : t.recurring_paused}
                                                    </span>
                                                </div>
                                            </div>
                                            <div className="flex items-center justify-between text-xs text-gray-400 mt-2 pt-2 border-t border-gray-100">
                                                <span>{item.startDate} ~ {item.endDate || t.permanent}</span>
                                                <div className="flex gap-1">
                                                    <button onClick={() => toggleRecurringActive(item.id, item.isActive)} className={`p-2 rounded-lg ${item.isActive ? 'text-orange-500 hover:bg-orange-50' : 'text-green-500 hover:bg-green-50'}`}>
                                                        {item.isActive ? <Icons.Pause /> : <Icons.Play />}
                                                    </button>
                                                    <button onClick={() => openRecurringForm(item)} className="p-2 text-gray-400 hover:bg-gray-100 rounded-lg"><Icons.Edit /></button>
                                                    <button onClick={() => deleteRecurring(item.id)} className="p-2 text-gray-400 hover:bg-red-50 hover:text-red-500 rounded-lg"><Icons.Trash /></button>
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })
                            )}
                        </div>
                    </div>}

                    {/* Recurring Form Modal */}
                    {isRecurringFormOpen && <div className="fixed inset-0 z-[70] flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm modal-enter">
                        <div className="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl max-h-[85vh] overflow-y-auto no-scrollbar">
                            <h3 className="text-xl font-black text-gray-800 mb-4">{editingRecurring ? t.edit_recurring : t.add_recurring}</h3>
                            <div className="space-y-4">
                                {/* Name */}
                                <div>
                                    <label className="text-xs font-bold text-gray-400 ml-1">{t.recurring_name}</label>
                                    <input type="text" value={recurringForm.name} onChange={e => setRecurringForm({ ...recurringForm, name: e.target.value })}
                                        className="w-full px-4 py-3 bg-gray-50 rounded-xl font-bold outline-none mt-1" placeholder={lang === 'zh' ? 'æˆ¿ç§Ÿ' : 'Rent'} />
                                </div>

                                {/* Amount & Type (for personal) */}
                                <div className="flex gap-3">
                                    <div className="flex-1">
                                        <label className="text-xs font-bold text-gray-400 ml-1">{t.recurring_amount}</label>
                                        <input type="number" value={recurringForm.amount} onChange={e => setRecurringForm({ ...recurringForm, amount: e.target.value })}
                                            className="w-full px-4 py-3 bg-gray-50 rounded-xl font-bold outline-none mt-1" placeholder="0" />
                                    </div>
                                    {isPersonalBook && (
                                        <div className="w-24">
                                            <label className="text-xs font-bold text-gray-400 ml-1">{t.recurring_type}</label>
                                            <div className="flex mt-1 bg-gray-50 rounded-xl p-1">
                                                <button onClick={() => setRecurringForm({ ...recurringForm, txType: 'expense' })}
                                                    className={`flex-1 py-2 rounded-lg text-sm font-bold ${recurringForm.txType === 'expense' ? 'bg-red-500 text-white' : 'text-gray-400'}`}>-</button>
                                                <button onClick={() => setRecurringForm({ ...recurringForm, txType: 'income' })}
                                                    className={`flex-1 py-2 rounded-lg text-sm font-bold ${recurringForm.txType === 'income' ? 'bg-green-500 text-white' : 'text-gray-400'}`}>+</button>
                                            </div>
                                        </div>
                                    )}
                                </div>

                                {/* Interval */}
                                <div>
                                    <label className="text-xs font-bold text-gray-400 ml-1">{t.recurring_interval}</label>
                                    <div className="flex gap-2 mt-1">
                                        <div className="flex items-center gap-2 flex-1 bg-gray-50 rounded-xl px-3 py-2">
                                            <span className="text-gray-600 font-bold text-sm">{t.every}</span>
                                            <select value={recurringForm.intervalValue} onChange={e => setRecurringForm({ ...recurringForm, intervalValue: e.target.value })}
                                                className="bg-white border border-gray-200 rounded-lg px-2 py-1 font-bold text-center outline-none">
                                                {recurringForm.intervalType === 'day' && [...Array(30)].map((_, i) => <option key={i + 1} value={i + 1}>{i + 1}</option>)}
                                                {recurringForm.intervalType === 'month' && [...Array(12)].map((_, i) => <option key={i + 1} value={i + 1}>{i + 1}</option>)}
                                                {recurringForm.intervalType === 'year' && [...Array(5)].map((_, i) => <option key={i + 1} value={i + 1}>{i + 1}</option>)}
                                            </select>
                                            <select value={recurringForm.intervalType} onChange={e => setRecurringForm({ ...recurringForm, intervalType: e.target.value, intervalValue: 1 })}
                                                className="bg-white border border-gray-200 rounded-lg px-2 py-1 font-bold outline-none">
                                                <option value="day">{t.interval_day}</option>
                                                <option value="month">{t.interval_month}</option>
                                                <option value="year">{t.interval_year}</option>
                                            </select>
                                            <span className="text-gray-600 font-bold text-sm">{t.repeat_once}</span>
                                        </div>
                                    </div>
                                </div>

                                {/* Category (personal only) */}
                                {isPersonalBook && (
                                    <div>
                                        <label className="text-xs font-bold text-gray-400 ml-1">{t.category} ({t.cancel})</label>
                                        <div className="flex flex-wrap gap-2 mt-2">
                                            {allCategories.map(cat => (
                                                <button key={cat.id} onClick={() => setRecurringForm({ ...recurringForm, category: cat.id })}
                                                    className={`px-3 py-2 rounded-xl text-sm font-bold flex items-center gap-1 ${recurringForm.category === cat.id ? 'bg-black text-white' : 'bg-gray-100 text-gray-600'}`}>
                                                    <span>{cat.icon}</span> {lang === 'zh' ? cat.name_zh : cat.name_en}
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                )}

                                {/* Payer & Involved (shared only) */}
                                {!isPersonalBook && (
                                    <>
                                        <div>
                                            <label className="text-xs font-bold text-gray-400 ml-1">{t.payer}</label>
                                            <div className="flex flex-wrap gap-2 mt-2">
                                                {bookMembers.map(m => (
                                                    <button key={m} onClick={() => setRecurringForm({ ...recurringForm, payer: m })}
                                                        className={`px-3 py-2 rounded-xl text-sm font-bold flex items-center gap-1 ${recurringForm.payer === m ? 'bg-black text-white' : 'bg-gray-100 text-gray-600'}`}>
                                                        <span>{globalMembers[m]}</span> {m}
                                                    </button>
                                                ))}
                                            </div>
                                        </div>
                                        <div>
                                            <label className="text-xs font-bold text-gray-400 ml-1">{t.involved_members}</label>
                                            <div className="flex flex-wrap gap-2 mt-2">
                                                {bookMembers.map(m => (
                                                    <button key={m} onClick={() => {
                                                        const newInvolved = recurringForm.involved.includes(m)
                                                            ? recurringForm.involved.filter(x => x !== m)
                                                            : [...recurringForm.involved, m];
                                                        if (newInvolved.length > 0) setRecurringForm({ ...recurringForm, involved: newInvolved });
                                                    }}
                                                        className={`px-3 py-2 rounded-xl text-sm font-bold flex items-center gap-1 ${recurringForm.involved.includes(m) ? 'bg-green-500 text-white' : 'bg-gray-100 text-gray-600'}`}>
                                                        <span>{globalMembers[m]}</span> {m}
                                                    </button>
                                                ))}
                                            </div>
                                        </div>
                                    </>
                                )}

                                {/* Date Range */}
                                <div>
                                    <label className="text-xs font-bold text-gray-400 ml-1">{t.date_range}</label>
                                    <div className="space-y-2 mt-2">
                                        <div className="flex gap-2 items-center">
                                            <span className="text-sm text-gray-500 w-16">{t.start_date_label}</span>
                                            <input type="date" value={recurringForm.startDate} onChange={e => setRecurringForm({ ...recurringForm, startDate: e.target.value })}
                                                className="flex-1 px-3 py-2 bg-gray-50 rounded-xl font-bold outline-none text-sm" />
                                        </div>
                                        <div className="flex gap-2 items-center">
                                            <span className="text-sm text-gray-500 w-16">{t.end_date_label}</span>
                                            <button onClick={() => setRecurringForm({ ...recurringForm, isPermanent: true, endDate: '' })}
                                                className={`px-3 py-2 rounded-xl text-sm font-bold ${recurringForm.isPermanent ? 'bg-blue-500 text-white' : 'bg-gray-100 text-gray-600'}`}>{t.permanent}</button>
                                            {!recurringForm.isPermanent && (
                                                <input type="date" value={recurringForm.endDate} onChange={e => setRecurringForm({ ...recurringForm, endDate: e.target.value })}
                                                    className="flex-1 px-3 py-2 bg-gray-50 rounded-xl font-bold outline-none text-sm" />
                                            )}
                                            {recurringForm.isPermanent && (
                                                <button onClick={() => setRecurringForm({ ...recurringForm, isPermanent: false })}
                                                    className="px-3 py-2 bg-gray-100 text-gray-600 rounded-xl text-sm font-bold">{t.end_date_label}</button>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div className="flex gap-3 mt-6">
                                <button onClick={() => setIsRecurringFormOpen(false)} className="flex-1 py-3 rounded-xl font-bold text-gray-500 bg-gray-100">{t.cancel}</button>
                                <button onClick={saveRecurring} className="flex-1 py-3 rounded-xl font-bold text-white bg-black">{t.save}</button>
                            </div>
                        </div>
                    </div>}

                    {/* Category Edit Modal */}
                    {isCategoryEditOpen && <div className="fixed inset-0 z-[70] flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm modal-enter"><div className="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl max-h-[85vh] overflow-y-auto">
                        <h3 className="text-xl font-black text-gray-800 mb-4">{editingCategory ? t.edit_category : t.add_category}</h3>
                        <div className="space-y-4">
                            <div><label className="text-xs font-bold text-gray-400 ml-1">{t.category_name_zh}</label><input type="text" value={newCategoryName} onChange={e => setNewCategoryName(e.target.value)} className="w-full px-4 py-3 bg-gray-50 rounded-xl font-bold outline-none mt-1" placeholder="é¤é£²" /></div>
                            <div><label className="text-xs font-bold text-gray-400 ml-1">{t.category_name_en}</label><input type="text" value={newCategoryNameEn} onChange={e => setNewCategoryNameEn(e.target.value)} className="w-full px-4 py-3 bg-gray-50 rounded-xl font-bold outline-none mt-1" placeholder="Food" /></div>
                            <div>
                                <label className="text-xs font-bold text-gray-400 ml-1">{t.category_icon}</label>
                                <div className="flex flex-wrap gap-2 mt-2 max-h-32 overflow-y-auto">
                                    {CATEGORY_ICONS.map(icon => (
                                        <button key={icon} onClick={() => { setNewCategoryIcon(icon); setCustomIconUrl(''); }} className={`w-10 h-10 text-xl rounded-lg flex items-center justify-center ${newCategoryIcon === icon && !customIconUrl ? 'bg-black text-white' : 'bg-gray-100'}`}>{icon}</button>
                                    ))}
                                </div>
                            </div>
                            {/* ä¸Šå‚³è‡ªè¨‚åœ–ç¤ºå€å¡Š */}
                            <div className="border-t border-gray-200 pt-4">
                                <label className="text-xs font-bold text-gray-400 ml-1 flex items-center gap-1">
                                    <Icons.Upload /> {t.upload_icon}
                                </label>
                                <div className="mt-2 flex items-center gap-3">
                                    <input
                                        type="file"
                                        accept="image/*"
                                        onChange={handleIconUpload}
                                        className="hidden"
                                        id="icon-upload"
                                    />
                                    <label
                                        htmlFor="icon-upload"
                                        className="flex-1 py-3 bg-blue-50 text-blue-600 rounded-xl font-bold text-center cursor-pointer hover:bg-blue-100 transition flex items-center justify-center gap-2"
                                    >
                                        <Icons.Upload /> {t.custom_icon}
                                    </label>
                                    {customIconUrl && (
                                        <div className={`w-12 h-12 rounded-xl flex items-center justify-center bg-gray-100 border-2 ${newCategoryIcon === 'custom' ? 'border-black' : 'border-transparent'}`}>
                                            <img src={customIconUrl} alt="custom icon" className="w-8 h-8 object-contain" />
                                        </div>
                                    )}
                                </div>
                                {customIconUrl && (
                                    <p className="text-xs text-green-600 mt-2">âœ“ å·²é¸æ“‡è‡ªè¨‚åœ–ç¤º</p>
                                )}
                            </div>
                        </div>
                        <div className="flex gap-3 mt-6">
                            <button onClick={() => { setIsCategoryEditOpen(false); setCustomIconUrl(''); }} className="flex-1 py-3 rounded-xl font-bold text-gray-500 bg-gray-100">{t.cancel}</button>
                            <button onClick={() => {
                                if (!newCategoryName.trim()) return alert(t.alert_input);
                                const iconToSave = customIconUrl || newCategoryIcon;
                                if (editingCategory) {
                                    db.ref('settings/customCategories/' + editingCategory.id).set({ name_zh: newCategoryName.trim(), name_en: newCategoryNameEn.trim() || newCategoryName.trim(), icon: iconToSave });
                                } else {
                                    const newId = 'cat_' + Date.now();
                                    db.ref('settings/customCategories/' + newId).set({ name_zh: newCategoryName.trim(), name_en: newCategoryNameEn.trim() || newCategoryName.trim(), icon: iconToSave });
                                }
                                setIsCategoryEditOpen(false);
                                setCustomIconUrl('');
                            }} className="flex-1 py-3 rounded-xl font-bold text-white bg-black">{t.save}</button>
                        </div>
                    </div></div>}

                    {/* Expense Detail Modal */}
                    {isExpenseDetailOpen && isPersonalBook && (
                        <div className="fixed inset-0 z-[75] bg-gray-100 flex flex-col modal-enter">
                            <div className="bg-white px-6 py-4 shadow-sm flex items-center gap-2 sticky top-0 z-10">
                                <button onClick={() => setIsExpenseDetailOpen(false)} className="p-2 -ml-2 text-gray-600 hover:bg-gray-100 rounded-full"><Icons.Back /></button>
                                <h2 className="text-xl font-black text-gray-800">{t.expense_details}</h2>
                                <span className="bg-red-500 text-white px-2 py-0.5 rounded-full text-sm font-bold">{expenseTransactions.length}</span>
                            </div>
                            <div className="flex-1 overflow-y-auto p-4 space-y-3">
                                {expenseTransactions.length === 0 ? (
                                    <div className="text-center py-20 text-gray-400">{t.no_records}</div>
                                ) : (
                                    expenseTransactions.map((t_item) => {
                                        const categoryInfo = allCategories.find(c => c.id === t_item.category) || allCategories[allCategories.length - 1];
                                        return (
                                            <div key={t_item.id} className="bg-white p-4 rounded-2xl shadow-sm">
                                                <div className="flex items-start gap-3">
                                                    <div className="w-10 h-10 rounded-xl flex items-center justify-center text-2xl bg-gray-100">{categoryInfo.icon}</div>
                                                    <div className="flex-1 min-w-0">
                                                        <div className="text-xs font-bold text-gray-400 mb-0.5">{t_item.date}</div>
                                                        <p className="font-bold text-gray-800 text-lg leading-tight">{formatDescription(t_item.description)}</p>
                                                        <p className="text-xs text-gray-400 mt-1">{lang === 'zh' ? categoryInfo.name_zh : categoryInfo.name_en}</p>
                                                    </div>
                                                    <div className="text-right shrink-0">
                                                        <p className="text-xl font-black text-red-600">-{currentCurrency.symbol}{t_item.amount.toLocaleString()}</p>
                                                        {t_item.currency !== 'TWD' && <p className="text-xs font-bold text-gray-400 mt-1">â‰ˆ NT${(t_item.amountTWD || Math.round(t_item.amount * activeRate)).toLocaleString()}</p>}
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })
                                )}
                            </div>
                        </div>
                    )}

                    {/* Income Detail Modal */}
                    {isIncomeDetailOpen && isPersonalBook && (
                        <div className="fixed inset-0 z-[75] bg-gray-100 flex flex-col modal-enter">
                            <div className="bg-white px-6 py-4 shadow-sm flex items-center gap-2 sticky top-0 z-10">
                                <button onClick={() => setIsIncomeDetailOpen(false)} className="p-2 -ml-2 text-gray-600 hover:bg-gray-100 rounded-full"><Icons.Back /></button>
                                <h2 className="text-xl font-black text-gray-800">{t.income_details}</h2>
                                <span className="bg-green-500 text-white px-2 py-0.5 rounded-full text-sm font-bold">{incomeTransactions.length}</span>
                            </div>
                            <div className="flex-1 overflow-y-auto p-4 space-y-3">
                                {incomeTransactions.length === 0 ? (
                                    <div className="text-center py-20 text-gray-400">{t.no_records}</div>
                                ) : (
                                    incomeTransactions.map((t_item) => {
                                        const categoryInfo = allCategories.find(c => c.id === t_item.category) || allCategories[allCategories.length - 1];
                                        return (
                                            <div key={t_item.id} className="bg-white p-4 rounded-2xl shadow-sm">
                                                <div className="flex items-start gap-3">
                                                    <div className="w-10 h-10 rounded-xl flex items-center justify-center text-2xl bg-gray-100">{categoryInfo.icon}</div>
                                                    <div className="flex-1 min-w-0">
                                                        <div className="text-xs font-bold text-gray-400 mb-0.5">{t_item.date}</div>
                                                        <p className="font-bold text-gray-800 text-lg leading-tight">{formatDescription(t_item.description)}</p>
                                                        <p className="text-xs text-gray-400 mt-1">{lang === 'zh' ? categoryInfo.name_zh : categoryInfo.name_en}</p>
                                                    </div>
                                                    <div className="text-right shrink-0">
                                                        <p className="text-xl font-black text-green-600">+{currentCurrency.symbol}{t_item.amount.toLocaleString()}</p>
                                                        {t_item.currency !== 'TWD' && <p className="text-xs font-bold text-gray-400 mt-1">â‰ˆ NT${(t_item.amountTWD || Math.round(t_item.amount * activeRate)).toLocaleString()}</p>}
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })
                                )}
                            </div>
                        </div>
                    )}

                    {/* Scan Modal */}
                    {isScanOpen && <div className="fixed inset-0 z-[80] bg-black flex flex-col">
                        {/* å¾ç›¸ç°¿é¸æ“‡ç…§ç‰‡ */}
                        {!scanMode && !isScanning && (
                            <div className="flex-1 flex flex-col items-center justify-center p-6">
                                <h2 className="text-white text-2xl font-black mb-8">{t.scan}</h2>
                                <div className="space-y-4 w-full max-w-xs">
                                    <button onClick={() => fileInputRef.current?.click()} className="w-full bg-white text-black py-4 rounded-2xl font-bold flex items-center justify-center gap-3"><Icons.Image /> {t.choose_photo}</button>
                                    <input ref={fileInputRef} type="file" accept="image/*" onChange={handleFileSelect} className="hidden" />
                                </div>
                                <button onClick={cancelScan} className="mt-8 text-gray-400 font-bold">{t.cancel}</button>
                            </div>
                        )}
                        {/* é è¦½æ¨¡å¼ - é¡¯ç¤ºåœ–ç‰‡èˆ‡æŒ‡ä»¤è¼¸å…¥ */}
                        {scanMode === 'preview' && previewImage && !isScanning && (
                            <div className="flex-1 flex flex-col">
                                <button onClick={cancelScan} className="absolute top-4 right-4 bg-black/50 text-white text-xl w-10 h-10 rounded-full flex items-center justify-center z-10">âœ•</button>
                                <div className="flex-1 flex items-center justify-center overflow-hidden bg-gray-900">
                                    <img src={previewImage} alt="Preview" className="max-w-full max-h-[50vh] object-contain rounded-lg" />
                                </div>
                                <div className="p-4 bg-gray-900 space-y-3">
                                    <div>
                                        <label className="text-xs text-gray-400 font-bold mb-1 block">{t.enter_prompt || 'è¼¸å…¥æŒ‡ä»¤ (å¯é¸)'}</label>
                                        <textarea
                                            value={promptInput}
                                            onChange={(e) => setPromptInput(e.target.value)}
                                            className="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-xl text-white text-sm outline-none resize-none"
                                            rows={2}
                                        />
                                    </div>
                                    <div className="flex gap-3">
                                        <button onClick={retakePhoto} className="flex-1 py-3 bg-gray-700 text-white rounded-xl font-bold">{t.retake}</button>
                                        <button onClick={startAnalysis} className="flex-1 py-3 bg-white text-black rounded-xl font-bold flex items-center justify-center gap-2">ğŸš€ {t.start_analysis || 'é–‹å§‹åˆ†æ'}</button>
                                    </div>
                                </div>
                            </div>
                        )}
                        {/* è™•ç†ä¸­ç‹€æ…‹ */}
                        {(scanMode === 'processing' || isScanning) && (
                            <div className="flex-1 flex flex-col items-center justify-center p-6">
                                <div className="text-6xl mb-6 animate-bounce">ğŸ¤–</div>
                                <h2 className="text-white text-2xl font-black mb-2">AI åˆ†æä¸­...</h2>
                                <p className="text-gray-400 text-center">æ­£åœ¨è­˜åˆ¥äº¤æ˜“è¨˜éŒ„<br />è«‹ç¨å€™</p>
                                <div className="mt-8 flex gap-2">
                                    <div className="w-3 h-3 bg-white rounded-full animate-pulse"></div>
                                    <div className="w-3 h-3 bg-white rounded-full animate-pulse" style={{ animationDelay: '0.2s' }}></div>
                                    <div className="w-3 h-3 bg-white rounded-full animate-pulse" style={{ animationDelay: '0.4s' }}></div>
                                </div>
                            </div>
                        )}
                    </div>}

                    {/* Filter Modal */}
                    {isFilterOpen && (<div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm modal-enter"><div className="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl max-h-[80vh] overflow-y-auto no-scrollbar">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-xl font-black text-gray-800 flex items-center gap-2"><Icons.Filter /> {t.filter}</h3>
                            <button onClick={() => setIsFilterOpen(false)} className="p-2 bg-gray-100 rounded-full">âœ•</button>
                        </div>

                        {/* æ—¥æœŸç¯©é¸ */}
                        <div className="mb-4">
                            <label className="text-xs font-bold text-gray-400 block mb-2">{t.filter_date}</label>
                            <div className="grid grid-cols-3 gap-2 mb-3">
                                <button onClick={() => setFilterDateType('none')} className={`p-2 rounded-xl font-bold text-sm ${filterDateType === 'none' ? 'bg-black text-white' : 'bg-gray-100 text-gray-600'}`}>{t.no_filter}</button>
                                <button onClick={() => setFilterDateType('range')} className={`p-2 rounded-xl font-bold text-sm ${filterDateType === 'range' ? 'bg-black text-white' : 'bg-gray-100 text-gray-600'}`}>{t.date_range}</button>
                                <button onClick={() => setFilterDateType('single')} className={`p-2 rounded-xl font-bold text-sm ${filterDateType === 'single' ? 'bg-black text-white' : 'bg-gray-100 text-gray-600'}`}>{t.single_date}</button>
                            </div>
                            {filterDateType === 'range' && (
                                <div className="grid grid-cols-2 gap-2">
                                    <div><label className="text-xs text-gray-400 block mb-1">{t.start_date}</label><input type="date" value={filterStartDate} onChange={e => setFilterStartDate(e.target.value)} className="w-full bg-gray-50 px-3 py-2 rounded-xl text-sm font-bold outline-none" /></div>
                                    <div><label className="text-xs text-gray-400 block mb-1">{t.end_date}</label><input type="date" value={filterEndDate} onChange={e => setFilterEndDate(e.target.value)} className="w-full bg-gray-50 px-3 py-2 rounded-xl text-sm font-bold outline-none" /></div>
                                </div>
                            )}
                            {filterDateType === 'single' && (<input type="date" value={filterSingleDate} onChange={e => setFilterSingleDate(e.target.value)} className="w-full bg-gray-50 px-3 py-2 rounded-xl text-sm font-bold outline-none" />)}
                        </div>

                        {/* å€‹äººå¸³æœ¬ç¯©é¸ - é¡å‹ */}
                        {isPersonalBook && (
                            <div className="mb-4">
                                <label className="text-xs font-bold text-gray-400 block mb-2">{t.filter_type}</label>
                                <div className="flex flex-wrap gap-2">
                                    <button onClick={() => setFilterType('')} className={`px-3 py-2 rounded-xl font-bold text-sm ${filterType === '' ? 'bg-black text-white' : 'bg-gray-100 text-gray-600'}`}>{t.all}</button>
                                    <button onClick={() => setFilterType('expense')} className={`px-3 py-2 rounded-xl font-bold text-sm flex items-center gap-1 ${filterType === 'expense' ? 'bg-red-500 text-white' : 'bg-gray-100 text-gray-600'}`}>
                                        <Icons.TrendDown /> {t.expense}
                                    </button>
                                    <button onClick={() => setFilterType('income')} className={`px-3 py-2 rounded-xl font-bold text-sm flex items-center gap-1 ${filterType === 'income' ? 'bg-green-500 text-white' : 'bg-gray-100 text-gray-600'}`}>
                                        <Icons.TrendUp /> {t.income}
                                    </button>
                                </div>
                            </div>
                        )}

                        {/* å€‹äººå¸³æœ¬ç¯©é¸ - é¡åˆ¥ */}
                        {isPersonalBook && (
                            <div className="mb-4">
                                <label className="text-xs font-bold text-gray-400 block mb-2">{t.filter_category}</label>
                                <div className="flex flex-wrap gap-2 max-h-40 overflow-y-auto">
                                    <button onClick={() => setFilterCategory('')} className={`px-3 py-2 rounded-xl font-bold text-sm ${filterCategory === '' ? 'bg-black text-white' : 'bg-gray-100 text-gray-600'}`}>{t.all}</button>
                                    {allCategories.map(cat => (
                                        <button key={cat.id} onClick={() => setFilterCategory(cat.id)} className={`px-3 py-2 rounded-xl font-bold text-sm flex items-center gap-1 ${filterCategory === cat.id ? 'bg-purple-500 text-white' : 'bg-gray-100 text-gray-600'}`}>
                                            {renderCategoryIcon(cat.icon, 'text-base')} {lang === 'zh' ? cat.name_zh : cat.name_en}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* åœ˜é«”å¸³æœ¬ç¯©é¸ - ä»˜æ¬¾äºº */}
                        {!isPersonalBook && (
                            <div className="mb-4">
                                <label className="text-xs font-bold text-gray-400 block mb-2">{t.filter_payer}</label>
                                <div className="flex flex-wrap gap-2">
                                    <button onClick={() => setFilterPayer('')} className={`px-3 py-2 rounded-xl font-bold text-sm ${filterPayer === '' ? 'bg-black text-white' : 'bg-gray-100 text-gray-600'}`}>{t.all}</button>
                                    {bookMembers.map(m => (<button key={m} onClick={() => setFilterPayer(m)} className={`px-3 py-2 rounded-xl font-bold text-sm flex items-center gap-1 ${filterPayer === m ? 'bg-black text-white' : 'bg-gray-100 text-gray-600'}`}><span>{globalMembers[m]}</span> {m}</button>))}
                                </div>
                            </div>
                        )}

                        {/* åœ˜é«”å¸³æœ¬ç¯©é¸ - è¢«ä»˜æ¬¾äºº */}
                        {!isPersonalBook && (
                            <div className="mb-6">
                                <label className="text-xs font-bold text-gray-400 block mb-2">{t.filter_payee}</label>
                                <div className="flex flex-wrap gap-2">
                                    <button onClick={() => setFilterPayee('')} className={`px-3 py-2 rounded-xl font-bold text-sm ${filterPayee === '' ? 'bg-black text-white' : 'bg-gray-100 text-gray-600'}`}>{t.all}</button>
                                    {bookMembers.map(m => (<button key={m} onClick={() => setFilterPayee(m)} className={`px-3 py-2 rounded-xl font-bold text-sm flex items-center gap-1 ${filterPayee === m ? 'bg-black text-white' : 'bg-gray-100 text-gray-600'}`}><span>{globalMembers[m]}</span> {m}</button>))}
                                </div>
                            </div>
                        )}

                        <div className="flex gap-3">
                            <button onClick={clearFilters} className="flex-1 py-3 font-bold text-gray-500 bg-gray-100 rounded-xl">{t.clear_filter}</button>
                            <button onClick={applyFilters} className="flex-1 py-3 font-bold text-white bg-black rounded-xl">{t.apply_filter}</button>
                        </div>
                    </div></div>)}

                    {/* Filter Results */}
                    {hasActiveFilters && getFilteredResults.length > 0 && !viewingFilteredTx && (<div className="fixed inset-0 z-50 bg-gray-100 flex flex-col modal-enter">
                        <div className="bg-white px-6 py-4 shadow-sm flex items-center justify-between sticky top-0 z-10">
                            <div className="flex items-center gap-2">
                                <button onClick={clearFilters} className="p-2 -ml-2 text-gray-600 hover:bg-gray-100 rounded-full"><Icons.Back /></button>
                                <h2 className="text-xl font-black text-gray-800">{t.filter_results}</h2>
                                <span className="bg-blue-600 text-white px-2 py-0.5 rounded-full text-sm font-bold">{getFilteredResults.length}</span>
                            </div>
                            <button onClick={clearFilters} className="p-2 bg-gray-100 rounded-full text-gray-600 font-bold text-sm">âœ•</button>
                        </div>
                        <div className="filter-header-bar bg-blue-50 px-6 py-3 flex flex-wrap gap-2 text-sm">
                            {/* å€‹äººå¸³æœ¬ç¯©é¸æ¨™ç±¤ */}
                            {isPersonalBook && activeFilters.txType && (
                                <span className={`px-3 py-1 rounded-full font-bold ${activeFilters.txType === 'expense' ? 'bg-red-500 text-white' : 'bg-green-500 text-white'}`}>
                                    {activeFilters.txType === 'expense' ? t.expense : t.income}
                                </span>
                            )}
                            {isPersonalBook && activeFilters.category && (
                                <span className="bg-purple-500 text-white px-3 py-1 rounded-full font-bold flex items-center gap-1">
                                    {renderCategoryIcon(allCategories.find(c => c.id === activeFilters.category)?.icon, 'text-sm')}
                                    {lang === 'zh' ? allCategories.find(c => c.id === activeFilters.category)?.name_zh : allCategories.find(c => c.id === activeFilters.category)?.name_en}
                                </span>
                            )}
                            {/* åœ˜é«”å¸³æœ¬ç¯©é¸æ¨™ç±¤ */}
                            {!isPersonalBook && activeFilters.payer && (<span className="bg-white px-3 py-1 rounded-full font-bold text-gray-700">{t.payer}: {globalMembers[activeFilters.payer]} {activeFilters.payer}</span>)}
                            {!isPersonalBook && activeFilters.payee && (<span className="bg-green-600 text-white px-3 py-1 rounded-full font-bold">{t.filter_payee}: {globalMembers[activeFilters.payee]} {activeFilters.payee}</span>)}
                            {/* æ—¥æœŸç¯©é¸æ¨™ç±¤ */}
                            {activeFilters.dateType === 'single' && activeFilters.singleDate && (<span className="bg-white px-3 py-1 rounded-full font-bold text-gray-700">{t.date}: {activeFilters.singleDate}</span>)}
                            {activeFilters.dateType === 'range' && activeFilters.startDate && activeFilters.endDate && (<span className="bg-white px-3 py-1 rounded-full font-bold text-gray-700">{activeFilters.startDate} ~ {activeFilters.endDate}</span>)}
                        </div>
                        <div className="flex-1 overflow-y-auto p-4 space-y-3">
                            {getFilteredResults.map((item, idx) => {
                                const categoryInfo = allCategories.find(c => c.id === item.category) || allCategories[allCategories.length - 1];
                                return (
                                    <div key={idx} className="bg-white p-4 rounded-2xl shadow-sm border border-gray-200">
                                        <div className="flex justify-between items-start mb-3">
                                            <div className="flex items-start gap-3">
                                                {isPersonalBook && (
                                                    <div className="w-10 h-10 rounded-xl flex items-center justify-center bg-gray-100">
                                                        {renderCategoryIcon(categoryInfo.icon)}
                                                    </div>
                                                )}
                                                <div>
                                                    <div className="text-xs font-bold text-gray-400 mb-1">{item.date}</div>
                                                    <div className="font-bold text-gray-800 text-lg">{formatDescription(item.description)}</div>
                                                    {isPersonalBook && <div className="text-xs text-gray-400 mt-1">{lang === 'zh' ? categoryInfo.name_zh : categoryInfo.name_en}</div>}
                                                </div>
                                            </div>
                                            <div className="text-right">
                                                {!isPersonalBook && activeFilters.payee && (<div className="text-sm text-orange-600 font-bold mb-1">{t.paid_for}: {currentCurrency.symbol}{Math.round(item.paidForAmount).toLocaleString()}</div>)}
                                                <div className={`text-xl font-black ${isPersonalBook ? (item.txType === 'income' ? 'text-green-600' : 'text-red-600') : 'text-gray-800'}`}>
                                                    {isPersonalBook && (item.txType === 'income' ? '+' : '-')}{currentCurrency.symbol}{item.amount.toLocaleString()}
                                                </div>
                                            </div>
                                        </div>
                                        {!isPersonalBook && (
                                            <div className="flex gap-3 mb-3">
                                                {activeFilters.payer && (<div className="bg-gray-100 px-3 py-2 rounded-xl"><div className="text-xs text-gray-500 mb-1">{t.payer}:</div><div className="flex items-center gap-1"><span className="text-xl">{globalMembers[item.payer]}</span><span className="font-bold text-gray-800">{item.payer}</span></div></div>)}
                                                {activeFilters.payee && (<div className="bg-green-600 px-3 py-2 rounded-xl"><div className="text-xs text-green-100 mb-1">{t.filter_payee}:</div><div className="flex items-center gap-1"><span className="text-xl">{globalMembers[activeFilters.payee]}</span><span className="font-bold text-white">{activeFilters.payee}</span></div></div>)}
                                            </div>
                                        )}
                                        {!isPersonalBook && (
                                            <div className="flex justify-between items-center">
                                                <span className="text-sm text-gray-600 font-bold">{t.total_amount}: {currentCurrency.symbol}{item.amount.toLocaleString()}</span>
                                                <button onClick={() => setViewingFilteredTx(item)} className="flex items-center gap-1 px-3 py-1.5 bg-blue-600 text-white rounded-lg text-sm font-bold hover:bg-blue-700">{t.view_detail} <Icons.ChevronRight /></button>
                                            </div>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                    </div>)}

                    {/* Transaction Detail Modal */}
                    {viewingFilteredTx && (<div className="fixed inset-0 z-[70] flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm modal-enter"><div className="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl max-h-[80vh] overflow-y-auto no-scrollbar"><div className="flex justify-between items-center mb-4"><h3 className="text-xl font-black text-gray-800">{t.tx_detail}</h3><button onClick={() => setViewingFilteredTx(null)} className="p-2 bg-gray-100 rounded-full">âœ•</button></div><div className="space-y-4"><div className="bg-gray-50 p-4 rounded-2xl"><div className="grid grid-cols-2 gap-4"><div><div className="text-xs font-bold text-gray-400 mb-1">{t.payer}</div><div className="font-bold text-gray-800 flex items-center gap-2"><span className="text-2xl">{globalMembers[viewingFilteredTx.payer]}</span>{viewingFilteredTx.payer}</div></div><div><div className="text-xs font-bold text-gray-400 mb-1">{t.split_type}</div><div className="font-bold text-gray-800">{viewingFilteredTx.splitType === 'custom' ? t.custom_split : t.equal_split}</div></div></div></div><div className="bg-gray-50 p-4 rounded-2xl"><div className="text-xs font-bold text-gray-400 mb-2">{t.split_to}</div><div className="space-y-2">{viewingFilteredTx.involved.map(m => { const memberAmount = getMemberAmountInTx(viewingFilteredTx, m); const items = viewingFilteredTx.customItems && viewingFilteredTx.customItems[m]; const legacyItemName = viewingFilteredTx.customItemNames && viewingFilteredTx.customItemNames[m]; return (<div key={m} className="bg-white p-2 rounded-xl"><div className="flex justify-between items-center"><div className="flex items-center gap-2"><span>{globalMembers[m]}</span><span className="font-bold">{m}</span></div><span className="font-black text-gray-800">{currentCurrency.symbol}{Math.round(memberAmount).toLocaleString()}</span></div>{items && items.length > 0 && <div className="mt-1 ml-6 space-y-0.5">{items.map((it, idx) => (<div key={idx} className="text-xs text-purple-600">{it.name || t.item_name}: {currentCurrency.symbol}{parseFloat(it.amount) || 0}</div>))}</div>}{!items && legacyItemName && <div className="text-xs text-purple-600 ml-6">{legacyItemName}</div>}</div>); })}</div></div><div className="grid grid-cols-2 gap-4"><div className="bg-gray-50 p-4 rounded-2xl"><div className="text-xs font-bold text-gray-400 mb-1">{t.amount}</div><div className="text-2xl font-black text-gray-800">{currentCurrency.symbol}{viewingFilteredTx.amount.toLocaleString()}</div></div><div className="bg-gray-50 p-4 rounded-2xl"><div className="text-xs font-bold text-gray-400 mb-1">{t.date}</div><div className="font-bold text-gray-800">{viewingFilteredTx.date}</div></div></div><div className="bg-gray-50 p-4 rounded-2xl"><div className="text-xs font-bold text-gray-400 mb-1">{t.item}</div><div className="font-bold text-gray-800 text-lg">{formatDescription(viewingFilteredTx.description)}</div></div></div></div></div>)}

                    {/* Top Bar */}
                    <div className="bg-white rounded-b-3xl shadow-sm px-6 pt-8 pb-6 sticky top-0 z-20">
                        <div className="flex justify-between items-start mb-4">
                            <div className="flex items-center gap-3">
                                <button onClick={() => setIsMenuOpen(true)} className="p-2 -ml-2 rounded-full hover:bg-gray-100"><Icons.Menu /></button>
                                <div>
                                    <div className="flex items-center gap-2">
                                        <h1 className="text-xl font-black text-gray-800 leading-none">{currentBook.name}</h1>
                                        {isPersonalBook && <span className="bg-purple-100 text-purple-600 px-2 py-0.5 rounded text-xs font-bold">{globalMembers[currentBook.owner]}</span>}
                                    </div>
                                    <div className="flex items-center gap-2 mt-1">
                                        <span className="text-xs font-bold text-gray-400">{currentCurrency.code} {t.ledger}</span>
                                    </div>
                                </div>
                            </div>
                            {/* Camera on left side, Settings on right side */}
                            <div className="flex gap-2">
                                <button onClick={() => setIsScanOpen(true)} className="p-2 bg-gray-100 rounded-xl text-gray-500 hover:bg-gray-200"><Icons.Camera /></button>
                                <button onClick={() => setIsSettingsOpen(true)} className="p-2 bg-gray-100 rounded-xl text-gray-500 hover:bg-gray-200"><Icons.Settings /></button>
                            </div>
                        </div>

                        {/* Personal Book Summary */}
                        {isPersonalBook && monthlyStats && (
                            <div className="mb-4">
                                <div className="bg-gradient-to-r from-purple-500 to-indigo-600 rounded-2xl p-4 text-white">
                                    <div className="text-xs font-bold opacity-80 mb-1">{t.balance}</div>
                                    <div className={`text-3xl font-black ${monthlyStats.balance >= 0 ? '' : 'text-red-200'}`}>
                                        {monthlyStats.balance >= 0 ? '+' : ''}{currentCurrency.symbol}{Math.round(monthlyStats.balance).toLocaleString()}
                                    </div>
                                    {currentBook.currency !== 'TWD' && (
                                        <div className="text-sm font-bold opacity-70 mt-1">
                                            â‰ˆ NT${Math.round(monthlyStats.balance * activeRate).toLocaleString()}
                                        </div>
                                    )}
                                </div>
                                <div className="grid grid-cols-2 gap-3 mt-3">
                                    <div
                                        className="bg-red-50 rounded-xl p-3 cursor-pointer hover:bg-red-100 transition active:scale-95"
                                        onClick={() => setIsExpenseDetailOpen(true)}
                                    >
                                        <div className="flex items-center gap-1 text-xs font-bold text-red-500 mb-1"><Icons.TrendDown /> {t.total_expense}</div>
                                        <div className="text-xl font-black text-red-600">{currentCurrency.symbol}{Math.round(monthlyStats.totalExpense).toLocaleString()}</div>
                                        {currentBook.currency !== 'TWD' && (
                                            <div className="text-xs text-red-400 mt-1">â‰ˆ NT${Math.round(monthlyStats.totalExpense * activeRate).toLocaleString()}</div>
                                        )}
                                    </div>
                                    <div
                                        className="bg-green-50 rounded-xl p-3 cursor-pointer hover:bg-green-100 transition active:scale-95"
                                        onClick={() => setIsIncomeDetailOpen(true)}
                                    >
                                        <div className="flex items-center gap-1 text-xs font-bold text-green-500 mb-1"><Icons.TrendUp /> {t.total_income}</div>
                                        <div className="text-xl font-black text-green-600">{currentCurrency.symbol}{Math.round(monthlyStats.totalIncome).toLocaleString()}</div>
                                        {currentBook.currency !== 'TWD' && (
                                            <div className="text-xs text-green-400 mt-1">â‰ˆ NT${Math.round(monthlyStats.totalIncome * activeRate).toLocaleString()}</div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Shared Book Balance Cards */}
                        {!isPersonalBook && (
                            <div className="space-y-3 mb-2">
                                {bookMembers.map(m => {
                                    const balance = netBalances[m] || 0;
                                    return (
                                        <div key={m} className="bg-gray-50 rounded-xl p-3 flex justify-between items-center border border-gray-100">
                                            <div className="flex items-center gap-2">
                                                <span className="text-2xl">{globalMembers[m] || 'ğŸ‘»'}</span>
                                                <span className="font-bold text-gray-800">{m}</span>
                                            </div>
                                            <div className="flex items-center gap-3">
                                                {balance > 0.01 ? <span className="text-green-600 font-black">+{currentCurrency.symbol}{Math.round(balance).toLocaleString()}</span> : balance < -0.01 ? <span className="text-red-500 font-black">-{currentCurrency.symbol}{Math.abs(Math.round(balance)).toLocaleString()}</span> : <span className="text-gray-400 font-bold">{t.flat}</span>}
                                                <button onClick={() => setViewingMemberDebt(m)} className="bg-white border border-gray-200 px-3 py-1 rounded-lg text-xs font-bold text-gray-600 hover:bg-gray-100 flex items-center gap-1"><Icons.Eye /> {t.detail}</button>
                                            </div>
                                        </div>
                                    )
                                })}
                            </div>
                        )}
                        {(isPersonalBook ? transactions.length > 0 : totalSpent !== 0) && <button onClick={handleSettleUp} className="settle-btn mt-2 w-full bg-gray-900 text-white py-3 rounded-xl font-bold shadow-lg active:scale-95 transition-all flex items-center justify-center gap-2"><Icons.Check /> {t.settle_period}</button>}
                    </div>

                    {/* Transactions List */}
                    <div className="max-w-xl mx-auto px-4 py-4 space-y-3">
                        {transactions.length > 0 && (<div className="flex justify-end mb-2"><button onClick={() => setIsFilterOpen(true)} className="px-3 py-2 bg-gray-100 text-gray-600 hover:bg-gray-200 rounded-xl font-bold text-sm flex items-center gap-1 transition"><Icons.Filter /> {t.filter}</button></div>)}
                        {loading && <div className="text-center text-gray-400 py-10">Loading...</div>}
                        {!loading && transactions.length === 0 && <div className="text-center py-20 text-gray-400 opacity-50"><p className="text-4xl mb-2">âœ¨</p><p>{t.start_note}</p></div>}
                        {transactions.map((t_item, index) => {
                            const avatar = globalMembers[t_item.payer] || 'ğŸ‘»';
                            const involvedCount = t_item.involved ? t_item.involved.length : bookMembers.length;
                            const categoryInfo = allCategories.find(c => c.id === t_item.category) || allCategories[allCategories.length - 1];
                            const descWithInfo = t_item.description + (t_item.splitType === 'custom' ? ' (ABåˆ†)' : '');
                            const isLongDesc = descWithInfo.length > 12;
                            const prevItem = index > 0 ? transactions[index - 1] : null;
                            const showDateHeader = !prevItem || prevItem.date !== t_item.date;
                            const formattedDate = t_item.date ? t_item.date.slice(5).replace('-', '/') : '';

                            if (isPersonalBook) {
                                return (
                                    <React.Fragment key={t_item.id}>
                                        {showDateHeader && <div className="text-lg font-black text-gray-500 mt-4 mb-2 ml-1">{formattedDate}</div>}
                                        <SwipeToDelete onDelete={() => handleDelete(t_item.id)}>
                                            <div className="bg-white p-4 rounded-2xl shadow-sm border border-transparent hover:border-gray-200 transition-all">
                                                <div className="flex items-start gap-3 mb-2">
                                                    <div className="w-10 h-10 rounded-xl flex items-center justify-center text-2xl bg-gray-100">{renderCategoryIcon(categoryInfo.icon)}</div>
                                                    <div className="flex-1 min-w-0">
                                                        <div className="flex items-start justify-between gap-3">
                                                            <p className="font-bold text-gray-800 text-lg leading-tight">{formatDescription(t_item.description)}</p>
                                                            <div className="text-right shrink-0">
                                                                <p className={`text-xl font-black ${t_item.txType === 'income' ? 'text-green-600' : 'text-red-600'}`}>
                                                                    {t_item.txType === 'income' ? '+' : '-'}{currentCurrency.symbol}{t_item.amount.toLocaleString()}
                                                                </p>
                                                            </div>
                                                        </div>
                                                        <p className="text-xs text-gray-400 mt-1">{lang === 'zh' ? categoryInfo.name_zh : categoryInfo.name_en}</p>
                                                    </div>
                                                </div>
                                                <div className="flex justify-end gap-1 mt-2 pt-2 border-t border-gray-50">
                                                    <button onClick={() => openModal(t_item)} className="p-2 text-gray-400 hover:bg-gray-100 rounded-lg"><Icons.Edit /></button>
                                                    <button onClick={() => handleDelete(t_item.id)} className="p-2 text-gray-400 hover:bg-red-50 hover:text-red-500 rounded-lg"><Icons.Trash /></button>
                                                </div>
                                            </div>
                                        </SwipeToDelete>
                                    </React.Fragment>
                                );
                            }

                            return (
                                <React.Fragment key={t_item.id}>
                                    {showDateHeader && <div className="text-lg font-black text-gray-500 mt-4 mb-2 ml-1">{formattedDate}</div>}
                                    <SwipeToDelete onDelete={() => handleDelete(t_item.id)}>
                                        <div className="bg-white p-4 rounded-2xl shadow-sm border border-transparent hover:border-gray-200 transition-all">
                                            <div onClick={() => setViewingFilteredTx(t_item)} className="flex items-start gap-3 mb-2 cursor-pointer active:opacity-70">
                                                <div className="flex flex-col items-center min-w-[3rem]">
                                                    <div className="w-10 h-10 rounded-xl flex items-center justify-center text-2xl font-bold shadow-sm bg-gray-100">{avatar}</div>
                                                    <span className="text-[10px] font-bold text-gray-400 mt-1 text-center leading-tight">{t_item.payer}</span>
                                                </div>
                                                <div className="flex-1 min-w-0">
                                                    {isLongDesc ? (
                                                        <div>
                                                            <p className="font-bold text-gray-800 text-lg leading-tight">{formatDescription(t_item.description)}{t_item.splitType === 'custom' && <span className="ml-1 bg-purple-100 text-purple-600 px-1.5 py-0.5 rounded text-[10px] font-bold align-middle">ABåˆ†</span>}</p>
                                                            <div className="flex items-center justify-between mt-1">
                                                                <p className="text-xs text-gray-400 flex items-center gap-1"><Icons.Users /> {involvedCount} {t.involved}</p>
                                                                <div className="text-right">
                                                                    <span className="text-xl font-black text-gray-800">{currentCurrency.symbol}{t_item.amount.toLocaleString()}</span>
                                                                    {t_item.currency !== 'TWD' && <span className="text-xs font-bold text-gray-400 ml-2">â‰ˆ NT${(t_item.amountTWD || Math.round(t_item.amount * activeRate)).toLocaleString()}</span>}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    ) : (
                                                        <div className="flex items-start justify-between gap-3">
                                                            <div className="min-w-0">
                                                                <p className="font-bold text-gray-800 text-lg leading-tight">{formatDescription(t_item.description)}{t_item.splitType === 'custom' && <span className="ml-1 bg-purple-100 text-purple-600 px-1.5 py-0.5 rounded text-[10px] font-bold align-middle">ABåˆ†</span>}</p>
                                                                <p className="text-xs text-gray-400 mt-1 flex items-center gap-1"><Icons.Users /> {involvedCount} {t.involved}</p>
                                                            </div>
                                                            <div className="text-right shrink-0">
                                                                <p className="text-xl font-black text-gray-800">{currentCurrency.symbol}{t_item.amount.toLocaleString()}</p>
                                                                {t_item.currency !== 'TWD' && <p className="text-xs font-bold text-gray-400 mt-1">â‰ˆ NT${(t_item.amountTWD || Math.round(t_item.amount * activeRate)).toLocaleString()}</p>}
                                                            </div>
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                            <div className="flex justify-end gap-1 mt-2 pt-2 border-t border-gray-50">
                                                <button onClick={() => openModal(t_item)} className="p-2 text-gray-400 hover:bg-gray-100 rounded-lg"><Icons.Edit /></button>
                                                <button onClick={() => handleDelete(t_item.id)} className="p-2 text-gray-400 hover:bg-red-50 hover:text-red-500 rounded-lg"><Icons.Trash /></button>
                                            </div>
                                        </div>
                                    </SwipeToDelete>
                                </React.Fragment>
                            );
                        })}
                        <div ref={bottomRef} />
                    </div>

                    <button onClick={() => openModal(null)} className="fab-btn fixed bottom-6 right-6 w-16 h-16 bg-gray-900 text-white rounded-full shadow-2xl flex items-center justify-center btn-press z-30"><Icons.Plus /></button>

                    {/* Member Detail Modal */}
                    {viewingMemberDebt && !isPersonalBook && (<div className="fixed inset-0 z-[80] flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm modal-enter" onClick={(e) => { if (e.target === e.currentTarget) { setViewingMemberDebt(null); setExpandedDebtDetail(null); } }}><div className="bg-white w-full max-w-sm rounded-3xl shadow-2xl max-h-[85vh] overflow-hidden flex flex-col">
                        {/* Header */}
                        <div className="p-6 pb-3 border-b border-gray-100">
                            <div className="flex justify-between items-center mb-3">
                                <div className="flex items-center gap-3">
                                    <div className="w-12 h-12 rounded-full bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center text-2xl shadow-lg">{globalMembers[viewingMemberDebt]}</div>
                                    <div>
                                        <h3 className="text-xl font-black text-gray-800">{viewingMemberDebt}</h3>
                                        <p className="text-xs text-gray-400">{lang === 'zh' ? 'å¸³å‹™æ˜ç´°' : 'Account Details'}</p>
                                    </div>
                                </div>
                                <button onClick={() => { setViewingMemberDebt(null); setExpandedDebtDetail(null); }} className="p-2 bg-gray-100 rounded-full hover:bg-gray-200">âœ•</button>
                            </div>
                            {/* Summary Bar */}
                            {(() => {
                                const { toPay, toReceive } = getMemberDebtDetail(viewingMemberDebt);
                                const totalPay = toPay.reduce((sum, d) => sum + d.amount, 0);
                                const totalReceive = toReceive.reduce((sum, d) => sum + d.amount, 0);
                                const netBalance = totalReceive - totalPay;
                                return (
                                    <div className="flex gap-2 text-center">
                                        <div className="flex-1 bg-red-50 rounded-xl p-2">
                                            <div className="text-[10px] font-bold text-red-400 uppercase">{t.payables}</div>
                                            <div className="text-lg font-black text-red-600">{currentCurrency.symbol}{Math.round(totalPay).toLocaleString()}</div>
                                        </div>
                                        <div className="flex-1 bg-green-50 rounded-xl p-2">
                                            <div className="text-[10px] font-bold text-green-400 uppercase">{t.receivables}</div>
                                            <div className="text-lg font-black text-green-600">{currentCurrency.symbol}{Math.round(totalReceive).toLocaleString()}</div>
                                        </div>
                                        <div className={`flex-1 rounded-xl p-2 ${netBalance >= 0 ? 'bg-blue-50' : 'bg-orange-50'}`}>
                                            <div className="text-[10px] font-bold text-gray-400 uppercase">{lang === 'zh' ? 'æ·¨é¡' : 'Net'}</div>
                                            <div className={`text-lg font-black ${netBalance >= 0 ? 'text-blue-600' : 'text-orange-600'}`}>
                                                {netBalance >= 0 ? '+' : ''}{currentCurrency.symbol}{Math.round(netBalance).toLocaleString()}
                                            </div>
                                        </div>
                                    </div>
                                );
                            })()}
                        </div>
                        {/* Swipe Hint */}
                        <div className="px-6 py-2 bg-gray-50 border-b border-gray-100">
                            <p className="text-[10px] text-gray-400 text-center font-medium">{lang === 'zh' ? 'ğŸ’¡ å·¦æ»‘çµæ¸… Â· å·²çµæ¸…é …ç›®å³æ»‘å–æ¶ˆ' : 'ğŸ’¡ Swipe left to clear Â· right to undo'}</p>
                        </div>
                        {/* Scrollable Content */}
                        <div className="flex-1 overflow-y-auto p-4 space-y-4 no-scrollbar">{(() => {
                            const { toPay, toReceive, myExpense } = getMemberDebtDetail(viewingMemberDebt); return (<>
                                {toPay.length > 0 && (<div className="mb-4">
                                    <div className="flex items-center gap-2 mb-3">
                                        <div className="w-6 h-6 bg-red-500 rounded-full flex items-center justify-center">
                                            <span className="text-white text-xs">â–¼</span>
                                        </div>
                                        <p className="text-sm font-bold text-red-600">{t.payables}</p>
                                        <span className="text-xs text-gray-400">({toPay.length})</span>
                                    </div>
                                    <div className="space-y-2">
                                        {toPay.map((d, i) => {
                                            const isExpanded = expandedDebtDetail && expandedDebtDetail.type === 'pay' && expandedDebtDetail.person === d.to;
                                            const details = getDetailBetweenTwo(viewingMemberDebt, d.to);
                                            const clearedAmount = getClearedAmountBetweenTwo(viewingMemberDebt, d.to);
                                            const remainingAmount = Math.round(d.amount + clearedAmount);
                                            const isAllCleared = isAllClearedBetweenTwo(viewingMemberDebt, d.to);
                                            const clearedCount = details.filter(item => isTransactionCleared(item.id, viewingMemberDebt, d.to)).length;
                                            return (<div key={i} className="bg-white rounded-2xl shadow-sm overflow-hidden border border-gray-100">
                                                <div className={`flex items-center p-4 transition-all ${isAllCleared ? 'bg-gray-100' : ''}`}>
                                                    <div className="w-10 h-10 rounded-full bg-red-100 flex items-center justify-center text-lg mr-3 shrink-0">
                                                        {globalMembers[d.to]}
                                                    </div>
                                                    <div className="flex-1 min-w-0" onClick={() => setExpandedDebtDetail(isExpanded ? null : { type: 'pay', person: d.to })}>
                                                        <div className="flex items-center gap-1">
                                                            <span className={`font-bold text-gray-800 ${isAllCleared ? 'line-through opacity-60' : ''}`}>{t.give} {d.to}</span>
                                                            {isAllCleared && <span className="text-xs bg-gray-200 text-gray-500 px-1.5 py-0.5 rounded">{t.cleared}</span>}
                                                        </div>
                                                        <div className="flex items-center gap-2 mt-1">
                                                            <span className="text-xs text-gray-400">{details.length} {lang === 'zh' ? 'ç­†æ˜ç´°' : 'items'}</span>
                                                            {clearedCount > 0 && <span className="text-xs text-green-500">{clearedCount} {t.cleared}</span>}
                                                        </div>
                                                    </div>
                                                    <div className="text-right ml-2">
                                                        {isAllCleared ? (
                                                            <span className="text-lg font-black text-gray-400 line-through">{currentCurrency.symbol}{Math.round(d.amount).toLocaleString()}</span>
                                                        ) : clearedAmount !== 0 ? (
                                                            <div>
                                                                <span className="text-lg font-black text-red-600">{currentCurrency.symbol}{remainingAmount.toLocaleString()}</span>
                                                                <div className="text-xs text-gray-400 line-through">{currentCurrency.symbol}{Math.round(d.amount).toLocaleString()}</div>
                                                            </div>
                                                        ) : (
                                                            <span className="text-lg font-black text-red-600">{currentCurrency.symbol}{Math.round(d.amount).toLocaleString()}</span>
                                                        )}
                                                    </div>
                                                    <button
                                                        onClick={(e) => { e.stopPropagation(); isAllCleared ? unclearAllBetweenTwo(viewingMemberDebt, d.to) : clearAllBetweenTwo(viewingMemberDebt, d.to); }}
                                                        className={`ml-3 w-8 h-8 rounded-full flex items-center justify-center transition-all shrink-0 ${isAllCleared ? 'bg-green-500 text-white' : 'border-2 border-gray-300 text-gray-300 hover:border-green-500 hover:text-green-500'}`}
                                                    >
                                                        {isAllCleared ? 'âœ“' : ''}
                                                    </button>
                                                </div>
                                                {isExpanded && details.length > 0 && (
                                                    <div className="bg-gray-50 border-t border-gray-100 p-3 space-y-2">
                                                        {details.map((item, j) => {
                                                            const isCleared = isTransactionCleared(item.id, viewingMemberDebt, d.to);
                                                            return (
                                                                <SwipeToClear
                                                                    key={j}
                                                                    onClear={() => clearTransaction(item.id, viewingMemberDebt, d.to)}
                                                                    onUnclear={() => unclearTransaction(item.id, viewingMemberDebt, d.to)}
                                                                    isCleared={isCleared}
                                                                    clearText={t.mark_cleared}
                                                                >
                                                                    <div className={`flex items-center justify-between p-3 rounded-xl ${isCleared ? 'bg-green-50 border border-green-200' : 'bg-white border border-gray-100'}`}>
                                                                        <div className="flex-1 min-w-0">
                                                                            <div className="flex items-center gap-2">
                                                                                <span className={`text-sm font-bold text-gray-800 ${isCleared ? 'line-through opacity-60' : ''}`}>
                                                                                    {formatDescription(item.description)}
                                                                                </span>
                                                                                {isCleared && <span className="text-[10px] bg-green-500 text-white px-1.5 py-0.5 rounded">âœ“</span>}
                                                                            </div>
                                                                            <div className="flex items-center gap-2 mt-1">
                                                                                <span className="text-xs text-gray-400">{item.date}</span>
                                                                                <span className="text-xs text-gray-300">â€¢</span>
                                                                                <span className="text-xs text-gray-400">{item.payer} {t.other_paid}</span>
                                                                            </div>
                                                                        </div>
                                                                        <span className={`text-base font-black ml-2 ${isCleared ? 'text-gray-400 line-through' : 'text-red-600'}`}>
                                                                            -{currentCurrency.symbol}{Math.round(item.amount).toLocaleString()}
                                                                        </span>
                                                                    </div>
                                                                </SwipeToClear>
                                                            );
                                                        })}
                                                    </div>
                                                )}
                                            </div>);
                                        })}
                                    </div>
                                </div>)}
                                {toReceive.length > 0 && (<div className="mb-4">
                                    <div className="flex items-center gap-2 mb-3">
                                        <div className="w-6 h-6 bg-green-500 rounded-full flex items-center justify-center">
                                            <span className="text-white text-xs">â–²</span>
                                        </div>
                                        <p className="text-sm font-bold text-green-600">{t.receivables}</p>
                                        <span className="text-xs text-gray-400">({toReceive.length})</span>
                                    </div>
                                    <div className="space-y-2">
                                        {toReceive.map((d, i) => {
                                            const isExpanded = expandedDebtDetail && expandedDebtDetail.type === 'receive' && expandedDebtDetail.person === d.from;
                                            const details = getDetailBetweenTwo(viewingMemberDebt, d.from);
                                            const clearedAmount = getClearedAmountBetweenTwo(viewingMemberDebt, d.from);
                                            const remainingAmount = Math.round(d.amount - clearedAmount);
                                            const isAllCleared = isAllClearedBetweenTwo(viewingMemberDebt, d.from);
                                            const clearedCount = details.filter(item => isTransactionCleared(item.id, viewingMemberDebt, d.from)).length;
                                            return (<div key={i} className="bg-white rounded-2xl shadow-sm overflow-hidden border border-gray-100">
                                                <div className={`flex items-center p-4 transition-all ${isAllCleared ? 'bg-gray-100' : ''}`}>
                                                    <div className="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center text-lg mr-3 shrink-0">
                                                        {globalMembers[d.from]}
                                                    </div>
                                                    <div className="flex-1 min-w-0" onClick={() => setExpandedDebtDetail(isExpanded ? null : { type: 'receive', person: d.from })}>
                                                        <div className="flex items-center gap-1">
                                                            <span className={`font-bold text-gray-800 ${isAllCleared ? 'line-through opacity-60' : ''}`}>{t.receive} {d.from}</span>
                                                            {isAllCleared && <span className="text-xs bg-gray-200 text-gray-500 px-1.5 py-0.5 rounded">{t.cleared}</span>}
                                                        </div>
                                                        <div className="flex items-center gap-2 mt-1">
                                                            <span className="text-xs text-gray-400">{details.length} {lang === 'zh' ? 'ç­†æ˜ç´°' : 'items'}</span>
                                                            {clearedCount > 0 && <span className="text-xs text-green-500">{clearedCount} {t.cleared}</span>}
                                                        </div>
                                                    </div>
                                                    <div className="text-right ml-2">
                                                        {isAllCleared ? (
                                                            <span className="text-lg font-black text-gray-400 line-through">{currentCurrency.symbol}{Math.round(d.amount).toLocaleString()}</span>
                                                        ) : clearedAmount !== 0 ? (
                                                            <div>
                                                                <span className="text-lg font-black text-green-600">{currentCurrency.symbol}{remainingAmount.toLocaleString()}</span>
                                                                <div className="text-xs text-gray-400 line-through">{currentCurrency.symbol}{Math.round(d.amount).toLocaleString()}</div>
                                                            </div>
                                                        ) : (
                                                            <span className="text-lg font-black text-green-600">{currentCurrency.symbol}{Math.round(d.amount).toLocaleString()}</span>
                                                        )}
                                                    </div>
                                                    <button
                                                        onClick={(e) => { e.stopPropagation(); isAllCleared ? unclearAllBetweenTwo(viewingMemberDebt, d.from) : clearAllBetweenTwo(viewingMemberDebt, d.from); }}
                                                        className={`ml-3 w-8 h-8 rounded-full flex items-center justify-center transition-all shrink-0 ${isAllCleared ? 'bg-green-500 text-white' : 'border-2 border-gray-300 text-gray-300 hover:border-green-500 hover:text-green-500'}`}
                                                    >
                                                        {isAllCleared ? 'âœ“' : ''}
                                                    </button>
                                                </div>
                                                {isExpanded && details.length > 0 && (
                                                    <div className="bg-gray-50 border-t border-gray-100 p-3 space-y-2">
                                                        {details.map((item, j) => {
                                                            const isCleared = isTransactionCleared(item.id, viewingMemberDebt, d.from);
                                                            return (
                                                                <SwipeToClear
                                                                    key={j}
                                                                    onClear={() => clearTransaction(item.id, viewingMemberDebt, d.from)}
                                                                    onUnclear={() => unclearTransaction(item.id, viewingMemberDebt, d.from)}
                                                                    isCleared={isCleared}
                                                                    clearText={t.mark_cleared}
                                                                >
                                                                    <div className={`flex items-center justify-between p-3 rounded-xl ${isCleared ? 'bg-green-50 border border-green-200' : 'bg-white border border-gray-100'}`}>
                                                                        <div className="flex-1 min-w-0">
                                                                            <div className="flex items-center gap-2">
                                                                                <span className={`text-sm font-bold text-gray-800 ${isCleared ? 'line-through opacity-60' : ''}`}>
                                                                                    {formatDescription(item.description)}
                                                                                </span>
                                                                                {isCleared && <span className="text-[10px] bg-green-500 text-white px-1.5 py-0.5 rounded">âœ“</span>}
                                                                            </div>
                                                                            <div className="flex items-center gap-2 mt-1">
                                                                                <span className="text-xs text-gray-400">{item.date}</span>
                                                                                <span className="text-xs text-gray-300">â€¢</span>
                                                                                <span className="text-xs text-gray-400">{item.payer} {t.other_paid}</span>
                                                                            </div>
                                                                        </div>
                                                                        <span className={`text-base font-black ml-2 ${isCleared ? 'text-gray-400 line-through' : 'text-green-600'}`}>
                                                                            +{currentCurrency.symbol}{Math.round(item.amount).toLocaleString()}
                                                                        </span>
                                                                    </div>
                                                                </SwipeToClear>
                                                            );
                                                        })}
                                                    </div>
                                                )}
                                            </div>);
                                        })}
                                    </div>
                                </div>)}
                                {myExpense.expenseItems.length > 0 && (<div className="mb-4">
                                    <div className="flex items-center gap-2 mb-3">
                                        <div className="w-6 h-6 bg-blue-500 rounded-full flex items-center justify-center">
                                            <span className="text-white text-xs">ğŸ“Š</span>
                                        </div>
                                        <p className="text-sm font-bold text-blue-600">{t.my_expense}</p>
                                        <span className="text-xs text-gray-400">({myExpense.expenseItems.length})</span>
                                    </div>
                                    <div className="bg-white rounded-2xl shadow-sm overflow-hidden border border-gray-100">
                                        <div className="divide-y divide-gray-50">
                                            {myExpense.expenseItems.slice(0, 5).map((item, i) => (
                                                <div key={i} className="flex items-center justify-between p-3">
                                                    <div className="flex-1 min-w-0">
                                                        <span className="text-sm font-bold text-gray-800">{formatDescription(item.description)}</span>
                                                        <div className="flex items-center gap-2 mt-1">
                                                            <span className="text-xs text-gray-400">{item.date}</span>
                                                            <span className="text-xs text-gray-300">â€¢</span>
                                                            <span className="text-xs text-gray-400">{item.payer === viewingMemberDebt ? t.self_paid : item.payer + t.other_paid}</span>
                                                        </div>
                                                    </div>
                                                    <span className="font-bold text-blue-600 ml-2">{currentCurrency.symbol}{Math.round(item.amount).toLocaleString()}</span>
                                                </div>
                                            ))}
                                        </div>
                                        {myExpense.expenseItems.length > 5 && (
                                            <div className="p-2 bg-gray-50 text-center">
                                                <span className="text-xs text-gray-400">+{myExpense.expenseItems.length - 5} {lang === 'zh' ? 'æ›´å¤šé …ç›®' : 'more items'}</span>
                                            </div>
                                        )}
                                        <div className="bg-blue-50 p-4 flex justify-between items-center">
                                            <span className="font-bold text-gray-700">{t.my_expense_total}</span>
                                            <span className="text-xl font-black text-blue-700">{currentCurrency.symbol}{Math.round(myExpense.totalExpense).toLocaleString()}</span>
                                        </div>
                                    </div>
                                </div>)}
                                {toPay.length === 0 && toReceive.length === 0 && myExpense.expenseItems.length === 0 && (
                                    <div className="text-center py-10">
                                        <div className="text-4xl mb-3">ğŸ‰</div>
                                        <p className="text-gray-400 font-bold">{t.settled}</p>
                                        <p className="text-xs text-gray-300 mt-1">{lang === 'zh' ? 'ç›®å‰æ²’æœ‰å¾…è™•ç†çš„å¸³å‹™' : 'No pending transactions'}</p>
                                    </div>
                                )}
                            </>);
                        })()}</div></div></div>)}

                    {/* Transaction Modal */}
                    {isModalOpen && (<div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center p-0 sm:p-4"><div className="absolute inset-0 bg-black/30 backdrop-blur-sm" onClick={closeModal}></div><div className="bg-white w-full max-w-md rounded-t-3xl sm:rounded-3xl p-6 modal-enter relative z-50 shadow-2xl max-h-[90vh] overflow-y-auto no-scrollbar">
                        <div className="flex justify-between items-center mb-6"><h3 className="text-xl font-black text-gray-800">{editingId ? t.update : t.add} ({currentCurrency.code})</h3><button onClick={closeModal} className="p-2 bg-gray-100 rounded-full text-gray-500">âœ•</button></div>

                        {isPersonalBook ? (
                            <div className="space-y-5">
                                <div><label className="text-xs font-bold text-gray-400 ml-1 mb-2 block uppercase">{t.type}</label><div className="grid grid-cols-2 gap-3">
                                    <button onClick={() => setFormData({ ...formData, txType: 'expense' })} className={`p-3 rounded-2xl border-2 font-bold text-base transition-all flex items-center justify-center gap-2 ${formData.txType === 'expense' ? 'border-red-500 bg-red-50 text-red-700' : 'border-gray-100 text-gray-400'}`}><Icons.TrendDown /> {t.expense}</button>
                                    <button onClick={() => setFormData({ ...formData, txType: 'income' })} className={`p-3 rounded-2xl border-2 font-bold text-base transition-all flex items-center justify-center gap-2 ${formData.txType === 'income' ? 'border-green-500 bg-green-50 text-green-700' : 'border-gray-100 text-gray-400'}`}><Icons.TrendUp /> {t.income}</button>
                                </div></div>
                                <div><label className="text-xs font-bold text-gray-400 ml-1 mb-2 block uppercase">{t.category}</label><div className="grid grid-cols-5 gap-2">{allCategories.map(cat => (<button key={cat.id} onClick={() => setFormData({ ...formData, category: cat.id })} className={`p-2 rounded-xl text-center transition-all ${formData.category === cat.id ? 'bg-black text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}><div className="text-xl flex items-center justify-center h-6">{renderCategoryIcon(cat.icon, 'text-xl')}</div><div className="text-[10px] font-bold">{lang === 'zh' ? cat.name_zh : cat.name_en}</div></button>))}</div></div>
                                <div className="flex gap-3"><div className="flex-1"><label className="text-xs font-bold text-gray-400 ml-1 mb-1 block uppercase">{t.amount}</label><input type="number" inputMode="decimal" value={formData.amount} onChange={(e) => setFormData({ ...formData, amount: e.target.value })} className="w-full px-4 py-4 bg-gray-50 border-none rounded-2xl text-2xl font-black text-gray-800 outline-none" placeholder="0" /></div>{currentBook.currency !== 'TWD' && (<div className="w-28"><label className="text-xs font-bold text-gray-400 ml-1 mb-1 block uppercase">{t.rate_settings}</label><input type="number" inputMode="decimal" step="0.0001" value={formData.exchangeRate} onChange={(e) => setFormData({ ...formData, exchangeRate: e.target.value })} className="w-full px-4 py-4 bg-gray-50 border-none rounded-2xl text-xl font-bold text-gray-800 outline-none" placeholder={activeRate} /></div>)}</div>
                                <div className="grid grid-cols-3 gap-3"><div><label className="text-xs font-bold text-gray-400 ml-1 mb-1 block uppercase">{t.date}</label><input type="date" value={formData.date} onChange={(e) => setFormData({ ...formData, date: e.target.value })} className="w-full px-2 py-3 bg-gray-50 border-none rounded-xl text-sm font-bold text-gray-800 outline-none" /></div><div className="col-span-2"><label className="text-xs font-bold text-gray-400 ml-1 mb-1 block uppercase">{t.item}</label><input type="text" value={formData.description} onChange={(e) => setFormData({ ...formData, description: e.target.value })} placeholder="e.g. Coffee" className="w-full px-4 py-3 bg-gray-50 border-none rounded-xl text-base font-bold text-gray-800 outline-none" /></div></div>
                                <button onClick={handleSave} className="w-full bg-black text-white py-4 rounded-2xl font-bold text-lg shadow-xl btn-press mt-4">{editingId ? t.update : t.confirm}</button>
                            </div>
                        ) : (
                            <div className="space-y-5">
                                <div><label className="text-xs font-bold text-gray-400 ml-1 mb-2 block uppercase">{t.payer}</label><div className="flex flex-wrap gap-3">{bookMembers.map((m) => { const isSelected = formData.payer === m; return (<button key={m} onClick={() => setFormData({ ...formData, payer: m })} className={`flex-1 min-w-[30%] p-3 rounded-2xl border-2 font-bold text-base transition-all flex flex-col items-center gap-1 ${isSelected ? 'border-black bg-black text-white' : 'border-gray-100 text-gray-400'}`}><span className="text-xl">{globalMembers[m] || 'ğŸ‘»'}</span>{m}</button>) })}</div></div>
                                <div><label className="text-xs font-bold text-gray-400 ml-1 mb-2 block uppercase">{t.split_type}</label><div className="grid grid-cols-2 gap-3"><button onClick={() => handleSplitTypeChange('equal')} className={`p-3 rounded-2xl border-2 font-bold text-base transition-all ${formData.splitType === 'equal' ? 'border-green-500 bg-green-50 text-green-700' : 'border-gray-100 text-gray-400'}`}>{t.equal_split}</button><button onClick={() => handleSplitTypeChange('custom')} className={`p-3 rounded-2xl border-2 font-bold text-base transition-all ${formData.splitType === 'custom' ? 'border-purple-500 bg-purple-50 text-purple-700' : 'border-gray-100 text-gray-400'}`}>{t.custom_split}</button></div></div>
                                <div><label className="text-xs font-bold text-gray-400 ml-1 mb-2 block uppercase">{t.split_target}</label><div className="space-y-3">{bookMembers.map(m => { const isIncluded = (formData.involved || bookMembers).includes(m); const perPersonAmount = formData.splitType === 'equal' && formData.amount && formData.involved.length > 0 ? (parseFloat(formData.amount) / formData.involved.length) : 0; const memberItems = formData.customItems[m] || []; const memberTotal = getMemberCustomTotal(m); return (<div key={m} className="space-y-2"><button onClick={() => toggleInvolvedMember(m)} className={`w-full p-3 rounded-xl border-2 font-bold text-sm flex items-center gap-2 ${isIncluded ? 'border-green-500 bg-green-50 text-green-700' : 'border-gray-200 text-gray-300'}`}><div className={`w-5 h-5 rounded-full border-2 flex items-center justify-center ${isIncluded ? 'bg-green-500 border-green-500 text-white' : 'border-gray-300'}`}>{isIncluded && 'âœ“'}</div><span className="text-xl">{globalMembers[m] || 'ğŸ‘»'}</span><span className="font-bold">{m}</span>{isIncluded && memberTotal > 0 && formData.splitType === 'custom' && <span className="ml-auto text-purple-600 font-black">{currentCurrency.symbol}{memberTotal.toLocaleString()}</span>}</button>{isIncluded && formData.splitType === 'equal' && perPersonAmount > 0 && (<div className="ml-8 text-sm text-green-600 font-bold">{t.per_person}: {currentCurrency.symbol}{Math.round(perPersonAmount).toLocaleString()}</div>)}{isIncluded && formData.splitType === 'custom' && (<div className="ml-4 space-y-2 bg-purple-50 p-3 rounded-xl">{memberItems.map((item, idx) => (<div key={idx} className="space-y-2"><div className="flex gap-2 items-center"><input type="text" value={item.name || ''} onChange={(e) => updateCustomItem(m, idx, 'name', e.target.value)} placeholder={t.item_name} className="flex-1 min-w-0 px-3 py-2.5 bg-white border border-purple-200 rounded-xl text-sm font-bold text-purple-700 outline-none" /><input type="number" inputMode="decimal" value={item.amount || ''} onChange={(e) => updateCustomItem(m, idx, 'amount', e.target.value)} placeholder="é‡‘é¡" className="w-28 px-3 py-2.5 bg-white border border-purple-200 rounded-xl text-sm font-bold text-purple-700 outline-none text-right" />{memberItems.length > 1 && <button onClick={() => removeCustomItem(m, idx)} className="text-red-400 hover:text-red-600 font-bold text-xl shrink-0">âŠ–</button>}</div></div>))}<button onClick={() => addCustomItem(m)} className="text-purple-600 text-sm font-bold hover:text-purple-800 py-1">+ {t.add}</button></div>)}</div>); })}</div>{formData.splitType === 'custom' && (<div className="mt-4 p-4 bg-purple-100 rounded-xl flex justify-between items-center"><span className="font-bold text-purple-700">{t.total_amount}</span><span className="custom-total-amount font-black text-purple-800 text-2xl">{currentCurrency.symbol}{calculateCustomTotal().toLocaleString()}</span></div>)}</div>
                                {formData.splitType === 'equal' && (<div className="flex gap-3"><div className="flex-1"><label className="text-xs font-bold text-gray-400 ml-1 mb-1 block uppercase">{t.amount}</label><input type="number" inputMode="decimal" value={formData.amount} onChange={(e) => setFormData({ ...formData, amount: e.target.value })} className="w-full px-4 py-4 bg-gray-50 border-none rounded-2xl text-2xl font-black text-gray-800 outline-none" placeholder="0" /></div>{currentBook.currency !== 'TWD' && (<div className="w-28"><label className="text-xs font-bold text-gray-400 ml-1 mb-1 block uppercase">{t.rate_settings}</label><input type="number" inputMode="decimal" step="0.0001" value={formData.exchangeRate} onChange={(e) => setFormData({ ...formData, exchangeRate: e.target.value })} className="w-full px-4 py-4 bg-gray-50 border-none rounded-2xl text-xl font-bold text-gray-800 outline-none" placeholder={activeRate} /></div>)}</div>)}
                                {formData.splitType === 'custom' && currentBook.currency !== 'TWD' && (<div className="w-full"><label className="text-xs font-bold text-gray-400 ml-1 mb-1 block uppercase">{t.rate_settings}</label><input type="number" inputMode="decimal" step="0.0001" value={formData.exchangeRate} onChange={(e) => setFormData({ ...formData, exchangeRate: e.target.value })} className="w-full px-4 py-3 bg-gray-50 border-none rounded-2xl text-lg font-bold text-gray-800 outline-none" placeholder={activeRate} /></div>)}
                                <div className="grid grid-cols-3 gap-3"><div><label className="text-xs font-bold text-gray-400 ml-1 mb-1 block uppercase">{t.date}</label><input type="date" value={formData.date} onChange={(e) => setFormData({ ...formData, date: e.target.value })} className="w-full px-2 py-3 bg-gray-50 border-none rounded-xl text-sm font-bold text-gray-800 outline-none" /></div><div className="col-span-2"><label className="text-xs font-bold text-gray-400 ml-1 mb-1 block uppercase">{t.item}</label><input type="text" value={formData.description} onChange={(e) => setFormData({ ...formData, description: e.target.value })} placeholder="e.g. Dinner" className="w-full px-4 py-3 bg-gray-50 border-none rounded-xl text-base font-bold text-gray-800 outline-none" /></div></div>
                                <button onClick={handleSave} className="w-full bg-black text-white py-4 rounded-2xl font-bold text-lg shadow-xl btn-press mt-4">{editingId ? t.update : t.confirm}</button>
                            </div>
                        )}
                    </div></div>)}

                    {/* History Modal */}
                    {isHistoryOpen && (<div className="fixed inset-0 z-50 bg-gray-100 flex flex-col modal-enter"><div className="bg-white px-6 py-4 shadow-sm flex items-center justify-between sticky top-0 z-10">{viewingSettlement ? (<div className="flex items-center gap-2"><button onClick={() => setViewingSettlement(null)} className="p-2 -ml-2 text-gray-600 hover:bg-gray-100 rounded-full"><Icons.Back /></button><h2 className="text-xl font-black text-gray-800">{t.settle_details}</h2></div>) : (<div className="flex items-center gap-2"><button onClick={() => { setIsHistoryOpen(false); setIsSettingsOpen(true); }} className="p-2 -ml-2 text-gray-600 hover:bg-gray-100 rounded-full"><Icons.Back /></button><h2 className="text-xl font-black text-gray-800">ğŸ“œ {t.history}</h2>{settlements.length > 0 && (<button onClick={() => setIsExportMode(!isExportMode)} className={`ml-2 px-3 py-1 rounded-lg text-sm font-bold flex items-center gap-1 ${isExportMode ? 'bg-blue-500 text-white' : 'bg-gray-100 text-gray-600'}`}><Icons.Download /> {t.export}</button>)}</div>)}</div>
                        {isExportMode && !viewingSettlement && settlements.length > 0 && (<div className="bg-blue-50 px-6 py-3 flex items-center justify-between border-b border-blue-100"><div className="flex items-center gap-3"><button onClick={toggleSelectAll} className="text-sm font-bold text-blue-600 hover:text-blue-800">{selectedSettlements.length === settlements.length ? t.deselect_all : t.select_all}</button><span className="text-sm text-blue-600">({selectedSettlements.length} / {settlements.length})</span></div><div className="flex gap-2"><button onClick={() => exportToExcel(settlements.filter(s => selectedSettlements.includes(s.id)))} disabled={selectedSettlements.length === 0} className={`px-3 py-1.5 rounded-lg text-sm font-bold flex items-center gap-1 ${selectedSettlements.length > 0 ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-400'}`}><Icons.Download /> {t.export_selected}</button><button onClick={() => exportToExcel(settlements)} className="px-3 py-1.5 bg-green-500 text-white rounded-lg text-sm font-bold flex items-center gap-1"><Icons.Download /> {t.export_all}</button></div></div>)}
                        <div className="flex-1 overflow-y-auto p-4 space-y-4">
                            {viewingSettlement ? (
                                <div className="space-y-4">
                                    <div className="bg-white p-6 rounded-3xl shadow-sm text-center">
                                        <p className="text-gray-400 text-xs font-bold uppercase mb-1">{viewingSettlement.settledDate} {t.settled}</p>
                                        {isPersonalBook && viewingSettlement.balance !== undefined ? (
                                            <div>
                                                <p className={`text-3xl font-black mb-2 ${viewingSettlement.balance >= 0 ? 'text-green-600' : 'text-red-600'}`}>{viewingSettlement.balance >= 0 ? '+' : ''}{currentCurrency.symbol}{Math.round(viewingSettlement.balance).toLocaleString()}</p>
                                                <div className="grid grid-cols-2 gap-3 mt-4">
                                                    <div className="bg-red-50 rounded-xl p-3"><div className="text-xs font-bold text-red-500 mb-1">{t.total_expense}</div><div className="text-lg font-black text-red-600">{currentCurrency.symbol}{Math.round(viewingSettlement.totalExpense || 0).toLocaleString()}</div></div>
                                                    <div className="bg-green-50 rounded-xl p-3"><div className="text-xs font-bold text-green-500 mb-1">{t.total_income}</div><div className="text-lg font-black text-green-600">{currentCurrency.symbol}{Math.round(viewingSettlement.totalIncome || 0).toLocaleString()}</div></div>
                                                </div>
                                            </div>
                                        ) : (
                                            <p className="text-3xl font-black text-gray-800 mb-2">{currentCurrency.symbol}{viewingSettlement.totalAmount?.toLocaleString()}</p>
                                        )}
                                        <div className="grid grid-cols-2 gap-3 mt-6"><button onClick={handleRollbackSettlement} className="flex items-center justify-center gap-2 bg-indigo-50 text-indigo-600 py-3 rounded-xl font-bold hover:bg-indigo-100 transition"><Icons.Undo /> {t.undo}</button><button onClick={handleDeleteSettlement} className="flex items-center justify-center gap-2 bg-red-50 text-red-500 py-3 rounded-xl font-bold hover:bg-red-100 transition"><Icons.Trash /> {t.delete}</button></div>
                                    </div>
                                    {!isPersonalBook && renderHistoryDetail(viewingSettlement.transactionsSnapshot)}
                                    {viewingSettlement.transactionsSnapshot && (<div className="mt-6 pb-4"><h4 className="font-bold text-gray-500 text-xs uppercase mb-3">{t.included_tx} ({viewingSettlement.transactionsSnapshot.length})</h4><div className="space-y-2">{viewingSettlement.transactionsSnapshot.map((t_item, idx) => { const avatar = globalMembers[t_item.payer] || 'ğŸ‘»'; const categoryInfo = allCategories.find(c => c.id === t_item.category) || allCategories[allCategories.length - 1]; return (<div key={idx} className="bg-white p-3 rounded-xl border border-gray-200 flex justify-between items-center"><div className="flex items-center gap-3"><div className="w-8 h-8 rounded-lg bg-gray-50 flex items-center justify-center text-lg">{isPersonalBook ? categoryInfo.icon : avatar}</div><div><div className="font-bold text-gray-800 text-sm">{formatDescription(t_item.description)}</div><div className="text-[10px] text-gray-400">{t_item.date} {!isPersonalBook && <>â€¢ {t_item.payer}</>}{t_item.splitType === 'custom' && <span className="ml-1 text-purple-500">(ABåˆ†)</span>}</div></div></div><div className={`font-bold ${t_item.txType === 'income' ? 'text-green-600' : 'text-gray-800'}`}>{t_item.txType === 'income' ? '+' : ''}{currentCurrency.symbol}{t_item.amount.toLocaleString()}</div></div>); })}</div></div>)}
                                </div>
                            ) : (
                                settlements.length === 0 ? (<div className="text-center py-20 text-gray-400">{t.no_payment}</div>) : (settlements.map((s, index) => (
                                    <div key={s.id} className={`bg-white p-5 rounded-2xl shadow-sm border-2 cursor-pointer hover:border-blue-400 transition group relative ${isExportMode && selectedSettlements.includes(s.id) ? 'border-blue-500 bg-blue-50' : 'border-gray-200'}`} onClick={() => isExportMode ? toggleSettlementSelection(s.id) : setViewingSettlement(s)}>
                                        {isExportMode && (<div className={`absolute top-4 left-4 w-6 h-6 rounded-full border-2 flex items-center justify-center ${selectedSettlements.includes(s.id) ? 'bg-blue-500 border-blue-500 text-white' : 'border-gray-300'}`}>{selectedSettlements.includes(s.id) && <Icons.Check />}</div>)}
                                        <div className={`flex justify-between items-start mb-3 ${isExportMode ? 'ml-8' : ''}`}>
                                            <div>
                                                <div className="text-xs font-bold text-gray-400 bg-gray-100 px-2 py-1 rounded inline-block mb-2">#{settlements.length - index} â€¢ {s.settledDate} {s.isAutoSettle && <span className="ml-1 text-purple-500">({t.auto_settle})</span>}</div>
                                                {isPersonalBook && s.balance !== undefined ? (
                                                    <div className={`text-2xl font-black ${s.balance >= 0 ? 'text-green-600' : 'text-red-600'}`}>{s.balance >= 0 ? '+' : ''}{currentCurrency.symbol}{Math.round(s.balance).toLocaleString()}</div>
                                                ) : (
                                                    <div className="text-2xl font-black text-gray-800">{currentCurrency.symbol}{s.totalAmount?.toLocaleString()}</div>
                                                )}
                                                <div className="text-sm font-bold mt-1 text-gray-500">{s.finalResult || (isPersonalBook ? `${t.expense}: ${currentCurrency.symbol}${Math.round(s.totalExpense || 0).toLocaleString()} / ${t.income}: ${currentCurrency.symbol}${Math.round(s.totalIncome || 0).toLocaleString()}` : t.settled)}</div>
                                            </div>
                                        </div>
                                        {!isExportMode && <div className="absolute right-4 bottom-4 text-xs text-blue-400 font-bold opacity-0 group-hover:opacity-100 transition">Detail â†’</div>}
                                    </div>
                                )))
                            )}
                        </div>
                    </div>)}
                </div>
            );
        }
        ReactDOM.render(<CoupleExpenseApp />, document.getElementById('root'));
    </script>
</body>

</html>